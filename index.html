<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRAMMAR QUEST: HYBRID FIXED</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --gold: #eccc68; --rpg-red: #ff4757; --rpg-blue: #2f3542;
            --hp-green: #2ecc71; --hp-red: #e74c3c; --dark-bg: #1a1a1a;
        }
        body {
            background: #000; color: #fff; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0;
        }
        #setup-screen, #game-screen {
            width: 95%; max-width: 800px; background: var(--dark-bg); border: 4px solid var(--gold);
            padding: 30px; border-radius: 15px; box-shadow: 0 0 30px rgba(236, 204, 104, 0.2); text-align: center;
        }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin: 20px 0; }
        .opt { background: #333; color: #fff; padding: 15px; border: 2px solid #555; cursor: pointer; border-radius: 8px; font-weight: bold; }
        .opt.selected { background: var(--rpg-blue); border-color: var(--gold); box-shadow: inset 0 0 10px var(--gold); }
        
        /* ãƒãƒˆãƒ«ã‚¨ãƒªã‚¢ */
        #battle-view { background: #0c1428; border: 2px solid var(--gold); border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        #monster-sprite { font-size: 100px; transition: 0.2s; display: inline-block; margin-bottom: 10px; }
        .shake { animation: shake 0.4s; }
        @keyframes shake { 0%, 100% {transform:translateX(0)} 20%, 60% {transform:translateX(10px)} 40%, 80% {transform:translateX(-10px)} }
        
        .hp-container { width: 80%; background: #333; border: 2px solid var(--gold); height: 25px; margin: 10px auto; border-radius: 20px; overflow: hidden; }
        #hp-fill { height: 100%; width: 100%; background: linear-gradient(to right, var(--hp-red), var(--hp-green)); transition: width 0.6s ease; }
        #player-rank { color: var(--gold); font-weight: bold; margin-top: 5px; display: block; }

        /* ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .card-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; padding: 20px; background: #222; border-radius: 10px; min-height: 80px; margin-bottom: 15px; border: 1px solid #444; }
        .word-card, .word-unit { padding: 12px 18px; background: #eee; color: #000; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1.2rem; box-shadow: 0 4px #999; }
        .word-card.used { opacity: 0.1; pointer-events: none; }
        .answer-card { background: #3498db !important; color: #fff !important; box-shadow: 0 4px #2980b9 !important; }
        .word-unit.selected { background: var(--rpg-red); color: #fff; transform: translateY(3px); box-shadow: none; }

        .btn-main { width: 100%; padding: 20px; background: linear-gradient(#3498db, #2980b9); color: #fff; border: none; border-radius: 10px; font-size: 1.8rem; font-weight: bold; cursor: pointer; box-shadow: 0 6px #1a5276; }
        .btn-main:active { transform: translateY(3px); box-shadow: 0 2px #1a5276; }
        #type-input { background: #000; color: var(--gold); border: 2px solid var(--gold); padding: 15px; width: 80%; text-align: center; font-size: 1.5rem; margin-bottom: 15px; border-radius: 8px; }

        /* ãƒªã‚¶ãƒ«ãƒˆ */
        #exp-layer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="setup-screen">
    <h1 style="color:var(--gold); margin-top:0;">GRAMMAR QUEST: HYBRID</h1>
    <p>æŒ‘æˆ¦ã™ã‚‹æ–‡æ³•ã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</p>
    <div class="grid" id="grammar-grid"></div>
    <div style="margin: 20px 0;">
        å•é¡Œæ•°ï¼š
        <select id="num-select" style="padding:10px; font-size:1.1rem; border-radius:5px;">
            <option value="5">5å•</option>
            <option value="10" selected>10å•</option>
            <option value="20">20å•</option>
            <option value="999">å…¨å•</option>
        </select>
    </div>
    <button class="btn-main" onclick="initGame()">å†’é™ºã‚’é–‹å§‹ã™ã‚‹</button>
</div>

<div id="game-screen" style="display:none;">
    <div id="battle-view">
        <div id="monster-sprite">ğŸ‘¹</div>
        <div class="hp-container"><div id="hp-fill"></div></div>
        <span id="player-rank">Rank: æ–°ç±³å†’é™ºè€…</span>
    </div>
    <h2 id="ja-text" style="color:var(--gold);"></h2>
    
    <div id="sort-ui" style="display:none;">
        <div id="answer-area" class="card-container"></div>
        <div id="card-pool" class="card-container"></div>
    </div>

    <div id="fix-ui" style="display:none;">
        <div id="sentence-area" class="card-container"></div>
        <input type="text" id="type-input" autocomplete="off" placeholder="ä¿®æ­£æ¡ˆã‚’å…¥åŠ›...">
    </div>

    <button class="btn-main" style="background: linear-gradient(#e74c3c, #c0392b);" onclick="submitAttack()">ATTACK!</button>
    <div onclick="resetCurrent()" style="margin-top:10px; cursor:pointer; text-decoration:underline; color:#aaa;">Reset Turn</div>
</div>

<div id="exp-layer">
    <h1 id="exp-res" style="color:var(--gold); font-size:3rem;"></h1>
    <p id="exp-text" style="font-size:1.4rem; padding: 20px;"></p>
    <button class="btn-main" style="width:250px;" onclick="closeExp()">NEXT â–¶</button>
</div>

<script>
const db = {
    indirect: { name: "ã€é–“æ¥ç–‘å•ã€‘", mode: "sort", q: [
        {ja:"å½¼ãŒã©ã“ã«ä½ã‚“ã§ã„ã‚‹ã‹çŸ¥ã£ã¦ã‚‹ï¼Ÿ", a:["Do", "you", "know", "where", "he", "lives", "?"]},
        {ja:"å½¼å¥³ãŒä½•ãŒå¥½ãã‹æ•™ãˆã¦ã€‚", a:["Please", "tell", "me", "what", "she", "likes", "."]},
        {ja:"ã“ã‚ŒãŒä½•ã‹åˆ†ã‹ã‚Šã¾ã™ã‹ï¼Ÿ", a:["Do", "you", "know", "what", "this", "is", "?"]}
    ]},
    passive: { name: "ã€å—ã‘èº«ã€‘", mode: "fix", q: [
        {ja:"ã“ã®æ‰‹ç´™ã¯å½¼ã«æ›¸ã‹ã‚ŒãŸã€‚", s:["This", "letter", "was", "wrote", "by", "him", "."], t:"wrote", a:"written"},
        {ja:"ãã®çª“ã¯å¥ã«å£Šã•ã‚ŒãŸã€‚", s:["The", "window", "was", "break", "by", "Ken", "."], t:"break", a:"broken"},
        {ja:"ãã®æ­Œã¯æœ‰åã ã€‚", s:["The", "song", "is", "know", "by", "everyone", "."], t:"know", a:"known"}
    ]},
    perfect: { name: "ã€å®Œäº†å½¢ã€‘", mode: "fix", q: [
        {ja:"3å¹´é–“ä½ã‚“ã§ã„ã¾ã™ã€‚", s:["I", "have", "live", "here", "for", "3", "years", "."], t:"live", a:"lived"},
        {ja:"ã‚‚ã†å®¿é¡Œã‚’çµ‚ãˆãŸã€‚", s:["I", "have", "already", "finish", "it", "."], t:"finish", a:"finished"},
        {ja:"ä¸€åº¦ã‚‚è¡Œã£ãŸã“ã¨ãŒãªã„ã€‚", s:["I", "have", "never", "be", "to", "Kyoto", "."], t:"be", a:"been"}
    ]}
    // ä»–ã®é …ç›®ã‚‚åŒæ§˜ã®å½¢å¼ã§è¿½åŠ å¯èƒ½
};

let playlist = [], qIdx = 0, currentQ = null, userAns = [], score = 0, monsterHp = 100;
const monsters = ["ğŸ‘¹", "ğŸ‘º", "ğŸ‘»", "ğŸ‰", "ğŸ‘¾"];
const ranks = ["æ–°ç±³å†’é™ºè€…", "è¦‹ç¿’ã„é¨å£«", "ç†Ÿç·´ã®æˆ¦å£«", "é­”å°å¸«", "ä¼èª¬ã®å‹‡è€…"];

const grid = document.getElementById('grammar-grid');
Object.keys(db).forEach(k => {
    const d = document.createElement('div'); d.className = 'opt'; d.innerText = db[k].name;
    d.onclick = () => d.classList.toggle('selected'); d.dataset.key = k; grid.appendChild(d);
});

function initGame() {
    const sel = document.querySelectorAll('.opt.selected');
    if(!sel.length) return alert("æ–‡æ³•ã‚’é¸ã‚“ã§ãã ã•ã„ï¼");
    let all = [];
    sel.forEach(o => { 
        const cat = db[o.dataset.key]; 
        cat.q.forEach(q => { q.mode = cat.mode; all.push(JSON.parse(JSON.stringify(q))); });
    });
    all.sort(() => Math.random() - 0.5);
    playlist = all.slice(0, parseInt(document.getElementById('num-select').value));
    document.getElementById('setup-screen').style.display = 'none';
    document.getElementById('game-screen').style.display = 'block';
    loadQuest();
}

function loadQuest() {
    if(qIdx >= playlist.length) { alert("QUEST CLEAR! ã‚ãªãŸã®å‹åˆ©ã§ã™ï¼"); location.reload(); return; }
    currentQ = playlist[qIdx]; userAns = []; monsterHp = 100; updateHp();
    document.getElementById('monster-sprite').innerText = monsters[qIdx % monsters.length];
    document.getElementById('ja-text').innerText = currentQ.ja;
    document.getElementById('fix-ui').style.display = currentQ.mode === "fix" ? "block" : "none";
    document.getElementById('sort-ui').style.display = currentQ.mode === "sort" ? "block" : "none";
    if(currentQ.mode === "sort") renderSort(); else renderFix();
}

function renderSort() {
    const pool = document.getElementById('card-pool'); pool.innerHTML = "";
    document.getElementById('answer-area').innerHTML = "";
    [...currentQ.a].sort(() => Math.random() - 0.5).forEach(w => {
        const card = document.createElement('div'); card.className = 'word-card'; card.innerText = w;
        card.onclick = () => {
            userAns.push(w); card.classList.add('used');
            const ac = document.createElement('div'); ac.className = 'word-card answer-card'; ac.innerText = w;
            document.getElementById('answer-area').appendChild(ac);
        }; pool.appendChild(card);
    });
}

function renderFix() {
    const area = document.getElementById('sentence-area'); area.innerHTML = "";
    currentQ.s.forEach(w => {
        const d = document.createElement('div'); d.className = 'word-unit'; d.innerText = w;
        d.onclick = () => {
            document.querySelectorAll('.word-unit').forEach(u => u.classList.remove('selected'));
            d.classList.add('selected'); document.getElementById('type-input').focus();
        }; area.appendChild(d);
    });
    document.getElementById('type-input').value = "";
}

function submitAttack() {
    let ok = false;
    // åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã‚’å¼·åŒ–ï¼šå¤§æ–‡å­—å°æ–‡å­—ç„¡è¦–ã€æ–‡æœ«è¨˜å·ã‚’åˆ†é›¢ã—ã¦æ¯”è¼ƒ
    const clean = (arr) => arr.map(w => w.replace(/[.?]/g, "").toLowerCase()).filter(w => w !== "");

    if(currentQ.mode === "sort") {
        const userStr = clean(userAns).join(" ");
        const collectStr = clean(currentQ.a).join(" ");
        ok = (userStr === collectStr);
    } else {
        const sel = document.querySelector('.word-unit.selected');
        const val = document.getElementById('type-input').value.trim().toLowerCase();
        if(sel && sel.innerText.replace(/[.?]/g, "").toLowerCase() === currentQ.t.toLowerCase()) {
            ok = (val === currentQ.a.toLowerCase());
        }
    }

    if(ok) {
        monsterHp = 0; updateHp();
        document.getElementById('monster-sprite').classList.add('shake');
        confetti({particleCount: 150, origin: {y:0.6}});
        setTimeout(() => {
            document.getElementById('monster-sprite').classList.remove('shake');
            score++;
            updateRank();
            showExp("âœ¨ GREAT HIT!", "æ­£è§£ã§ã™ï¼ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’æ’ƒç ´ã—ã¾ã—ãŸã€‚");
        }, 600);
    } else {
        alert("MISS! æ•µã®é˜²å¾¡ã«é˜»ã¾ã‚ŒãŸï¼\n(èªé †ã‚„ä¿®æ­£å˜èªã‚’ç¢ºèªã—ã¦ã­)");
    }
}

function updateHp() { document.getElementById('hp-fill').style.width = monsterHp + "%"; }

function updateRank() {
    const rIdx = Math.min(Math.floor(score / 2), ranks.length - 1);
    document.getElementById('player-rank').innerText = "Rank: " + ranks[rIdx];
}

function showExp(res, text) {
    document.getElementById('exp-res').innerText = res;
    document.getElementById('exp-text').innerText = text;
    document.getElementById('exp-layer').style.display = 'flex';
}

function closeExp() {
    document.getElementById('exp-layer').style.display = 'none';
    qIdx++; loadQuest();
}

function resetCurrent() {
    if(currentQ.mode === "sort") renderSort(); else renderFix();
}
</script>
</body>
</html>
