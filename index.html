<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRAMMAR QUEST: ULTIMATE VOLUME</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --gold: #eccc68; --rpg-red: #ff4757; --rpg-blue: #2f3542;
            --hp-green: #2ecc71; --hp-red: #e74c3c; --wood: #5d4037;
        }
        body {
            background: #000 url('https://www.transparenttextures.com/patterns/dark-matter.png');
            color: #fff; font-family: 'Courier New', monospace; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0;
        }
        #setup-screen, #game-screen {
            width: 95%; max-width: 900px; background: #f4e4bc; border: 12px solid #8b4513;
            padding: 30px; border-radius: 10px; box-shadow: 0 0 50px #000; text-align: center; color: #3d2b1f; box-sizing: border-box;
        }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin: 20px 0; }
        .opt { background: var(--wood); color: var(--gold); padding: 12px 5px; border: 3px solid #3d2b1f; cursor: pointer; border-radius: 5px; font-weight: bold; font-size: 0.8rem; transition: 0.1s; }
        .opt.selected { background: var(--rpg-blue); color: #fff; border-color: var(--gold); }
        
        .quest-settings { background: rgba(0,0,0,0.05); padding: 15px; border-radius: 10px; margin: 20px 0; border: 2px dashed #8b4513; }
        #num-select { padding: 10px; font-size: 1.2rem; border-radius: 5px; border: 2px solid var(--wood); background: #fff; }

        #battle-view { background: #16213e; border: 4px solid var(--gold); border-radius: 10px; padding: 20px; margin-bottom: 20px; color: #fff; }
        #monster-sprite { font-size: 90px; transition: 0.2s; display: inline-block; filter: drop-shadow(0 0 10px red); }
        .shake { animation: shake 0.4s; }
        @keyframes shake { 0%, 100% {transform:translateX(0)} 20%, 60% {transform:translateX(15px)} 40%, 80% {transform:translateX(-15px)} }

        .hp-container { width: 70%; background: #444; border: 2px solid var(--gold); height: 20px; margin: 10px auto; border-radius: 10px; overflow: hidden; }
        #hp-fill { height: 100%; width: 100%; background: linear-gradient(to right, var(--hp-red), var(--hp-green)); transition: width 0.5s ease; }

        .card-container { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; padding: 15px; background: #333; border: 2px solid #555; border-radius: 10px; min-height: 60px; margin-bottom: 15px; }
        .word-card, .word-unit { padding: 10px 15px; background: #fff; color: #000; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1.1rem; box-shadow: 0 4px #999; }
        .word-card.used { opacity: 0.2; }
        .answer-word { background: #3498db !important; color: #fff !important; }
        .word-unit.selected { background: var(--rpg-red); color: #fff; box-shadow: none; transform: translateY(3px); }

        #type-input { background: #000; color: var(--gold); border: 2px solid var(--gold); padding: 12px; width: 80%; text-align: center; font-size: 1.3rem; margin-bottom: 10px; border-radius: 5px; }
        .btn-main { width: 100%; padding: 15px; background: linear-gradient(#3498db, #2980b9); color: #fff; border: 4px solid #fff; border-radius: 10px; font-size: 1.5rem; font-weight: bold; cursor: pointer; box-shadow: 0 5px #1a5276; }
        #exp-layer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
    </style>
</head>
<body>

<div id="setup-screen">
    <h1 style="margin:0;">GRAMMAR QUEST</h1>
    <p>ç¿’å¾—ã—ãŸã„é­”æ³•ï¼ˆæ–‡æ³•ï¼‰ã‚’é¸ã¹</p>
    <div class="grid" id="grammar-grid"></div>
    
    <div class="quest-settings">
        æŒ‘æˆ¦ã™ã‚‹å•é¡Œæ•°ï¼š
        <select id="num-select">
            <option value="5">5å•ï¼ˆã¡ã‚‡ã£ã¨å†’é™ºï¼‰</option>
            <option value="10">10å•ï¼ˆã—ã£ã‹ã‚Šä¿®è¡Œï¼‰</option>
            <option value="20">20å•ï¼ˆæ¿€æˆ¦ã®æ—…è·¯ï¼‰</option>
            <option value="999">å…¨å•ï¼ˆä¼èª¬ã¸ã®æŒ‘æˆ¦ï¼‰</option>
        </select>
    </div>
    
    <button class="btn-main" onclick="initGame()">QUEST START!</button>
</div>

<div id="game-screen" style="display:none;">
    <div id="battle-view">
        <div id="monster-sprite">ğŸ‰</div>
        <div class="hp-container"><div id="hp-fill"></div></div>
        <div style="font-weight:bold;">Progress: <span id="current-count">1</span> / <span id="total-count">?</span></div>
    </div>
    <div id="ja-text" style="font-size:1.4rem; font-weight:bold; color:var(--wood); margin-bottom:15px;"></div>
    <div id="sort-ui" style="display:none;"><div id="answer-area" class="card-container"></div><div id="card-pool" class="card-container"></div></div>
    <div id="fix-ui" style="display:none;"><div id="sentence-area" class="card-container"></div><input type="text" id="type-input" autocomplete="off" placeholder="é­”æ³•ã‚’ä¿®æ­£..."></div>
    <button class="btn-main" style="background: linear-gradient(#e74c3c, #c0392b);" onclick="submitAttack()">ATTACK!</button>
</div>

<div id="exp-layer">
    <h1 id="exp-res" style="font-size:3rem; color:var(--gold);"></h1>
    <p id="exp-text" style="font-size:1.3rem; padding: 20px; color:#fff;"></p>
    <button class="btn-main" style="width:250px;" onclick="closeExp()">NEXT â–¶</button>
</div>

<script>
// å…¨18é …ç›® Ã— 3å• ï¼ è¨ˆ54å•ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
const db = {
    passive: { name: "å—ã‘èº«", mode: "fix", q: [
        {ja:"ã“ã®æ‰‹ç´™ã¯å½¼ã«æ›¸ã‹ã‚ŒãŸã€‚", s:["This", "letter", "was", "wrote", "by", "him", "."], t:"wrote", a:"written", e:"beå‹•è©ï¼‹éå»åˆ†è©ã€‚write-wrote-writtenï¼"},
        {ja:"ãã®çª“ã¯å¥ã«ã‚ˆã£ã¦å£Šã•ã‚ŒãŸã€‚", s:["The", "window", "is", "break", "by", "Ken", "."], t:"break", a:"broken", e:"å—å‹•æ…‹ã®éå»åˆ†è©å½¢ã«æ³¨æ„ã€‚"},
        {ja:"ã“ã®æœ¬ã¯å¤šãã®äººã«èª­ã¾ã‚Œã¦ã„ã‚‹ã€‚", s:["This", "book", "is", "readed", "by", "many", "people", "."], t:"readed", a:"read", e:"readã®éå»åˆ†è©ã¯ã‚¹ãƒšãƒ«ãŒåŒã˜ã§ç™ºéŸ³ã¯ã€Œãƒ¬ãƒƒãƒ‰ã€ã€‚"}
    ]},
    perfect: { name: "å®Œäº†å½¢", mode: "fix", q: [
        {ja:"3å¹´é–“ãšã£ã¨ã“ã“ã«ä½ã‚“ã§ã„ã¾ã™ã€‚", s:["I", "have", "live", "here", "for", "3", "years", "."], t:"live", a:"lived", e:"have + éå»åˆ†è©ã§ã€ãšã£ã¨ï½ã—ã¦ã„ã‚‹ã€ã€‚"},
        {ja:"ã‚‚ã†å®¿é¡Œã‚’çµ‚ãˆã¾ã—ãŸã€‚", s:["I", "have", "already", "finish", "my", "homework", "."], t:"finish", a:"finished", e:"å®Œäº†ã®çµæœã‚’è¡¨ã™have + éå»åˆ†è©ã€‚"},
        {ja:"ä¸€åº¦ã‚‚äº¬éƒ½ã«è¡Œã£ãŸã“ã¨ãŒãªã„ã€‚", s:["I", "have", "never", "be", "to", "Kyoto", "."], t:"be", a:"been", e:"çµŒé¨“ã‚’è¡¨ã™ have been to ã€œã€‚"}
    ]},
    rel: { name: "é–¢ä¿‚ä»£åè©", mode: "sort", q: [
        {ja:"ã“ã‚Œã¯ç§ãŒæ˜¨æ—¥è²·ã£ãŸæœ¬ã§ã™ã€‚", a:["This", "is", "the", "book", "which", "I", "bought", "yesterday", "."], e:"å…ˆè¡Œè©ãŒç‰©ãªã®ã§whichã‚’ä½¿ã„ã¾ã™ã€‚"},
        {ja:"å‘ã“ã†ã«ã„ã‚‹ç”·ã®äººã¯ç§ã®çˆ¶ã§ã™ã€‚", a:["The", "man", "who", "is", "over", "there", "is", "my", "father", "."], e:"äººã‚’ä¿®é£¾ã™ã‚‹å ´åˆã¯whoã‚’ä½¿ã„ã¾ã™ã€‚"},
        {ja:"ç§ã¯è‹±èªã‚’è©±ã™å‹é”ãŒã»ã—ã„ã€‚", a:["I", "want", "a", "friend", "who", "speaks", "English", "."], e:"ä¸»æ ¼ã®é–¢ä¿‚ä»£åè©ã€‚friendã®å¾Œã‚ã«whoã‚’ç½®ãã¾ã™ã€‚"}
    ]},
    indirect: { name: "é–“æ¥ç–‘å•æ–‡", mode: "sort", q: [
        {ja:"å½¼ãŒã©ã“ã«ä½ã‚“ã§ã„ã‚‹ã‹çŸ¥ã£ã¦ã‚‹ï¼Ÿ", a:["Do", "you", "know", "where", "he", "lives", "?"], e:"èªé †ã¯ç–‘å•è©ï¼‹ä¸»èªï¼‹å‹•è©ã§ã™ã€‚"},
        {ja:"ä½•æ™‚ã‹æ•™ãˆã¦ãã‚Œã¾ã™ã‹ï¼Ÿ", a:["Can", "you", "tell", "me", "what", "time", "it", "is", "?"], e:"ã€what time is itã€ã‚’ãã®ã¾ã¾å…¥ã‚Œãªã„ã‚ˆã†ã«ï¼"},
        {ja:"å½¼å¥³ãŒèª°ã ã‹åˆ†ã‹ã‚‰ãªã„ã€‚", a:["I", "don't", "know", "who", "she", "is", "."], e:"æ–‡ã®é€”ä¸­ã§ã¯è‚¯å®šæ–‡ã®èªé †ã«æˆ»ã‚Šã¾ã™ã€‚"}
    ]},
    post: { name: "å¾Œç½®ä¿®é£¾", mode: "fix", q: [
        {ja:"å‘ã“ã†ã§æ­Œã£ã¦ã„ã‚‹å°‘å¥³ã¯èŠ±å­ã§ã™ã€‚", s:["The", "girl", "sing", "over", "there", "is", "Hanako", "."], t:"sing", a:"singing", e:"ï½ã—ã¦ã„ã‚‹å°‘å¥³ã€ã¯ç¾åœ¨åˆ†è©ingã€‚"},
        {ja:"ã‚«ãƒŠãƒ€ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹è¨€èªã¯è‹±èªã§ã™ã€‚", s:["The", "language", "use", "in", "Canada", "is", "English", "."], t:"use", a:"used", e:"ä½¿ã‚ã‚Œã¦ã„ã‚‹ï¼ˆå—ã‘èº«ï¼‰ãªã‚‰éå»åˆ†è©ã€‚"},
        {ja:"ã‚ãã“ã§èµ°ã£ã¦ã„ã‚‹çŠ¬ã‚’è¦‹ã¦ã€‚", s:["Look", "at", "the", "dog", "run", "over", "there", "."], t:"run", a:"running", e:"åè©ã®å¾Œã‚ã‹ã‚‰ingã§èª¬æ˜ã€‚"}
    ]},
    itfor: { name: "å½¢å¼ä¸»èªIt", mode: "sort", q: [
        {ja:"è‹±èªã‚’è©±ã™ã®ã¯é›£ã—ã„ã€‚", a:["It", "is", "difficult", "to", "speak", "English", "."], e:"It is ã€œ to ... ã®åŸºæœ¬å½¢ã€‚"},
        {ja:"ç§ã«ã¨ã£ã¦æ—©èµ·ãã¯ç°¡å˜ã§ã™ã€‚", a:["It", "is", "easy", "for", "me", "to", "get", "up", "early", "."], e:"for äººã‚’å…¥ã‚Œã‚‹ä½ç½®ã«æ³¨æ„ã€‚"},
        {ja:"å½¼å¥³ã«ã¨ã£ã¦æ³³ãã®ã¯æ¥½ã—ã„ã€‚", a:["It", "is", "fun", "for", "her", "to", "swim", "."], e:"It is ... for äºº to ã€œ ã®é †ã€‚"}
    ]},
    prog: { name: "é€²è¡Œå½¢", mode: "fix", q: [
        {ja:"å½¼ã¯ä»Šèµ°ã£ã¦ã„ã‚‹ã€‚", s:["He", "running", "now", "."], t:"running", a:"is running", e:"beå‹•è©ã‚’å¿˜ã‚Œãšã«ï¼"},
        {ja:"ç§ãŸã¡ã¯ãƒ†ãƒ‹ã‚¹ã‚’ã—ã¦ã„ãŸã€‚", s:["We", "playing", "tennis", "then", "."], t:"playing", a:"were playing", e:"éå»é€²è¡Œå½¢ã‚‚beå‹•è©ãŒå¿…è¦ã§ã™ã€‚"},
        {ja:"å½¼å¥³ã¯æ–™ç†ã‚’ã—ã¦ã„ã¾ã™ã€‚", s:["She", "cooking", "dinner", "."], t:"cooking", a:"is cooking", e:"ä¸»èªã«åˆã‚ã›ãŸbeå‹•è©ã‚’ã€‚"}
    ]},
    ing_only: { name: "å‹•åè©(ing)", mode: "fix", q: [
        {ja:"ãƒ†ãƒ¬ãƒ“ã‚’è¦‹ã‚‹ã®ã‚’ã‚„ã‚ãŸã€‚", s:["He", "stopped", "to", "watch", "TV", "."], t:"to", a:"(å‰Šé™¤)", e:"stop ã€œingã§ã€Œã‚„ã‚ã‚‹ã€ã€‚"},
        {ja:"ãƒ†ãƒ‹ã‚¹ã‚’æ¥½ã—ã¿ã¾ã—ãŸã€‚", s:["I", "enjoyed", "to", "play", "tennis", "."], t:"to", a:"(å‰Šé™¤)", e:"enjoyã®å¾Œã¯ingå½¢ã®ã¿ã€‚"},
        {ja:"ã„ã¤ã‹æ—¥æœ¬ã‚’è¨ªã‚Œã‚‹ã®ã‚’çµ‚ãˆãŸã€‚", s:["She", "finished", "to", "read", "the", "book", "."], t:"to", a:"(å‰Šé™¤)", e:"finishã‚‚ingã®ã¿ã‚’å–ã‚Šã¾ã™ã€‚"}
    ]},
    to_only: { name: "ä¸å®šè©(to)", mode: "fix", q: [
        {ja:"åŒ»è€…ã«ãªã‚ŠãŸã„ã€‚", s:["I", "want", "becoming", "a", "doctor", "."], t:"becoming", a:"to be", e:"wantã®å¾Œã¯toä¸å®šè©ã€‚"},
        {ja:"å½¼ã¯æ³³ãã“ã¨ãŒå¥½ãã§ã™ã€‚", s:["He", "likes", "swim", "."], t:"swim", a:"to swim", e:"å‹•è©ã‚’ä¸¦ã¹ã‚‹ã«ã¯toãŒå¿…è¦ã€‚"},
        {ja:"ç§ã¯ãƒ†ãƒ‹ã‚¹ã‚’ã™ã‚‹ã®ã‚’æ±ºã‚ãŸã€‚", s:["I", "decided", "playing", "tennis", "."], t:"playing", a:"to play", e:"decideã¯toä¸å®šè©ã€‚"}
    ]},
    comp: { name: "æ¯”è¼ƒ", mode: "fix", q: [
        {ja:"å½¼ã‚ˆã‚ŠèƒŒãŒé«˜ã„ã€‚", s:["He", "is", "taller", "as", "me", "."], t:"as", a:"than", e:"æ¯”è¼ƒç´šã®å¾Œã¯thanã€‚"},
        {ja:"ã“ã®æœ¬ã¯ã‚ã‚Œã‚ˆã‚Šé¢ç™½ã„ã€‚", s:["This", "book", "is", "interesting", "than", "that", "one", "."], t:"interesting", a:"more interesting", e:"é•·ã„å˜èªã¯moreã‚’ã¤ã‘ã¾ã™ã€‚"},
        {ja:"å½¼ã¯ã‚¯ãƒ©ã‚¹ã§ä¸€ç•ªèƒŒãŒé«˜ã„ã€‚", s:["He", "is", "tallest", "in", "the", "class", "."], t:"tallest", a:"the tallest", e:"æœ€ä¸Šç´šã«ã¯theãŒå¿…è¦ã§ã™ã€‚"}
    ]},
    modal: { name: "åŠ©å‹•è©", mode: "fix", q: [
        {ja:"è‹±èªã‚’è©±ã›ã‚‹ã€‚", s:["He", "can", "speaks", "English", "."], t:"speaks", a:"speak", e:"åŠ©å‹•è©ã®å¾Œã¯å¿…ãšåŸå½¢ã€‚"},
        {ja:"ã“ã“ã«æ¥ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚", s:["You", "must", "to", "come", "here", "."], t:"to", a:"(å‰Šé™¤)", e:"mustã®ç›´å¾Œã«toã¯ä¸è¦ã€‚"},
        {ja:"å½¼ã¯æ³³ã’ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚", s:["He", "may", "swims", "well", "."], t:"swims", a:"swim", e:"mayã‚‚åŠ©å‹•è©ãªã®ã§åŸå½¢ã€‚"}
    ]},
    sub: { name: "ä»®å®šæ³•", mode: "fix", q: [
        {ja:"ã‚‚ã—é³¥ãªã‚‰é£›ã¹ã‚‹ã®ã«ã€‚", s:["If", "I", "am", "a", "bird", ",", "I", "could", "fly", "."], t:"am", a:"were", e:"Ifç¯€ã®beå‹•è©ã¯wereã€‚"},
        {ja:"ã‚‚ã—æ™‚é–“ãŒã‚ã‚Œã°è¡Œãã®ã«ã€‚", s:["If", "I", "have", "time", ",", "I", "would", "go", "."], t:"have", a:"had", e:"ç¾å®Ÿã¨é•ã†æƒ³å®šã¯éå»å½¢ã«ã—ã¾ã™ã€‚"},
        {ja:"ãŠé‡‘ãŒã‚ã‚Œã°è²·ãˆã‚‹ã®ã«ã€‚", s:["If", "I", "had", "money", ",", "I", "can", "buy", "it", "."], t:"can", a:"could", e:"åŠ©å‹•è©ã‚‚éå»å½¢ã«ã™ã‚‹ã®ãŒãƒ«ãƒ¼ãƒ«ã€‚"}
    ]},
    svoc: { name: "ä½¿å½¹make", mode: "fix", q: [
        {ja:"æƒé™¤ã•ã›ãŸã€‚", s:["Made", "me", "to", "clean", "the", "room", "."], t:"to", a:"(å‰Šé™¤)", e:"make A åŸå½¢ã§ã€ŒAã«ï½ã•ã›ã‚‹ã€ã€‚"},
        {ja:"å½¼ã‚’å¹¸ã›ã«ã—ãŸã€‚", s:["I", "made", "him", "happily", "."], t:"happily", a:"happy", e:"make A B(å½¢å®¹è©)ã§ã€ŒAã‚’Bã®çŠ¶æ…‹ã«ã™ã‚‹ã€ã€‚"},
        {ja:"çˆ¶ã¯ç§ã‚’ãã“ã«è¡Œã‹ã›ãŸã€‚", s:["Father", "made", "me", "to", "go", "there", "."], t:"to", a:"(å‰Šé™¤)", e:"ä½¿å½¹ã®makeã«toã¯ã¤ã‘ã¾ã›ã‚“ã€‚"}
    ]},
    too_to: { name: "too..to", mode: "fix", q: [
        {ja:"è‹¥ã™ãã¦åƒã‘ãªã„ã€‚", s:["Too", "young", "working", "."], t:"working", a:"to work", e:"too ã€œ to åŸå½¢ ã§ã™ã€‚"},
        {ja:"æš‘ã™ãã¦çœ ã‚Œãªã„ã€‚", s:["It", "is", "too", "hot", "sleeping", "."], t:"sleeping", a:"to sleep", e:"toã®å¾Œã¯å‹•è©ã®åŸå½¢ã€‚"},
        {ja:"é›£ã—ã™ãã¦è§£ã‘ãªã„ã€‚", s:["Too", "difficult", "solving", "."], t:"solving", a:"to solve", e:"ã‚ã¾ã‚Šã«ï½ã§...ã§ããªã„ã€ã®æ§‹æ–‡ã€‚"}
    ]},
    tag: { name: "ä»˜åŠ ç–‘å•", mode: "fix", q: [
        {ja:"è¦ªåˆ‡ã§ã™ã‚ˆã­ï¼Ÿ", s:["He", "is", "kind", ",", "isn't", "is", "?"], t:"is", a:"he", e:"ä»˜åŠ ç–‘å•ã¯ä»£åè©ã§ã€‚"},
        {ja:"ãƒ†ãƒ‹ã‚¹ã‚’ã—ã¾ã™ã‚ˆã­ï¼Ÿ", s:["You", "play", "tennis", ",", "don't", "you", "are", "?"], t:"are", a:"(å‰Šé™¤)", e:"ä¸€èˆ¬å‹•è©ãªã‚‰don't/doesn'tã§ã€‚"},
        {ja:"å¿™ã—ããªã„ã§ã™ã‚ˆã­ï¼Ÿ", s:["You", "aren't", "busy", ",", "are", "you", "not", "?"], t:"not", a:"(å‰Šé™¤)", e:"å¦å®šæ–‡ã®å¾Œã¯è‚¯å®šã§è¿”ã—ã¾ã™ã€‚"}
    ]},
    exclam: { name: "æ„Ÿå˜†æ–‡", mode: "sort", q: [
        {ja:"ãªã‚“ã¦ç¾ã—ã„èŠ±ã ï¼", a:["What", "a", "beautiful", "flower", "this", "is", "!"], e:"What a ã€œ S V !"},
        {ja:"ãªã‚“ã¦é€Ÿãèµ°ã‚‹ã‚“ã ï¼", a:["How", "fast", "he", "runs", "!"], e:"å‰¯è©ã‚„å½¢å®¹è©ã‚’å¼·èª¿ã™ã‚‹ã¨ãã¯Howã€‚"},
        {ja:"ãªã‚“ã¦è¦ªåˆ‡ãªç”·ã®å­ãªã‚“ã ï¼", a:["What", "a", "kind", "boy", "he", "is", "!"], e:"Whatï¼‹åè©ã®å½¢ã«æ³¨ç›®ã€‚"}
    ]},
    give: { name: "æˆä¸å‹•è©", mode: "sort", q: [
        {ja:"æœ¬ã‚’ãã‚ŒãŸã€‚", a:["He", "gave", "the", "book", "to", "me", "."], e:"gave ç‰© to äººã€‚"},
        {ja:"æ‰‹ç´™ã‚’æ›¸ã„ãŸã€‚", a:["I", "wrote", "a", "letter", "to", "him", "."], e:"write ç‰© to äººã€‚"},
        {ja:"å†™çœŸã‚’è¦‹ã›ã¦ã€‚", a:["Show", "the", "picture", "to", "me", "."], e:"show ç‰© to äººã€‚"}
    ]},
    inf_d: { name: "ä¸å®šè©/å‹•åè©", mode: "fix", q: [
        {ja:"æ³³ãã®ã¯æ¥½ã—ã„ã€‚", s:["Swim", "is", "fun", "."], t:"Swim", a:"Swimming", e:"æ–‡ã®ä¸»èªã¯ingã‹toã‚’ä½¿ã„ã¾ã™ã€‚"},
        {ja:"è‹±èªã‚’å­¦ã¶ã“ã¨ã¯å¤§åˆ‡ã ã€‚", s:["Learn", "English", "is", "important", "."], t:"Learn", a:"Learning", e:"å‹•è©ã‚’ãã®ã¾ã¾ä¸»èªã«ã¯ã§ãã¾ã›ã‚“ã€‚"},
        {ja:"ãƒ†ãƒ‹ã‚¹ã‚’ã™ã‚‹ã“ã¨ã¯é¢ç™½ã„ã€‚", s:["Play", "tennis", "is", "fun", "."], t:"Play", a:"To play", e:"Toä¸å®šè©ã§ã‚‚ä¸»èªã«ãªã‚Œã¾ã™ã€‚"}
    ]}
};

let playlist = [], qIdx = 0, currentQ = null, userAns = [], monsterHp = 100;
const monsters = ["ğŸ‘¹", "ğŸ‘º", "ğŸ‰", "ğŸ’€", "ğŸ‘¾", "ğŸº", "ğŸ§›"];

const grid = document.getElementById('grammar-grid');
Object.keys(db).forEach(k => {
    const d = document.createElement('div'); d.className = 'opt'; d.innerText = db[k].name;
    d.onclick = () => d.classList.toggle('selected'); d.dataset.key = k; grid.appendChild(d);
});

function initGame() {
    const sel = document.querySelectorAll('.opt.selected');
    if(!sel.length) return alert("é­”æ³•ã‚’é¸ã‚“ã§ãã ã•ã„ï¼");
    
    // å…¨ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€é¸ã°ã‚ŒãŸé …ç›®ã®å„3å•ã‚’æŠ½å‡º
    let allSelected = [];
    sel.forEach(o => { 
        const cat = db[o.dataset.key]; 
        cat.q.forEach(q => { q.mode = cat.mode; allSelected.push(JSON.parse(JSON.stringify(q))); });
    });
    
    // é¸æŠã•ã‚ŒãŸæ•°ã«å¿œã˜ã¦ã‚·ãƒ£ãƒƒãƒ•ãƒ«
    allSelected.sort(() => Math.random() - 0.5);
    const limit = parseInt(document.getElementById('num-select').value);
    playlist = allSelected.slice(0, limit);
    
    document.getElementById('total-count').innerText = playlist.length;
    document.getElementById('setup-screen').style.display = 'none';
    document.getElementById('game-screen').style.display = 'block';
    loadQuest();
}

function loadQuest() {
    if(qIdx >= playlist.length) { alert("QUEST COMPLETE! ã‚ãªãŸã¯çœŸã®ãƒã‚¹ã‚¿ãƒ¼ã§ã™ï¼"); location.reload(); return; }
    currentQ = playlist[qIdx]; userAns = []; monsterHp = 100; updateHp();
    document.getElementById('current-count').innerText = qIdx + 1;
    document.getElementById('monster-sprite').innerText = monsters[qIdx % monsters.length];
    document.getElementById('ja-text').innerText = currentQ.ja;
    document.getElementById('fix-ui').style.display = currentQ.mode === "fix" ? "block" : "none";
    document.getElementById('sort-ui').style.display = currentQ.mode === "sort" ? "block" : "none";
    if(currentQ.mode === "sort") renderSort(); else renderFix();
}

function renderSort() {
    const pool = document.getElementById('card-pool'); pool.innerHTML = "";
    document.getElementById('answer-area').innerHTML = "";
    [...currentQ.a].sort(() => Math.random() - 0.5).forEach(w => {
        const card = document.createElement('div'); card.className = 'word-card'; card.innerText = w;
        card.onclick = () => {
            userAns.push(w); card.classList.add('used');
            const ac = document.createElement('div'); ac.className = 'word-card answer-word'; ac.innerText = w;
            document.getElementById('answer-area').appendChild(ac);
        }; pool.appendChild(card);
    });
}

function renderFix() {
    const area = document.getElementById('sentence-area'); area.innerHTML = "";
    currentQ.s.forEach(w => {
        const d = document.createElement('div'); d.className = 'word-unit'; d.innerText = w;
        d.onclick = () => {
            document.querySelectorAll('.word-unit').forEach(u => u.classList.remove('selected'));
            d.classList.add('selected'); document.getElementById('type-input').focus();
        }; area.appendChild(d);
    });
    document.getElementById('type-input').value = "";
}

function submitAttack() {
    let ok = false;
    if(currentQ.mode === "sort") {
        ok = JSON.stringify(userAns) === JSON.stringify(currentQ.a);
    } else {
        const sel = document.querySelector('.word-unit.selected');
        const val = document.getElementById('type-input').value.trim().toLowerCase();
        if(sel && sel.innerText === currentQ.t) {
            ok = (val === currentQ.a.toLowerCase() || (currentQ.a === "(å‰Šé™¤)" && val === ""));
        }
    }

    if(ok) {
        monsterHp = 0; updateHp();
        document.getElementById('monster-sprite').classList.add('shake');
        confetti({particleCount: 150, origin: {y:0.6}});
        setTimeout(() => {
            document.getElementById('monster-sprite').classList.remove('shake');
            showExp("âœ¨ SUCCESS!", currentQ.e);
        }, 600);
    } else {
        alert("ãƒŸã‚¹ï¼ã‚‚ã†ä¸€åº¦é­”æ³•ã‚’ç·´ã‚Šç›´ã›ï¼");
        if(currentQ.mode === "sort") renderSort(); else renderFix();
    }
}

function updateHp() { document.getElementById('hp-fill').style.width = monsterHp + "%"; }
function showExp(res, text) {
    document.getElementById('exp-res').innerText = res;
    document.getElementById('exp-text').innerHTML = text;
    document.getElementById('exp-layer').style.display = 'flex';
}
function closeExp() {
    document.getElementById('exp-layer').style.display = 'none';
    qIdx++; loadQuest();
}
</script>
</body>
</html>
