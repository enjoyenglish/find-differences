<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRAMMAR QUEST: TRUE ULTIMATE</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --gold: #eccc68; --rpg-red: #ff4757; --rpg-blue: #2f3542;
            --hp-green: #2ecc71; --hp-red: #e74c3c; --wood: #5d4037;
        }
        body {
            background: #000 url('https://www.transparenttextures.com/patterns/dark-matter.png');
            color: #fff; font-family: 'Courier New', monospace; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0;
        }

        /* ç¾Šçš®ç´™é¢¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ */
        #setup-screen {
            width: 95%; max-width: 900px; background: #f4e4bc; border: 12px solid #8b4513;
            padding: 30px; border-radius: 10px; box-shadow: 0 0 50px #000; text-align: center; color: #3d2b1f;
        }

        /* æ–‡æ³•ã‚°ãƒªãƒƒãƒ‰ï¼ˆå…¨18é …ç›®ã‚’æœ€åˆã‹ã‚‰è¡¨ç¤ºï¼‰ */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin: 25px 0; }
        .opt { background: var(--wood); color: var(--gold); padding: 15px 5px; border: 3px solid #3d2b1f; cursor: pointer; border-radius: 5px; font-weight: bold; font-size: 0.85rem; box-shadow: 0 4px #2a1b0a; transition: 0.1s; }
        .opt.selected { background: var(--rpg-blue); color: #fff; border-color: var(--gold); transform: translateY(2px); box-shadow: none; }

        /* ãƒãƒˆãƒ«ç”»é¢ */
        #game-screen {
            display: none; width: 95%; max-width: 800px; background: #2a1b0a; border: 5px solid var(--gold);
            padding: 20px; border-radius: 15px; box-shadow: 0 0 30px rgba(0,0,0,1); text-align: center;
        }

        #battle-view { background: #16213e; border: 4px solid var(--gold); border-radius: 10px; padding: 20px; margin-bottom: 20px; position: relative; }
        #monster-sprite { font-size: 100px; transition: 0.2s; display: inline-block; filter: drop-shadow(0 0 10px red); }
        .shake { animation: shake 0.4s; }
        @keyframes shake { 0%, 100% {transform:translateX(0)} 20%, 60% {transform:translateX(15px)} 40%, 80% {transform:translateX(-15px)} }

        /* HPãƒãƒ¼ */
        .hp-container { width: 70%; background: #444; border: 2px solid var(--gold); height: 25px; margin: 15px auto; border-radius: 15px; overflow: hidden; }
        #hp-fill { height: 100%; width: 100%; background: linear-gradient(to right, var(--hp-red), var(--hp-green)); transition: width 0.6s ease; }

        /* ã‚«ãƒ¼ãƒ‰UIï¼ˆç”»åƒã®ã‚ˆã†ãªãƒ‡ã‚¶ã‚¤ãƒ³ï¼‰ */
        .card-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; padding: 20px; background: #333; border: 2px solid #555; border-radius: 10px; min-height: 80px; margin-bottom: 15px; box-shadow: inset 0 0 10px #000; }
        .word-card, .word-unit { padding: 12px 20px; background: #fff; color: #000; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1.2rem; box-shadow: 0 5px #999; }
        .word-card.used { opacity: 0.2; transform: scale(0.9); }
        .answer-word { background: #3498db !important; color: #fff !important; box-shadow: 0 5px #2980b9 !important; }
        .word-unit.selected { background: var(--rpg-red); color: #fff; box-shadow: none; transform: translateY(3px); }

        /* ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒªã‚¢ */
        #type-input { background: #000; color: var(--gold); border: 3px solid var(--gold); padding: 15px; width: 80%; text-align: center; font-size: 1.5rem; margin-bottom: 15px; border-radius: 8px; }

        /* ãƒœã‚¿ãƒ³ */
        .btn-main { width: 100%; padding: 20px; background: linear-gradient(#3498db, #2980b9); color: #fff; border: 4px solid #fff; border-radius: 10px; font-size: 1.8rem; font-weight: bold; cursor: pointer; box-shadow: 0 6px #1a5276; }
        .btn-main:active { transform: translateY(4px); box-shadow: 0 2px #1a5276; }

        /* ç§°å·/çµŒé¨“å€¤ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        #exp-layer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        #exp-res { font-size: 4rem; color: var(--gold); text-shadow: 0 0 20px red; margin: 0; }
    </style>
</head>
<body>

<div id="setup-screen">
    <h1 style="margin:0; font-size: 3rem;">GRAMMAR QUEST</h1>
    <div style="border-bottom: 2px solid #8b4513; display: inline-block; padding: 0 20px; font-style: italic;">Choose Your Magic Challenges</div>
    <div class="grid" id="grammar-grid"></div>
    <button class="btn-main" onclick="initGame()">QUEST START!</button>
</div>

<div id="game-screen">
    <div id="battle-view">
        <div id="monster-sprite">ğŸ‰</div>
        <div class="hp-container"><div id="hp-fill"></div></div>
        <div style="color:var(--gold); font-weight:bold;">Rank: <span id="player-rank">æ–°ç±³å†’é™ºè€…</span></div>
    </div>
    
    <div id="ja-text" style="font-size:1.5rem; font-weight:bold; color:var(--gold); margin-bottom:15px;"></div>

    <div id="sort-ui" style="display:none;">
        <div id="answer-area" class="card-container"></div>
        <div style="font-size: 0.8rem; color: #aaa; margin: 5px;">Your Cards</div>
        <div id="card-pool" class="card-container"></div>
    </div>

    <div id="fix-ui" style="display:none;">
        <div id="sentence-area" class="card-container"></div>
        <div id="input-zone" style="display:none;">
            <input type="text" id="type-input" autocomplete="off" placeholder="ä¿®å¾©é­”æ³•ã‚’å…¥åŠ›...">
        </div>
    </div>

    <button class="btn-main" style="background: linear-gradient(#e74c3c, #c0392b);" onclick="submitAttack()">ATTACK!</button>
    <div style="margin-top:10px; cursor:pointer; color: #888; text-decoration: underline;" onclick="resetCurrent()">Reset Turn</div>
</div>

<div id="exp-layer">
    <h1 id="exp-res"></h1>
    <p id="exp-text" style="font-size:1.5rem; padding: 20px; max-width: 600px;"></p>
    <div id="rank-up-msg" style="color:var(--gold); font-size:2rem; margin-bottom:20px; height: 40px;"></div>
    <button class="btn-main" style="width:300px;" onclick="closeExp()">NEXT BATTLE â–¶</button>
</div>

<script>
const db = {
    indirect: { name: "é–“æ¥ç–‘å•æ–‡", mode: "sort", q: [{ja:"å½¼ãŒã©ã“ã«ä½ã‚“ã§ã„ã‚‹ã‹çŸ¥ã£ã¦ã‚‹ï¼Ÿ", a:["Do", "you", "know", "where", "he", "lives", "?"], e:"èªé †ã¯ã€ç–‘å•è©ï¼‹ä¸»èªï¼‹å‹•è©ã€ã€‚ç–‘å•æ–‡ã®èªé †ã«ã¯ã—ã¾ã›ã‚“ã€‚"}]},
    rel: { name: "é–¢ä¿‚ä»£åè©", mode: "sort", q: [{ja:"ã“ã‚Œã¯ç§ãŒæ˜¨æ—¥è²·ã£ãŸæœ¬ã§ã™ã€‚", a:["This", "is", "the", "book", "which", "I", "bought", "yesterday", "."], e:"å…ˆè¡Œè©ãŒç‰©ã®æ™‚ã¯whichã‚’æ¥ç€å‰¤ã«ã—ã¾ã™ã€‚"}]},
    itfor: { name: "å½¢å¼ä¸»èªIt", mode: "sort", q: [{ja:"è‹±èªã‚’è©±ã™ã®ã¯é›£ã—ã„ã€‚", a:["It", "is", "difficult", "for", "me", "to", "speak", "English", "."], e:"ã€It is ã€œ for äºº to ...ã€ã®é‡è¦æ§‹æ–‡ã§ã™ã€‚"}]},
    exclam: { name: "æ„Ÿå˜†æ–‡", mode: "sort", q: [{ja:"ãªã‚“ã¦ç¾ã—ã„èŠ±ãªã‚“ã ï¼", a:["What", "a", "beautiful", "flower", "this", "is", "!"], e:"What (a) å½¢å®¹è© åè© S V ! ã®é †ã§ã™ã€‚"}]},
    give: { name: "æˆä¸å‹•è©", mode: "sort", q: [{ja:"å½¼ã¯ç§ã«æœ¬ã‚’ãã‚ŒãŸã€‚", a:["He", "gave", "the", "book", "to", "me", "."], e:"gave ç‰© to äººã€‚èªé †ãŒå…¥ã‚Œæ›¿ã‚ã‚‹æ™‚ã¯toãŒå¿…è¦ã§ã™ã€‚"}]},
    passive: { name: "å—ã‘èº«", mode: "fix", q: [{ja:"ã“ã®æ‰‹ç´™ã¯å¥ã«æ›¸ã‹ã‚ŒãŸã€‚", s:["This", "letter", "was", "wrote", "by", "Ken", "."], t:"wrote", a:"written", e:"beå‹•è©ï¼‹éå»åˆ†è©ã§ã™ã€‚"}]},
    perfect: { name: "å®Œäº†å½¢", mode: "fix", q: [{ja:"3å¹´é–“ãšã£ã¨ä½ã‚“ã§ã„ã‚‹ã€‚", s:["I", "have", "live", "here", "for", "3", "years", "."], t:"live", a:"lived", e:"haveï¼‹éå»åˆ†è©ã§ã™ã€‚"}]},
    post: { name: "å¾Œç½®ä¿®é£¾", mode: "fix", q: [{ja:"ã‚ãã“ã§æ­Œã†å°‘å¥³ã¯èŠ±å­ã ã€‚", s:["The", "girl", "sing", "over", "there", "is", "Hanako", "."], t:"sing", a:"singing", e:"singingãŒå¾Œã‚ã‹ã‚‰girlã‚’èª¬æ˜ã—ã¾ã™ã€‚"}]},
    prog: { name: "é€²è¡Œå½¢", mode: "fix", q: [{ja:"å½¼ã¯ä»Šèµ°ã£ã¦ã„ã‚‹ã€‚", s:["He", "running", "now", "."], t:"running", a:"is running", e:"beå‹•è©ãŒæŠœã‘ã¦ã„ã¾ã™ã€‚"}]},
    ing_only: { name: "å‹•åè©(ing)", mode: "fix", q: [{ja:"ãƒ†ãƒ¬ãƒ“ã‚’è¦‹ã‚‹ã®ã‚’ã‚„ã‚ãŸã€‚", s:["He", "stopped", "to", "watch", "TV", "."], t:"to", a:"(å‰Šé™¤)", e:"stopã®å¾Œã¯ingã®ã¿ã§ã™ã€‚"}]},
    to_only: { name: "ä¸å®šè©(to)", mode: "fix", q: [{ja:"åŒ»è€…ã«ãªã‚ŠãŸã„ã€‚", s:["I", "want", "becoming", "a", "doctor", "."], t:"becoming", a:"to be", e:"wantã®å¾Œã¯toä¸å®šè©ã§ã™ã€‚"}]},
    comp: { name: "æ¯”è¼ƒ", mode: "fix", q: [{ja:"å½¼ã‚ˆã‚ŠèƒŒãŒé«˜ã„ã€‚", s:["He", "is", "taller", "as", "me", "."], t:"as", a:"than", e:"æ¯”è¼ƒç´šã®å¾Œã¯thanã§ã™ã€‚"}]},
    modal: { name: "åŠ©å‹•è©", mode: "fix", q: [{ja:"è‹±èªã‚’è©±ã›ã‚‹ã€‚", s:["He", "can", "speaks", "English", "."], t:"speaks", a:"speak", e:"åŠ©å‹•è©ã®å¾Œã¯å¿…ãšåŸå½¢ã§ã™ã€‚"}]},
    sub: { name: "ä»®å®šæ³•", mode: "fix", q: [{ja:"ã‚‚ã—é³¥ãªã‚‰é£›ã¹ã‚‹ã®ã«ã€‚", s:["If", "I", "am", "a", "bird", ",", "I", "could", "fly", "."], t:"am", a:"were", e:"ä»®å®šæ³•ã®Ifç¯€ã¯wereã‚’ä½¿ã„ã¾ã™ã€‚"}]},
    svoc: { name: "ä½¿å½¹make", mode: "fix", q: [{ja:"æƒé™¤ã•ã›ãŸã€‚", s:["Made", "me", "to", "clean", "the", "room", "."], t:"to", a:"(å‰Šé™¤)", e:"make äºº åŸå½¢ä¸å®šè©ã§ã™ã€‚"}]},
    too_to: { name: "too..to", mode: "fix", q: [{ja:"è‹¥ã™ãã¦åƒã‘ãªã„ã€‚", s:["Too", "young", "working", "."], t:"working", a:"to work", e:"too ã€œ to åŸå½¢ã§ã™ã€‚"}]},
    tag: { name: "ä»˜åŠ ç–‘å•", mode: "fix", q: [{ja:"è¦ªåˆ‡ã§ã™ã‚ˆã­ï¼Ÿ", s:["He", "is", "kind", ",", "isn't", "is", "?"], t:"is", a:"he", e:"ä»£åè©ã§å—ã‘ã¾ã™ã€‚"}]},
    inf_d: { name: "ä¸å®šè©/å‹•åè©", mode: "fix", q: [{ja:"æ³³ãã®ã¯æ¥½ã—ã„ã€‚", s:["Swim", "is", "fun", "."], t:"Swim", a:"Swimming", e:"ä¸»èªã«ã™ã‚‹ãªã‚‰ingã‹toã§ã™ã€‚"}]}
};

const monsters = ["ğŸ‘¹", "ğŸ‘º", "ğŸ‰", "ğŸ’€", "ğŸ‘¾", "ğŸ¦Š", "ğŸ˜"];
let playlist = [], qIdx = 0, currentQ = null, userAns = [], score = 0, monsterHp = 100;

// æ–‡æ³•ã‚°ãƒªãƒƒãƒ‰ç”Ÿæˆï¼ˆæœ€åˆã‹ã‚‰å…¨è¡¨ç¤ºï¼‰
const grid = document.getElementById('grammar-grid');
Object.keys(db).forEach(k => {
    const d = document.createElement('div'); d.className = 'opt'; d.innerText = db[k].name;
    d.onclick = () => d.classList.toggle('selected'); d.dataset.key = k; grid.appendChild(d);
});

function initGame() {
    const sel = document.querySelectorAll('.opt.selected');
    if(!sel.length) return alert("æ–‡æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼");
    sel.forEach(o => { const cat = db[o.dataset.key]; cat.q.forEach(q => { q.mode = cat.mode; playlist.push(q); }); });
    playlist.sort(() => Math.random() - 0.5);
    document.getElementById('setup-screen').style.display = 'none';
    document.getElementById('game-screen').style.display = 'block';
    loadQuest();
}

function loadQuest() {
    if(qIdx >= playlist.length) { alert("ALL CLEAR!"); location.reload(); return; }
    currentQ = playlist[qIdx]; userAns = []; monsterHp = 100; updateHp();
    document.getElementById('monster-sprite').innerText = monsters[qIdx % monsters.length];
    document.getElementById('ja-text').innerText = currentQ.ja;
    document.getElementById('fix-ui').style.display = currentQ.mode === "fix" ? "block" : "none";
    document.getElementById('sort-ui').style.display = currentQ.mode === "sort" ? "block" : "none";
    document.getElementById('input-zone').style.display = "none";
    if(currentQ.mode === "sort") renderSort(); else renderFix();
}

function renderSort() {
    const pool = document.getElementById('card-pool'); pool.innerHTML = "";
    document.getElementById('answer-area').innerHTML = "";
    [...currentQ.a].sort(() => Math.random() - 0.5).forEach(w => {
        const card = document.createElement('div'); card.className = 'word-card'; card.innerText = w;
        card.onclick = () => {
            userAns.push(w); card.classList.add('used');
            const ac = document.createElement('div'); ac.className = 'word-card answer-word'; ac.innerText = w;
            document.getElementById('answer-area').appendChild(ac);
        }; pool.appendChild(card);
    });
}

function renderFix() {
    const area = document.getElementById('sentence-area'); area.innerHTML = "";
    currentQ.s.forEach(w => {
        const d = document.createElement('div'); d.className = 'word-unit'; d.innerText = w;
        d.onclick = () => {
            document.querySelectorAll('.word-unit').forEach(u => u.classList.remove('selected'));
            d.classList.add('selected'); document.getElementById('input-zone').style.display = 'block';
            document.getElementById('type-input').value = ""; document.getElementById('type-input').focus();
        }; area.appendChild(d);
    });
}

function submitAttack() {
    let ok = false;
    if(currentQ.mode === "sort") {
        ok = JSON.stringify(userAns) === JSON.stringify(currentQ.a);
    } else {
        const sel = document.querySelector('.word-unit.selected');
        const val = document.getElementById('type-input').value.trim().toLowerCase();
        if(sel && sel.innerText === currentQ.t) {
            ok = (val === currentQ.a.toLowerCase() || (currentQ.a === "(å‰Šé™¤)" && val === ""));
        }
    }

    if(ok) {
        monsterHp = 0; updateHp();
        document.getElementById('monster-sprite').classList.add('shake');
        confetti({particleCount: 150, origin: {y:0.6}});
        setTimeout(() => {
            document.getElementById('monster-sprite').classList.remove('shake');
            score++; checkRank();
            showExp("âœ¨ GREAT HIT!", currentQ.e);
        }, 600);
    } else {
        alert("MISS! æ•µã®é˜²å¾¡ã«é˜»ã¾ã‚ŒãŸï¼");
        resetCurrent();
    }
}

function updateHp() { document.getElementById('hp-fill').style.width = monsterHp + "%"; }

function checkRank() {
    const ranks = ["æ–°ç±³å†’é™ºè€…", "è¦‹ç¿’ã„é¨å£«", "æ–‡æ³•ãƒã‚¹ã‚¿ãƒ¼", "é­”å°å£«", "å‹‡è€…", "ä¼èª¬ã®è³¢è€…"];
    const rankIdx = Math.min(Math.floor(score/3), ranks.length - 1);
    const nextRank = ranks[rankIdx];
    if(nextRank !== document.getElementById('player-rank').innerText) {
        document.getElementById('player-rank').innerText = nextRank;
        document.getElementById('rank-up-msg').innerText = "RANK UP: " + nextRank + "!!";
    } else { document.getElementById('rank-up-msg').innerText = ""; }
}

function showExp(res, text) {
    document.getElementById('exp-res').innerText = res;
    document.getElementById('exp-text').innerHTML = text;
    document.getElementById('exp-layer').style.display = 'flex';
}

function closeExp() {
    document.getElementById('exp-layer').style.display = 'none';
    qIdx++; loadQuest();
}

function resetCurrent() {
    if(currentQ.mode === "sort") renderSort(); else renderFix();
}
</script>
</body>
</html>
