<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Grammar Quest: All-Stars</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root { --rpg-bg: #0a0a0a; --rpg-border: #fff; --rpg-red: #ff4757; --rpg-blue: #3498db; --rpg-gold: #eccc68; }
        body { background: var(--rpg-bg); color: #fff; font-family: 'Courier New', monospace; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 10px; }
        
        /* ÈÅ∏ÊäûÁîªÈù¢ */
        #setup-screen { width: 100%; max-width: 750px; background: #1a1a1a; border: 4px solid var(--rpg-border); padding: 20px; border-radius: 10px; box-sizing: border-box; text-align: center; }
        .section-title { color: var(--rpg-gold); border-bottom: 1px solid #555; padding-bottom: 5px; margin: 20px 0 10px; font-weight: bold; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; }
        .opt { background: #333; padding: 12px 5px; border: 2px solid #555; cursor: pointer; text-align: center; font-size: 0.85rem; border-radius: 5px; transition: 0.2s; }
        .opt.selected { background: var(--rpg-blue); border-color: #fff; transform: scale(1.02); }
        .count-options { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .count-btn { background: #444; color: #fff; border: 2px solid #777; padding: 10px 20px; cursor: pointer; border-radius: 5px; }
        .count-btn.active { background: var(--rpg-red); border-color: #fff; }

        /* „Ç≤„Éº„É†ÁîªÈù¢ */
        #game-screen { display: none; width: 100%; max-width: 500px; }
        #ui-layer { border: 3px solid #fff; padding: 10px; display: flex; justify-content: space-around; background: #000; margin-bottom: 5px; }
        #stage { height: 160px; border: 3px solid #fff; background: #1a1a2e; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        #monster-sprite { font-size: 60px; transition: transform 0.2s; }
        .hp-bar { width: 150px; height: 10px; background: #333; border: 1px solid #fff; margin-top: 10px; }
        #m-hp-fill { height: 100%; background: var(--rpg-red); width: 100%; transition: 0.3s; }
        
        #msg-box { min-height: 50px; border: 3px solid #fff; padding: 10px; background: #000; margin: 10px 0; text-align: center; font-size: 0.9rem; border-left: 8px solid var(--rpg-gold); }
        #ja-text { color: var(--rpg-gold); text-align: center; margin-bottom: 10px; font-weight: bold; }
        .sentence-box { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 20px; }
        .word-unit { padding: 8px 12px; border: 1px solid #777; background: #333; cursor: pointer; border-radius: 4px; font-size: 1.1rem; }
        .word-unit.selected { background: var(--rpg-red); }

        #input-zone { display: none; text-align: center; padding: 15px; background: #222; border-radius: 8px; }
        #type-input { background: #000; color: #fff; border: 2px solid #fff; padding: 10px; width: 85%; text-align: center; font-size: 1.2rem; }
        .btn { margin-top: 10px; padding: 10px 30px; background: #fff; color: #000; border: none; font-weight: bold; cursor: pointer; }
        
        #exp-layer { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 400px; background: #000; border: 4px solid var(--rpg-blue); padding: 25px; z-index: 100; box-shadow: 0 0 50px #000; }
        .shake { animation: shake 0.3s; }
        @keyframes shake { 0%,100%{transform:translateX(0)} 20%{-10px} 40%{10px} 60%{-10px} 80%{10px} }
        .flash { animation: flash 0.3s; }
        @keyframes flash { 0%,100%{background:var(--rpg-bg)} 50%{background:#500} }
    </style>
</head>
<body>

<div id="setup-screen">
    <h1 style="color:var(--rpg-gold); margin:0;">ENGLISH QUEST</h1>
    
    <div class="section-title">1. ÊñáÊ≥ï„ÇíÈÅ∏ÊäûÔºàÂ•Ω„Åç„Å™„Å†„ÅëÔºâ</div>
    <div class="grid" id="grammar-grid"></div>

    <div class="section-title">2. ÂïèÈ°åÊï∞„ÇíÈÅ∏Êäû</div>
    <div class="count-options">
        <button class="count-btn" onclick="setCount(5, this)">5Âïè</button>
        <button class="count-btn active" onclick="setCount(10, this)">10Âïè</button>
        <button class="count-btn" onclick="setCount(20, this)">20Âïè</button>
        <button class="count-btn" onclick="setCount(999, this)">ÂÖ®Âïè</button>
    </div>

    <button class="btn" style="width:100%; padding:18px; font-size:1.2rem; margin-top:15px;" onclick="initGame()">„ÇØ„Ç®„Çπ„ÉàÈñãÂßãÔºÅ</button>
</div>

<div id="game-screen">
    <div id="ui-layer">
        <div>PROGRESS: <span id="q-progress">0/0</span></div>
        <div>HP: <span id="p-hp" style="color:var(--rpg-red)">50</span>/50</div>
    </div>
    <div id="stage">
        <div id="monster-sprite">üëπ</div>
        <div class="hp-bar"><div id="m-hp-fill"></div></div>
    </div>
    <div id="msg-box">ÈñìÈÅï„ÅÑ„ÅÆÁÆáÊâÄ„Çí„Çø„ÉÉ„ÉÅ„Åõ„ÇàÔºÅ</div>
    <div id="ja-text"></div>
    <div id="sentence-area" class="sentence-box"></div>
    <div id="input-zone">
        <input type="text" id="type-input" autocomplete="off" placeholder="...">
        <br>
        <button class="btn" onclick="submitAttack()">ATTACK!</button>
    </div>
</div>

<div id="exp-layer">
    <div id="exp-res" style="font-weight:bold; color:var(--rpg-blue); margin-bottom:10px;"></div>
    <p id="exp-text"></p>
    <button class="btn" style="width:100%;" onclick="closeExp()">NEXT ‚ñ∂</button>
</div>

<script>
const db = {
    passive: { name: "„ÄêÂèó„ÅëË∫´„Äë", q: [
        {ja:"„Åì„ÅÆÊâãÁ¥ô„ÅØÊõ∏„Åã„Çå„Åæ„Åó„Åü„ÄÇ", s:["this", "letter", "was", "wrote", "."], t:"wrote", a:"written", e:"Âèó„ÅëË∫´„ÅØ„ÄêbeÂãïË©ûÔºãÈÅéÂéªÂàÜË©û„Äë„ÄÇ"},
        {ja:"Ëã±Ë™û„ÅØË©±„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ", s:["english", "is", "speak", "."], t:"speak", a:"spoken", e:"speak„ÅÆÈÅéÂéªÂàÜË©û„ÅØspoken„ÄÇ"},
        {ja:"„Åù„ÅÆÁ™ì„ÅØÂ£ä„Åï„Çå„Åü„ÄÇ", s:["the", "window", "was", "break", "."], t:"break", a:"broken", e:"break„ÅÆÈÅéÂéªÂàÜË©û„ÅØbroken„ÄÇ"}
    ]},
    perfect: { name: "„ÄêÂÆå‰∫ÜÂΩ¢„Äë", q: [
        {ja:"3Âπ¥Èñì‰Ωè„Çì„Åß„ÅÑ„Åæ„Åô„ÄÇ", s:["i", "have", "live", "here", "."], t:"live", a:"lived", e:"haveÔºãÈÅéÂéªÂàÜË©ûlived„ÄÇ"},
        {ja:"„Å°„Çá„ÅÜ„Å©ÁùÄ„ÅÑ„Åü„Å®„Åì„Çç„ÄÇ", s:["he", "has", "just", "arrive", "."], t:"arrive", a:"arrived", e:"ÁèæÂú®ÂÆå‰∫Ü„ÅØÈÅéÂéªÂàÜË©û„ÄÇ"},
        {ja:"ÁµÇ„Çè„Çä„Åæ„Åó„Åü„ÅãÔºü", s:["have", "you", "finish", "?"], t:"finish", a:"finished", e:"ÁñëÂïèÊñá„Åß„ÇÇÈÅéÂéªÂàÜË©û„ÄÇ"}
    ]},
    post: { name: "„ÄêÂæåÁΩÆ‰øÆÈ£æ„Äë", q: [
        {ja:"„ÅÇ„Åù„Åì„ÅßÊ≠å„Å£„Å¶„ÅÑ„ÇãÂ∞ëÂ•≥„ÄÇ", s:["the", "girl", "sing", "there", "."], t:"sing", a:"singing", e:"ÔΩû„Åó„Å¶„ÅÑ„ÇãÂ∞ëÂ•≥„ÅØÁèæÂú®ÂàÜË©û(ing)„ÄÇ"},
        {ja:"Êó•Êú¨„Åß‰Ωú„Çâ„Çå„ÅüËªä„ÄÇ", s:["a", "car", "make", "in", "japan", "."], t:"make", a:"made", e:"ÔΩû„Åï„Çå„ÅüËªä„ÅØÈÅéÂéªÂàÜË©û(made)„ÄÇ"},
        {ja:"ÂΩº„Å´Êõ∏„Åã„Çå„ÅüÊâãÁ¥ô„ÄÇ", s:["a", "letter", "write", "by", "him", "."], t:"write", a:"written", e:"ÈÅéÂéªÂàÜË©ûwritten„ÅßË™¨Êòé„Åó„Åæ„Åô„ÄÇ"}
    ]},
    rel: { name: "„ÄêÈñ¢‰øÇ‰ª£ÂêçË©û„Äë", q: [
        {ja:"ÁßÅ„ÅåË≤∑„Å£„ÅüÊú¨„ÄÇ", s:["the", "book", "who", "i", "bought", "."], t:"who", a:"which", e:"Áâ©„ÅåÂÖàË°åË©û„Å™„Çâwhich„ÄÇ"},
        {ja:"Ëµ∞„Å£„Å¶„ÅÑ„ÇãÂ∞ëÂπ¥„ÄÇ", s:["the", "boy", "which", "is", "running", "."], t:"which", a:"who", e:"‰∫∫„Å™„Çâwho„ÄÇ"},
        {ja:"Ë¶™Âàá„Å™ÂèãÈÅî„ÄÇ", s:["a", "friend", "which", "is", "kind", "."], t:"which", a:"who", e:"‰∫∫„Å™„ÅÆ„Åßwho„ÄÇ"}
    ]},
    prog: { name: "„ÄêÈÄ≤Ë°åÂΩ¢„Äë", q: [
        {ja:"ÂΩº„ÅØËµ∞„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ", s:["he", "running", "now", "."], t:"running", a:"is running", e:"beÂãïË©û„ÇíÂøò„Çå„Åö„Å´„ÄÇ"},
        {ja:"ÂΩº„Çâ„ÅØÊ≥≥„ÅÑ„Åß„ÅÑ„Åæ„Åô„ÄÇ", s:["they", "are", "swim", "."], t:"swim", a:"swimming", e:"m„ÇíÈáç„Å≠„Å¶ing„ÄÇ"},
        {ja:"È£ü„Åπ„Å¶„ÅÑ„Åæ„Åó„Åü„ÄÇ", s:["i", "was", "eat", "lunch", "."], t:"eat", a:"eating", e:"ÈÅéÂéªÈÄ≤Ë°åÂΩ¢„ÇÇing„ÄÇ"}
    ]},
    inf_only: { name: "„ÄêÂãïÂêçË©û„ÅÆ„Åø(ing)„Äë", q: [
        {ja:"Ë™≠„ÅøÁµÇ„Åà„Åü„ÄÇ", s:["finished", "to", "read", "."], t:"to", a:"(ÂâäÈô§)", e:"finish„ÅÆÂæå„ÅØreading„Å´„Åó„Åæ„Åô„ÄÇ"},
        {ja:"Ë¶ã„Çã„ÅÆ„Çí„ÇÑ„ÇÅ„Å¶„ÄÇ", s:["stop", "to", "watch", "tv", "."], t:"to", a:"(ÂâäÈô§)", e:"stop„ÅÆÂæå„ÅØwatching„ÄÇ"},
        {ja:"Ê•Ω„Åó„Çì„Å†„ÄÇ", s:["enjoyed", "to", "listen", "."], t:"to", a:"(ÂâäÈô§)", e:"enjoy„ÅÆÂæå„ÅØlistening„ÄÇ"}
    ]},
    to_only: { name: "„Äê‰∏çÂÆöË©û„ÅÆ„Åø(to)„Äë", q: [
        {ja:"„Å™„Çä„Åü„ÅÑ„ÄÇ", s:["want", "becoming", "."], t:"becoming", a:"to be", e:"want„ÅÆÂæå„ÅØto‰∏çÂÆöË©û„ÄÇ"},
        {ja:"Ê±∫„ÇÅ„Åü„ÄÇ", s:["decided", "going", "."], t:"going", a:"to go", e:"decide„ÅØto„ÇíÂæå„Çç„Å´Âèñ„Çä„Åæ„Åô„ÄÇ"},
        {ja:"Ë®àÁîª„Åó„Åü„ÄÇ", s:["planned", "visiting", "."], t:"visiting", a:"to visit", e:"plan„ÅØto‰∏çÂÆöË©û„ÄÇ"}
    ]},
    indirect: { name: "„ÄêÈñìÊé•ÁñëÂïè/ÁñëÂïèË©û„Äë", q: [
        {ja:"„Å©„Åì„Å´‰Ωè„Çì„Åß„ÅÑ„Çã„Åã„ÄÇ", s:["where", "does", "he", "live", "."], t:"does", a:"(ÂâäÈô§)", e:"ÁñëÂïèË©û„ÅÆÂæå„ÅØËÇØÂÆöÊñá„ÅÆË™ûÈ†Ü(he lives)„ÄÇ"},
        {ja:"ÂΩº„ÅåË™∞„Åã„ÄÇ", s:["who", "is", "he", "."], t:"is", a:"he is", e:"who he is„ÅÆÈ†Ü„ÄÇ"},
        {ja:"‰Ωï„Å®Ë®Ä„Å£„Åü„Åã„ÄÇ", s:["what", "did", "she", "say", "."], t:"did", a:"(ÂâäÈô§)", e:"what she said„ÄÇ"}
    ]},
    comp: { name: "„ÄêÊØîËºÉ„Äë", q: [
        {ja:"ÂΩº„Çà„ÇäËÉå„ÅåÈ´ò„ÅÑ„ÄÇ", s:["he", "is", "taller", "as", "me", "."], t:"as", a:"than", e:"ÊØîËºÉÁ¥ö„ÅÆÂæå„ÅØthan„ÄÇ"},
        {ja:"‰∏ñÁïå„Åß‰∏ÄÁï™Â§ß„Åç„ÅÑ„ÄÇ", s:["the", "biggest", "of", "the", "world", "."], t:"of", a:"in", e:"ÁØÑÂõ≤„Å™„Çâin„ÄÇ"},
        {ja:"„ÅÇ„Å™„Åü„Åª„Å©ÈÄü„Åè„Å™„ÅÑ„ÄÇ", s:["not", "as", "fast", "than", "you", "."], t:"than", a:"as", e:"as...as„ÅÆÂΩ¢„ÄÇ"}
    ]},
    modal: { name: "„ÄêÂä©ÂãïË©û„Äë", q: [
        {ja:"ÂΩº„ÅØÊ≥≥„Åí„Åæ„Åô„ÄÇ", s:["he", "can", "swims", "."], t:"swims", a:"swim", e:"Âä©ÂãïË©û„ÅÆÂæå„ÅØÂéüÂΩ¢„ÄÇ"},
        {ja:"Ë°å„Å£„Å¶„ÅØ„ÅÑ„Åë„Å™„ÅÑ„ÄÇ", s:["must", "not", "to", "go", "."], t:"to", a:"(ÂâäÈô§)", e:"must„ÅÆÁõ¥Âæå„Å´to„ÅØ‰∏çË¶Å„ÄÇ"},
        {ja:"Âøô„Åó„ÅÑ„Åß„Åó„Çá„ÅÜ„ÄÇ", s:["will", "is", "busy", "."], t:"is", a:"be", e:"will„ÅÆÂæå„ÅØbe„ÄÇ"}
    ]},
    sub: { name: "„Äê‰ªÆÂÆöÊ≥ï„Äë", q: [
        {ja:"„ÇÇ„ÅóÁßÅ„ÅåÈ≥•„Å™„Çâ„ÄÇ", s:["if", "i", "am", "a", "bird", "."], t:"am", a:"were", e:"‰ªÆÂÆöÊ≥ï„ÅØwere„ÄÇ"},
        {ja:"„ÅÇ„Çå„Å∞„ÅÑ„ÅÑ„ÅÆ„Å´„ÄÇ", s:["i", "wish", "i", "have", "time", "."], t:"have", a:"had", e:"wish„ÅÆÂæå„ÅØÈÅéÂéªÂΩ¢„ÄÇ"},
        {ja:"Ë°å„Åë„Çã„ÅÆ„Å´„ÄÇ", s:["i", "could", "go", "if", "i", "have", "money", "."], t:"have", a:"had", e:"ifÁØÄ„ÇÇÈÅéÂéªÂΩ¢„ÄÇ"}
    ]},
    svoc: { name: "„ÄêSVOÔºãto/ÂéüÂΩ¢„Äë", q: [
        {ja:"ÊéÉÈô§„Åï„Åõ„Åü„ÄÇ", s:["made", "me", "to", "clean", "."], t:"to", a:"(ÂâäÈô§)", e:"make„ÅØÂéüÂΩ¢‰∏çÂÆöË©û„ÄÇ"},
        {ja:"È†º„Çì„Å†„ÄÇ", s:["asked", "him", "help", "."], t:"help", a:"to help", e:"ask ‰∫∫ to ÂéüÂΩ¢„ÄÇ"},
        {ja:"Ë®±„Åó„Åü„ÄÇ", s:["allowed", "me", "go", "."], t:"go", a:"to go", e:"allow ‰∫∫ to ÂéüÂΩ¢„ÄÇ"}
    ]},
    itfor: { name: "„ÄêÂΩ¢Âºè‰∏ªË™ûIt„Äë", q: [
        {ja:"ÁßÅ„Å´„ÅØÈõ£„Åó„ÅÑ„ÄÇ", s:["it", "is", "difficult", "of", "me", "to", "read", "."], t:"of", a:"for", e:"It is ... for ‰∫∫ to ÔΩû„ÄÇ"},
        {ja:"ÂΩº„Å´„ÅØÁ∞°Âçò„Å†„ÄÇ", s:["it", "is", "easy", "for", "him", "running", "."], t:"running", a:"to run", e:"toÔºãÂãïË©û„ÅÆÂéüÂΩ¢„ÄÇ"},
        {ja:"ËâØ„ÅÑ„Åì„Å®„Å†„ÄÇ", s:["it", "is", "good", "to", "gets", "up", "."], t:"gets", a:"get", e:"to„ÅÆÂæå„ÅØÂéüÂΩ¢„ÄÇ"}
    ]},
    too_to: { name: "„Äêtoo to / enough„Äë", q: [
        {ja:"Ëã•„Åô„Åé„Å¶ÂÉç„Åë„Å™„ÅÑ„ÄÇ", s:["too", "young", "working", "."], t:"working", a:"to work", e:"too ÔΩû to ÂéüÂΩ¢„ÄÇ"},
        {ja:"ÂçÅÂàÜÁ∞°Âçò„Å†„ÄÇ", s:["easy", "enough", "reading", "."], t:"reading", a:"to read", e:"enough to ÂéüÂΩ¢„ÄÇ"},
        {ja:"Áú†„Çå„Å™„ÅÑ„ÄÇ", s:["too", "hot", "sleeping", "."], t:"sleeping", a:"to sleep", e:"too ÔΩû to ÂéüÂΩ¢„ÄÇ"}
    ]},
    tag: { name: "„Äê‰ªòÂä†ÁñëÂïèÊñá„Äë", q: [
        {ja:"Ë¶™Âàá„Åß„Åô„Çà„Å≠Ôºü", s:["he", "is", "kind", ",", "isn't", "is", "?"], t:"is", a:"he", e:"‰ª£ÂêçË©û„ÇíÁπ∞„ÇäËøî„Åô„ÄÇ"},
        {ja:"Â•Ω„Åç„Åß„Åô„Çà„Å≠Ôºü", s:["you", "like", "it", ",", "don't", "is", "?"], t:"is", a:"you", e:"don't you?„ÅÆÂΩ¢„ÄÇ"},
        {ja:"„Åß„Åç„Åæ„Åô„Çà„Å≠Ôºü", s:["she", "can", "swim", ",", "can't", "is", "?"], t:"is", a:"she", e:"can't she?„ÄÇ"}
    ]},
    exclam: { name: "„ÄêÊÑüÂòÜÊñá„Äë", q: [
        {ja:"„Å™„Çì„Å¶Áæé„Åó„ÅÑÔºÅ", s:["what", "a", "beautiful", "flower", "is", "it", "!"], t:"is it", a:"it is", e:"ÊúÄÂæå„ÅØ„Äå‰∏ªË™ûÔºãÂãïË©û„Äç„ÄÇ"},
        {ja:"„Å™„Çì„Å¶ÈÄü„ÅÑ„Çì„Å†ÔºÅ", s:["how", "fast", "runs", "he", "!"], t:"runs he", a:"he runs", e:"‰∏ªË™ûÔºãÂãïË©û„ÅÆÈ†Ü„ÄÇ"},
        {ja:"„Å™„Çì„Å¶Ë¶™Âàá„Å™„Çì„Å†ÔºÅ", s:["how", "kind", "is", "he", "!"], t:"is he", a:"he is", e:"he is„ÅÆÈ†Ü„ÄÇ"}
    ]},
    give: { name: "„ÄêÊéà‰∏éÂãïË©û„Äë", q: [
        {ja:"Êú¨„Çí„Åè„Çå„Åü„ÄÇ", s:["gave", "a", "book", "me", "."], t:"me", a:"to me", e:"gave Áâ© to ‰∫∫„ÄÇ"},
        {ja:"ÊâãÁ¥ô„ÇíÊõ∏„ÅÑ„Åü„ÄÇ", s:["wrote", "a", "letter", "she", "."], t:"she", a:"to her", e:"wrote Áâ© to ‰∫∫„ÄÇ"},
        {ja:"‰Ωú„Å£„Åü„ÄÇ", s:["made", "cake", "to", "me", "."], t:"to", a:"for", e:"make„ÅØfor„ÄÇ"}
    ]},
    inf_d: { name: "„Äê‰∏çÂÆöË©û„ÉªÂãïÂêçË©û„Äë", q: [
        {ja:"„Åô„Çã„Åì„Å®„ÅåÂ•Ω„Åç„ÄÇ", s:["like", "play", "tennis", "."], t:"play", a:"playing", e:"like playing„ÄÇ"},
        {ja:"Ê≥≥„Åé„Å´Ë°å„Å£„Åü„ÄÇ", s:["went", "sea", "swim", "."], t:"swim", a:"to swim", e:"ÁõÆÁöÑ„ÅÆ‰∏çÂÆöË©ûto„ÄÇ"},
        {ja:"Ë™≠„ÇÄ„Åü„ÇÅ„ÅÆÊú¨„ÄÇ", s:["a", "book", "read", "."], t:"read", a:"to read", e:"book to read„ÄÇ"}
    ]}
};

let playlist = [], qIdx = 0, mHp = 100, pHp = 50, currentQ = null;
let targetCount = 10, attempts = 0;

const grid = document.getElementById('grammar-grid');
Object.keys(db).forEach(k => {
    const d = document.createElement('div');
    d.className = 'opt'; d.innerText = db[k].name;
    d.onclick = () => d.classList.toggle('selected');
    d.dataset.key = k;
    grid.appendChild(d);
});

function setCount(num, el) {
    targetCount = num;
    document.querySelectorAll('.count-btn').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
}

function initGame() {
    const sel = document.querySelectorAll('.opt.selected');
    if(!sel.length) return alert("ÊñáÊ≥ï„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ");
    let allQ = [];
    sel.forEach(o => allQ.push(...db[o.dataset.key].q));
    allQ.sort(() => Math.random() - 0.5);
    playlist = allQ.slice(0, targetCount);
    document.getElementById('setup-screen').style.display = 'none';
    document.getElementById('game-screen').style.display = 'block';
    loadQuest();
}

function loadQuest() {
    if(qIdx >= playlist.length) { 
        confetti({particleCount:200}); 
        alert("„ÇØ„Ç®„Çπ„Éà„ÇØ„É™„Ç¢ÔºÅ"); 
        location.reload(); 
        return; 
    }
    currentQ = playlist[qIdx];
    mHp = 100; attempts = 0;
    updateUI();
    document.getElementById('ja-text').innerText = "ÂíåË®≥Ôºö" + currentQ.ja;
    document.getElementById('input-zone').style.display = 'none';
    document.getElementById('type-input').value = "";
    document.getElementById('msg-box').innerText = "ÈñìÈÅï„ÅÑ„Çí„Çø„ÉÉ„ÉÅ„Åõ„ÇàÔºÅ";
    const area = document.getElementById('sentence-area');
    area.innerHTML = "";
    currentQ.s.forEach(w => {
        const d = document.createElement('div');
        d.className = 'word-unit'; d.innerText = w;
        d.onclick = () => {
            if(w === currentQ.t) {
                d.classList.add('selected');
                document.getElementById('input-zone').style.display = 'block';
                document.getElementById('type-input').focus();
                document.getElementById('msg-box').innerText = "Ê≠£„Åó„ÅÑÁ∂¥„Çä„ÇíÂÖ•Âäõ„Åõ„ÇàÔºÅ(„ÉÅ„É£„É≥„Çπ2Âõû)";
            } else {
                pHp -= 2; updateUI();
                document.body.classList.add('flash');
                setTimeout(()=>document.body.classList.remove('flash'), 200);
            }
        };
        area.appendChild(d);
    });
}

function submitAttack() {
    const val = document.getElementById('type-input').value.trim().toLowerCase();
    const isCorrect = (val === currentQ.a.toLowerCase() || (currentQ.a === "(ÂâäÈô§)" && val === ""));
    
    if(isCorrect) {
        mHp = 0;
        document.getElementById('monster-sprite').classList.add('shake');
        confetti({particleCount:50});
        showExp("‚ú® GREAT HIT!", currentQ.e);
    } else {
        attempts++;
        if(attempts < 2) {
            document.getElementById('msg-box').innerText = "MISS! „ÅÇ„Å®1Âõû„ÉÅ„É£„É≥„Çπ„Åå„ÅÇ„Çã„ÅûÔºÅ";
            document.getElementById('type-input').value = "";
            document.getElementById('type-input').focus();
        } else {
            pHp -= 15;
            showExp("üíÄ FAILED...", `2Âõû„Éü„Çπ„Åó„Åæ„Åó„Åü„ÄÇÊ≠£Ëß£„ÅØ„Äå${currentQ.a}„Äç„Åß„Åô„ÄÇ<br>${currentQ.e}`);
        }
    }
    updateUI();
}

function showExp(res, text) {
    document.getElementById('exp-res').innerText = res;
    document.getElementById('exp-text').innerHTML = text;
    document.getElementById('exp-layer').style.display = 'block';
}

function closeExp() {
    document.getElementById('exp-layer').style.display = 'none';
    document.getElementById('monster-sprite').classList.remove('shake');
    if(pHp <= 0) { alert("ÊïóÂåó..."); location.reload(); }
    else { qIdx++; loadQuest(); }
}

function updateUI() {
    document.getElementById('p-hp').innerText = Math.max(0, pHp);
    document.getElementById('m-hp-fill').style.width = mHp + "%";
    document.getElementById('q-progress').innerText = `${qIdx + 1}/${playlist.length}`;
}
</script>
</body>
</html>
