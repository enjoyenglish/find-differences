<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Grammar Quest: Full Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root { --rpg-bg: #0a0a0a; --rpg-border: #fff; --rpg-red: #ff4757; --rpg-blue: #3498db; --rpg-gold: #eccc68; }
        body { background: var(--rpg-bg); color: #fff; font-family: 'Courier New', monospace; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 10px; }
        
        #setup-screen { width: 100%; max-width: 800px; background: #1a1a1a; border: 4px solid var(--rpg-border); padding: 20px; border-radius: 10px; box-sizing: border-box; text-align: center; }
        .section-title { color: var(--rpg-gold); border-bottom: 1px solid #555; padding-bottom: 5px; margin: 20px 0 10px; font-weight: bold; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; }
        .opt { background: #333; padding: 12px 5px; border: 2px solid #555; cursor: pointer; text-align: center; font-size: 0.85rem; border-radius: 5px; }
        .opt.selected { background: var(--rpg-blue); border-color: #fff; }
        .count-options { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .count-btn { background: #444; color: #fff; border: 2px solid #777; padding: 10px 20px; cursor: pointer; border-radius: 5px; }
        .count-btn.active { background: var(--rpg-red); border-color: #fff; }

        #game-screen { display: none; width: 100%; max-width: 500px; }
        #ui-layer { border: 3px solid #fff; padding: 10px; display: flex; justify-content: space-around; background: #000; margin-bottom: 5px; }
        #stage { height: 160px; border: 3px solid #fff; background: #1a1a2e; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        #monster-sprite { font-size: 60px; transition: 0.2s; }
        .hp-bar { width: 150px; height: 10px; background: #333; border: 1px solid #fff; margin-top: 10px; }
        #m-hp-fill { height: 100%; background: var(--rpg-red); width: 100%; transition: 0.3s; }
        
        #msg-box { min-height: 50px; border: 3px solid #fff; padding: 10px; background: #000; margin: 10px 0; text-align: center; font-size: 0.9rem; border-left: 8px solid var(--rpg-gold); }
        #ja-text { color: var(--rpg-gold); text-align: center; margin-bottom: 10px; font-weight: bold; }
        .sentence-box { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 20px; }
        .word-unit { padding: 8px 12px; border: 1px solid #777; background: #333; cursor: pointer; border-radius: 4px; font-size: 1.1rem; }
        .word-unit.selected { background: var(--rpg-red); }

        #input-zone { display: none; text-align: center; padding: 15px; background: #222; border-radius: 8px; }
        #type-input { background: #000; color: #fff; border: 2px solid #fff; padding: 10px; width: 85%; text-align: center; font-size: 1.2rem; }
        .btn { margin-top: 10px; padding: 10px 30px; background: #fff; color: #000; border: none; font-weight: bold; cursor: pointer; }
        
        #exp-layer { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 95%; max-width: 450px; background: #000; border: 4px solid var(--rpg-blue); padding: 25px; z-index: 100; box-shadow: 0 0 50px #000; }
        .shake { animation: shake 0.3s; }
        @keyframes shake { 0%,100%{transform:translateX(0)} 20%{-10px} 40%{10px} 60%{-10px} 80%{10px} }
        .flash { animation: flash 0.3s; }
        @keyframes flash { 0%,100%{background:var(--rpg-bg)} 50%{background:#500} }
    </style>
</head>
<body>

<div id="setup-screen">
    <h1 style="color:var(--rpg-gold); margin:0;">ENGLISH QUEST</h1>
    <div class="section-title">1. ÊñáÊ≥ï„ÇíÈÅ∏ÊäûÔºàÂÖ®18È†ÖÁõÆÔºâ</div>
    <div class="grid" id="grammar-grid"></div>

    <div class="section-title">2. ÂïèÈ°åÊï∞„ÇíÈÅ∏Êäû</div>
    <div class="count-options">
        <button class="count-btn" onclick="setCount(5, this)">5Âïè</button>
        <button class="count-btn active" onclick="setCount(10, this)">10Âïè</button>
        <button class="count-btn" onclick="setCount(20, this)">20Âïè</button>
        <button class="count-btn" onclick="setCount(999, this)">ÂÖ®Âïè</button>
    </div>
    <button class="btn" style="width:100%; padding:18px; font-size:1.2rem; margin-top:15px;" onclick="initGame()">ÂÜíÈô∫„ÇíÈñãÂßã„Åô„Çã</button>
</div>

<div id="game-screen">
    <div id="ui-layer">
        <div>QUEST: <span id="q-progress">0/0</span></div>
        <div>HP: <span id="p-hp" style="color:var(--rpg-red)">50</span>/50</div>
    </div>
    <div id="stage">
        <div id="monster-sprite">üêâ</div>
        <div class="hp-bar"><div id="m-hp-fill"></div></div>
    </div>
    <div id="msg-box">ÈñìÈÅï„ÅÑ„Çí„Çø„ÉÉ„ÉÅ„Åõ„ÇàÔºÅ</div>
    <div id="ja-text"></div>
    <div id="sentence-area" class="sentence-box"></div>
    <div id="input-zone">
        <input type="text" id="type-input" autocomplete="off" placeholder="...">
        <br>
        <button class="btn" onclick="submitAttack()">ATTACK!</button>
    </div>
</div>

<div id="exp-layer">
    <div id="exp-res" style="font-weight:bold; color:var(--rpg-blue); margin-bottom:10px;"></div>
    <p id="exp-text"></p>
    <button class="btn" style="width:100%;" onclick="closeExp()">NEXT ‚ñ∂</button>
</div>

<script>
// ÂÖ®18È†ÖÁõÆ„ÅÆÂÆåÂÖ®Áâà„Éá„Éº„Çø„Éô„Éº„Çπ
const db = {
    passive: { name: "„ÄêÂèó„ÅëË∫´„Äë", q: [
        {ja:"„Åì„ÅÆÊâãÁ¥ô„ÅØÊõ∏„Åã„Çå„Åæ„Åó„Åü„ÄÇ", s:["This", "letter", "was", "wrote", "."], t:"wrote", a:"written", e:"Âèó„ÅëË∫´„ÅØbeÂãïË©ûÔºãÈÅéÂéªÂàÜË©û„ÄÇ"},
        {ja:"Ëã±Ë™û„ÅØË©±„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ", s:["English", "is", "speak", "."], t:"speak", a:"spoken", e:"speak„ÅÆÈÅéÂéªÂàÜË©û„ÅØspoken„ÄÇ"}
    ]},
    perfect: { name: "„ÄêÂÆå‰∫ÜÂΩ¢„Äë", q: [
        {ja:"3Âπ¥Èñì‰Ωè„Çì„Åß„ÅÑ„Åæ„Åô„ÄÇ", s:["I", "have", "live", "here", "."], t:"live", a:"lived", e:"haveÔºãÈÅéÂéªÂàÜË©û„ÄÇ"},
        {ja:"„Å°„Çá„ÅÜ„Å©ÁùÄ„ÅÑ„Åü„Å®„Åì„Çç„ÄÇ", s:["He", "has", "just", "arrive", "."], t:"arrive", a:"arrived", e:"ÁèæÂú®ÂÆå‰∫Ü„ÅØÈÅéÂéªÂàÜË©û„ÄÇ"}
    ]},
    post: { name: "„ÄêÂæåÁΩÆ‰øÆÈ£æ„Äë", q: [
        {ja:"Ê≠å„Å£„Å¶„ÅÑ„ÇãÂ∞ëÂ•≥„ÄÇ", s:["The", "girl", "sing", "there", "."], t:"sing", a:"singing", e:"ÔΩû„Åó„Å¶„ÅÑ„ÇãÂ∞ëÂ•≥„ÅØÁèæÂú®ÂàÜË©û(ing)„ÄÇ"},
        {ja:"‰Ωú„Çâ„Çå„ÅüËªä„ÄÇ", s:["A", "car", "make", "in", "Japan", "."], t:"make", a:"made", e:"ÔΩû„Åï„Çå„ÅüËªä„ÅØÈÅéÂéªÂàÜË©û(made)„ÄÇ"}
    ]},
    rel: { name: "„ÄêÈñ¢‰øÇ‰ª£ÂêçË©û„Äë", q: [
        {ja:"ÁßÅ„ÅåË≤∑„Å£„ÅüÊú¨„ÄÇ", s:["The", "book", "who", "I", "bought", "."], t:"who", a:"which", e:"Áâ©„ÅåÂÖàË°åË©û„Å™„Çâwhich„ÄÇ"},
        {ja:"Ëµ∞„Å£„Å¶„ÅÑ„ÇãÂ∞ëÂπ¥„ÄÇ", s:["The", "boy", "which", "is", "running", "."], t:"which", a:"who", e:"‰∫∫„Å™„Çâwho„ÄÇ"}
    ]},
    prog: { name: "„ÄêÈÄ≤Ë°åÂΩ¢„Äë", q: [
        {ja:"ÂΩº„ÅØËµ∞„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ", s:["He", "running", "now", "."], t:"running", a:"is running", e:"beÂãïË©û„ÇíÂøò„Çå„Åö„Å´„ÄÇ"},
        {ja:"Ê≥≥„ÅÑ„Åß„ÅÑ„Åæ„Åô„ÄÇ", s:["They", "are", "swim", "."], t:"swim", a:"swimming", e:"m„ÇíÈáç„Å≠„Å¶ing„ÄÇ"}
    ]},
    ing_only: { name: "„Äêing„ÅÆ„ÅøÂãïË©û„Äë", q: [
        {ja:"Ë™≠„ÅøÁµÇ„Åà„Åü„ÄÇ", s:["I", "finished", "to", "read", "."], t:"to", a:"(ÂâäÈô§)", e:"finish„ÅÆÂæå„ÅØreading„ÄÇ"},
        {ja:"Ê•Ω„Åó„Çì„Å†„ÄÇ", s:["I", "enjoyed", "to", "listen", "."], t:"to", a:"(ÂâäÈô§)", e:"enjoy„ÅÆÂæå„ÅØlistening„ÄÇ"}
    ]},
    to_only: { name: "„Äêto„ÅÆ„ÅøÂãïË©û„Äë", q: [
        {ja:"„Å™„Çä„Åü„ÅÑ„ÄÇ", s:["I", "want", "becoming", "."], t:"becoming", a:"to be", e:"want„ÅÆÂæå„ÅØto‰∏çÂÆöË©û„ÄÇ"},
        {ja:"Ê±∫„ÇÅ„Åü„ÄÇ", s:["He", "decided", "going", "."], t:"going", a:"to go", e:"decide„ÅØto‰∏çÂÆöË©û„ÄÇ"}
    ]},
    indirect: { name: "„ÄêÈñìÊé•ÁñëÂïè„Äë", q: [
        {ja:"„Å©„Åì„Å´‰Ωè„Çì„Åß„ÅÑ„Çã„Åã„ÄÇ", s:["Where", "does", "he", "live", "."], t:"does", a:"(ÂâäÈô§)", e:"Ë™ûÈ†Ü„ÅØËÇØÂÆöÊñá(he lives)„Å®Âêå„Åò„ÄÇ"},
        {ja:"ÂΩº„ÅåË™∞„Åã„ÄÇ", s:["Who", "is", "he", "."], t:"is", a:"he is", e:"who he is„ÅÆÈ†Ü„ÄÇ"}
    ]},
    comp: { name: "„ÄêÊØîËºÉ„Äë", q: [
        {ja:"ÂΩº„Çà„ÇäËÉå„ÅåÈ´ò„ÅÑ„ÄÇ", s:["He", "is", "taller", "as", "me", "."], t:"as", a:"than", e:"ÊØîËºÉÁ¥ö„ÅÆÂæå„ÅØthan„ÄÇ"},
        {ja:"‰∏ÄÁï™Â§ß„Åç„ÅÑ„ÄÇ", s:["The", "biggest", "of", "the", "world", "."], t:"of", a:"in", e:"ÁØÑÂõ≤„Å™„Çâin„ÄÇ"}
    ]},
    modal: { name: "„ÄêÂä©ÂãïË©û„Äë", q: [
        {ja:"Ê≥≥„Åí„Åæ„Åô„ÄÇ", s:["He", "can", "swims", "."], t:"swims", a:"swim", e:"Âä©ÂãïË©û„ÅÆÂæå„ÅØÂéüÂΩ¢„ÄÇ"},
        {ja:"Âøô„Åó„ÅÑ„Åß„Åó„Çá„ÅÜ„ÄÇ", s:["I", "will", "am", "busy", "."], t:"am", a:"be", e:"will„ÅÆÂæå„ÅØÂéüÂΩ¢be„ÄÇ"}
    ]},
    sub: { name: "„Äê‰ªÆÂÆöÊ≥ï„Äë", q: [
        {ja:"„ÇÇ„ÅóÈ≥•„Å™„Çâ„ÄÇ", s:["If", "I", "am", "a", "bird", "."], t:"am", a:"were", e:"‰ªÆÂÆöÊ≥ï„ÅØwere„Çí‰Ωø„ÅÑ„Åæ„Åô„ÄÇ"},
        {ja:"„ÅÇ„Çå„Å∞„ÅÑ„ÅÑ„ÅÆ„Å´„ÄÇ", s:["I", "wish", "I", "have", "time", "."], t:"have", a:"had", e:"wish„ÅÆÂæå„ÅØÈÅéÂéªÂΩ¢„ÄÇ"}
    ]},
    svoc: { name: "„ÄêSVOÔºãto/ÂéüÂΩ¢„Äë", q: [
        {ja:"ÊéÉÈô§„Åï„Åõ„Åü„ÄÇ", s:["She", "made", "me", "to", "clean", "."], t:"to", a:"(ÂâäÈô§)", e:"make„ÅØÂéüÂΩ¢‰∏çÂÆöË©û„ÄÇ"},
        {ja:"È†º„Çì„Å†„ÄÇ", s:["I", "asked", "him", "help", "."], t:"help", a:"to help", e:"ask ‰∫∫ to ÂéüÂΩ¢„ÄÇ"}
    ]},
    itfor: { name: "„ÄêÂΩ¢Âºè‰∏ªË™ûIt„Äë", q: [
        {ja:"ÁßÅ„Å´„ÅØÈõ£„Åó„ÅÑ„ÄÇ", s:["It", "is", "difficult", "of", "me", "to", "..."], t:"of", a:"for", e:"It is ... for ‰∫∫ to ÔΩû„ÄÇ"},
        {ja:"ËâØ„ÅÑ„Åì„Å®„Å†„ÄÇ", s:["It", "is", "good", "to", "gets", "up", "."], t:"gets", a:"get", e:"to„ÅÆÂæå„ÅØÂéüÂΩ¢„ÄÇ"}
    ]},
    too_to: { name: "„Äêtoo to„Äë", q: [
        {ja:"Ëã•„Åô„Åé„Å¶ÂÉç„Åë„Å™„ÅÑ„ÄÇ", s:["Too", "young", "working", "."], t:"working", a:"to work", e:"too ÔΩû to ÂéüÂΩ¢„ÄÇ"}
    ]},
    tag: { name: "„Äê‰ªòÂä†ÁñëÂïè„Äë", q: [
        {ja:"Ë¶™Âàá„Åß„Åô„Çà„Å≠Ôºü", s:["He", "is", "kind", ",", "isn't", "is", "?"], t:"is", a:"he", e:"‰ª£ÂêçË©ûhe„ÇíÁπ∞„ÇäËøî„Åô„ÄÇ"}
    ]},
    exclam: { name: "„ÄêÊÑüÂòÜÊñá„Äë", q: [
        {ja:"„Å™„Çì„Å¶Áæé„Åó„ÅÑÔºÅ", s:["What", "a", "beautiful", "flower", "is", "it", "!"], t:"is it", a:"it is", e:"ÊúÄÂæå„ÅØ‰∏ªË™ûÔºãÂãïË©û„ÄÇ"}
    ]},
    give: { name: "„ÄêÊéà‰∏éÂãïË©û„Äë", q: [
        {ja:"Êú¨„Çí„Åè„Çå„Åü„ÄÇ", s:["He", "gave", "a", "book", "me", "."], t:"me", a:"to me", e:"gave Áâ© to ‰∫∫„ÄÇ"},
        {ja:"‰Ωú„Å£„Åü„ÄÇ", s:["I", "made", "cake", "to", "me", "."], t:"to", a:"for", e:"make„ÅØfor„ÄÇ"}
    ]},
    inf_d: { name: "„Äê‰∏çÂÆöË©û/ÂãïÂêçË©û„Äë", q: [
        {ja:"„ÉÜ„Éã„Çπ„ÅåÂ•Ω„Åç„ÄÇ", s:["I", "like", "play", "tennis", "."], t:"play", a:"playing", e:"like playing„ÄÇ"}
    ]}
};

let playlist = [], qIdx = 0, mHp = 100, pHp = 50, currentQ = null;
let targetCount = 10, attempts = 0;

const grid = document.getElementById('grammar-grid');
Object.keys(db).forEach(k => {
    const d = document.createElement('div');
    d.className = 'opt'; d.innerText = db[k].name;
    d.onclick = () => d.classList.toggle('selected');
    d.dataset.key = k;
    grid.appendChild(d);
});

function setCount(num, el) {
    targetCount = num;
    document.querySelectorAll('.count-btn').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
}

function initGame() {
    const sel = document.querySelectorAll('.opt.selected');
    if(!sel.length) return alert("ÊñáÊ≥ï„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ");
    let allQ = [];
    sel.forEach(o => allQ.push(...db[o.dataset.key].q));
    allQ.sort(() => Math.random() - 0.5);
    playlist = allQ.slice(0, targetCount);
    document.getElementById('setup-screen').style.display = 'none';
    document.getElementById('game-screen').style.display = 'block';
    loadQuest();
}

function loadQuest() {
    if(qIdx >= playlist.length) { 
        confetti({particleCount:150});
        alert("QUEST CLEAR!"); 
        location.reload(); 
        return; 
    }
    currentQ = playlist[qIdx];
    mHp = 100; attempts = 0;
    updateUI();
    document.getElementById('ja-text').innerText = "ÂíåË®≥Ôºö" + currentQ.ja;
    document.getElementById('input-zone').style.display = 'none';
    document.getElementById('type-input').value = "";
    document.getElementById('msg-box').innerText = "ÈñìÈÅï„ÅÑ„Çí„Çø„ÉÉ„ÉÅ„Åõ„ÇàÔºÅ";
    const area = document.getElementById('sentence-area');
    area.innerHTML = "";
    currentQ.s.forEach(w => {
        const d = document.createElement('div');
        d.className = 'word-unit'; d.innerText = w;
        d.onclick = () => {
            if(w === currentQ.t) {
                d.classList.add('selected');
                document.getElementById('input-zone').style.display = 'block';
                document.getElementById('type-input').focus();
            } else {
                pHp -= 2; updateUI();
                document.body.classList.add('flash');
                setTimeout(()=>document.body.classList.remove('flash'), 200);
            }
        };
        area.appendChild(d);
    });
}

function submitAttack() {
    const val = document.getElementById('type-input').value.trim().toLowerCase();
    const isCorrect = (val === currentQ.a.toLowerCase() || (currentQ.a === "(ÂâäÈô§)" && val === ""));
    
    if(isCorrect) {
        mHp = 0;
        document.getElementById('monster-sprite').classList.add('shake');
        confetti({particleCount:50});
        showExp("‚ú® GREAT HIT!", currentQ.e);
    } else {
        attempts++;
        if(attempts < 2) {
            document.getElementById('msg-box').innerText = "MISS! „ÅÇ„Å®1Âõû„ÉÅ„É£„É≥„Çπ„Åå„ÅÇ„Çã„ÅûÔºÅ";
            document.getElementById('type-input').value = "";
            document.getElementById('type-input').focus();
        } else {
            pHp -= 15;
            showExp("üíÄ FAILED...", `2Âõû„Éü„Çπ„Åó„Åæ„Åó„Åü„ÄÇÊ≠£Ëß£„ÅØ„Äå${currentQ.a}„Äç„Åß„Åô„ÄÇ<br>${currentQ.e}`);
        }
    }
    updateUI();
}

function showExp(res, text) {
    document.getElementById('exp-res').innerText = res;
    document.getElementById('exp-text').innerHTML = text;
    document.getElementById('exp-layer').style.display = 'block';
}

function closeExp() {
    document.getElementById('exp-layer').style.display = 'none';
    document.getElementById('monster-sprite').classList.remove('shake');
    if(pHp <= 0) { alert("ÊïóÂåó..."); location.reload(); }
    else { qIdx++; loadQuest(); }
}

function updateUI() {
    document.getElementById('p-hp').innerText = Math.max(0, pHp);
    document.getElementById('m-hp-fill').style.width = mHp + "%";
    document.getElementById('q-progress').innerText = `${qIdx + 1}/${playlist.length}`;
}
</script>
</body>
</html>
