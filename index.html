<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Grammar Quest: Enhanced</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root { --rpg-bg: #0a0a0a; --rpg-border: #fff; --rpg-red: #ff4757; --rpg-blue: #3498db; --rpg-gold: #eccc68; }
        body { background: var(--rpg-bg); color: #fff; font-family: 'Courier New', monospace; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 10px; }
        
        #setup-screen { width: 100%; max-width: 800px; background: #1a1a1a; border: 4px solid var(--rpg-border); padding: 20px; border-radius: 10px; text-align: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; margin: 20px 0; }
        .opt { background: #333; padding: 12px 5px; border: 2px solid #555; cursor: pointer; border-radius: 5px; font-size: 0.85rem; }
        .opt.selected { background: var(--rpg-blue); border-color: #fff; }

        #game-screen { display: none; width: 100%; max-width: 500px; }
        #stage { height: 160px; border: 3px solid #fff; background: #1a1a2e; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 10px; }
        #monster-sprite { font-size: 60px; transition: 0.2s; }
        
        #msg-box { min-height: 60px; border: 3px solid #fff; padding: 10px; background: #000; margin: 10px 0; text-align: center; border-left: 8px solid var(--rpg-gold); font-weight: bold; }
        #ja-text { color: var(--rpg-gold); text-align: center; margin-bottom: 15px; font-size: 1.1rem; }
        
        .sentence-box { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 20px; }
        .word-unit { padding: 10px 15px; border: 2px solid #777; background: #333; cursor: pointer; border-radius: 6px; font-size: 1.2rem; }
        .word-unit.selected { background: var(--rpg-red); border-color: #fff; }

        #input-zone { display: none; text-align: center; padding: 20px; background: #222; border-radius: 10px; border: 2px dashed var(--rpg-gold); }
        #type-input { background: #000; color: #fff; border: 2px solid var(--rpg-gold); padding: 12px; width: 80%; text-align: center; font-size: 1.3rem; margin-bottom: 10px; }
        .btn { padding: 12px 30px; background: #fff; color: #000; border: none; font-weight: bold; cursor: pointer; font-size: 1rem; }

        #exp-layer { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; background: #000; border: 4px solid var(--rpg-blue); padding: 25px; z-index: 100; }
    </style>
</head>
<body>

<div id="setup-screen">
    <h1 style="color:var(--rpg-gold);">GRAMMAR QUEST</h1>
    <p>1. ç·´ç¿’ã—ãŸã„æ–‡æ³•ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ</p>
    <div class="grid" id="grammar-grid"></div>
    <button class="btn" style="width:100%;" onclick="initGame()">å†’é™ºã‚’é–‹å§‹ã™ã‚‹</button>
</div>

<div id="game-screen">
    <div id="stage">
        <div id="monster-sprite">ğŸ‘º</div>
        <div style="font-size: 0.8rem;">HP: <span id="m-hp-text">100</span>%</div>
    </div>
    
    <div id="msg-box">ã€STEP 1ã€‘<br>æ–‡ã®ä¸­ã§ãŠã‹ã—ã„å˜èªã‚’ï¼‘ã¤é¸ã‚“ã§ï¼</div>
    
    <div id="ja-text"></div>
    <div id="sentence-area" class="sentence-box"></div>

    <div id="input-zone">
        <p style="margin: 0 0 10px 0; font-size: 0.9rem; color: var(--rpg-gold);">ã€STEP 2ã€‘æ­£ã—ã„å˜èªï¼ˆç¶´ã‚Šï¼‰ã‚’å…¥åŠ›ã›ã‚ˆï¼</p>
        <input type="text" id="type-input" autocomplete="off" placeholder="ã“ã“ã«å…¥åŠ›...">
        <br>
        <button class="btn" onclick="submitAttack()">æ”»æ’ƒ(ATTACK!)</button>
    </div>
</div>

<div id="exp-layer">
    <h2 id="exp-res"></h2>
    <p id="exp-text"></p>
    <button class="btn" style="width:100%;" onclick="closeExp()">æ¬¡ã¸é€²ã‚€ â–¶</button>
</div>

<script>
// æ–‡æ³•ã®ä¿®æ­£ã¨è¿½åŠ 
const db = {
    indirect: { name: "ã€é–“æ¥ç–‘å•ã€‘", q: [
        {ja:"å½¼ãŒèª°ãªã®ã‹çŸ¥ã‚Šã¾ã›ã‚“ã€‚", s:["I", "don't", "know", "who", "is", "he", "."], t:"is", a:"he is", e:"é–“æ¥ç–‘å•æ–‡ã¯ã€Œç–‘å•è©ï¼‹ä¸»èªï¼‹å‹•è©ã€ã®é †ã§ã™ã€‚isã‚’æ¶ˆã—ã¦he isã¨ç›´ã—ã¾ã™ã€‚"},
        {ja:"å½¼å¥³ãŒã©ã“ã«ä½ã‚“ã§ã„ã‚‹ã‹çŸ¥ã£ã¦ã„ã¾ã™ã‹ï¼Ÿ", s:["Do", "you", "know", "where", "does", "she", "live", "?"], t:"does", a:"(å‰Šé™¤)", e:"é–“æ¥ç–‘å•æ–‡ã®ä¸­ã§ã¯do/does/didã¯ä½¿ã„ã¾ã›ã‚“ã€‚"},
        {ja:"å½¼ãŒä½•ã‚’è²·ã£ãŸã‹è¦šãˆã¦ã„ã¾ã™ã€‚", s:["I", "remember", "what", "did", "he", "buy", "."], t:"did", a:"he bought", e:"éå»å½¢ã®ç–‘å•æ–‡ã‚‚ã€Œä¸»èªï¼‹éå»å½¢å‹•è©ã€ã«æˆ»ã‚Šã¾ã™ã€‚"}
    ]},
    passive: { name: "ã€å—ã‘èº«ã€‘", q: [
        {ja:"ã“ã®æœ¬ã¯å¤ç›®æ¼±çŸ³ã«ã‚ˆã£ã¦æ›¸ã‹ã‚ŒãŸã€‚", s:["This", "book", "was", "wrote", "by", "Soseki", "."], t:"wrote", a:"written", e:"å—ã‘èº«ã¯ beå‹•è©ï¼‹éå»åˆ†è© ã§ã™ã€‚"}
    ]},
    svoc: { name: "ã€ä½¿å½¹ãƒ»ä¾é ¼ã€‘", q: [
        {ja:"å½¼ã¯ç§ã«éƒ¨å±‹ã‚’æƒé™¤ã•ã›ãŸã€‚", s:["He", "made", "me", "to", "clean", "the", "room", "."], t:"to", a:"(å‰Šé™¤)", e:"ä½¿å½¹ã®makeã®å¾Œã¯ã€Œäººï¼‹å‹•è©ã®åŸå½¢ã€ã§ã™ã€‚"}
    ]}
    // ... ä»–ã®æ–‡æ³•ã¯å‰å›ã®ãƒªã‚¹ãƒˆã‚’å‚ç…§ã—ã¦è¿½åŠ å¯èƒ½
};

let playlist = [], qIdx = 0, mHp = 100, attempts = 0, currentQ = null;

// åˆæœŸåŒ–
const grid = document.getElementById('grammar-grid');
Object.keys(db).forEach(k => {
    const d = document.createElement('div');
    d.className = 'opt'; d.innerText = db[k].name;
    d.onclick = () => d.classList.toggle('selected');
    d.dataset.key = k;
    grid.appendChild(d);
});

function initGame() {
    const sel = document.querySelectorAll('.opt.selected');
    if(!sel.length) return alert("æ–‡æ³•ã‚’é¸ã‚“ã§ã­ï¼");
    sel.forEach(o => playlist.push(...db[o.dataset.key].q));
    playlist.sort(() => Math.random() - 0.5);
    document.getElementById('setup-screen').style.display = 'none';
    document.getElementById('game-screen').style.display = 'block';
    loadQuest();
}

function loadQuest() {
    if(qIdx >= playlist.length) return alert("å…¨å•ã‚¯ãƒªã‚¢ï¼");
    currentQ = playlist[qIdx];
    attempts = 0;
    document.getElementById('ja-text').innerText = "å’Œè¨³ï¼š" + currentQ.ja;
    document.getElementById('msg-box').innerHTML = "ã€STEP 1ã€‘<br>é–“é•ã„ã®å˜èªã‚’ã‚¿ãƒƒãƒ—ã—ã¦ï¼";
    document.getElementById('input-zone').style.display = 'none';
    document.getElementById('type-input').value = "";
    
    const area = document.getElementById('sentence-area');
    area.innerHTML = "";
    currentQ.s.forEach(w => {
        const d = document.createElement('div');
        d.className = 'word-unit'; d.innerText = w;
        d.onclick = () => {
            if(w === currentQ.t) {
                d.classList.add('selected');
                document.getElementById('msg-box').innerHTML = `ã€Œ${w}ã€ã‚’ã©ã†ç›´ã™ï¼Ÿ<br>æ­£ã—ã„ç¶´ã‚Šã‚’ä¸‹ã«å…¥åŠ›ã—ã¦ï¼`;
                document.getElementById('input-zone').style.display = 'block';
                document.getElementById('type-input').focus();
            } else {
                document.getElementById('msg-box').innerHTML = "ãã‚Œã¯æ­£ã—ã„å˜èªã ã‚ˆï¼<br>ä»–ã‚’æ¢ã—ã¦ã¿ã¦ã€‚";
            }
        };
        area.appendChild(d);
    });
}

function submitAttack() {
    const val = document.getElementById('type-input').value.trim().toLowerCase();
    const correctVal = currentQ.a.toLowerCase();
    
    if(val === correctVal || (currentQ.a === "(å‰Šé™¤)" && val === "")) {
        confetti({particleCount: 100});
        showExp("âœ¨ æ­£è§£ï¼", currentQ.e);
    } else {
        attempts++;
        if(attempts < 2) {
            document.getElementById('msg-box').innerHTML = "ãŠã£ã¨ã€ç¶´ã‚ŠãŒé•ã†ã¿ãŸã„ï¼<br>ã‚‚ã†ä¸€å›ãƒãƒ£ãƒ³ã‚¹ãŒã‚ã‚‹ãï¼";
            document.getElementById('type-input').value = "";
        } else {
            showExp("ğŸ’€ ãƒŸã‚¹ï¼", `2å›é–“é•ãˆã¾ã—ãŸã€‚æ­£è§£ã¯ã€Œ${currentQ.a}ã€ã§ã™ã€‚<br>${currentQ.e}`);
        }
    }
}

function showExp(res, text) {
    document.getElementById('exp-res').innerText = res;
    document.getElementById('exp-text').innerHTML = text;
    document.getElementById('exp-layer').style.display = 'block';
}

function closeExp() {
    document.getElementById('exp-layer').style.display = 'none';
    qIdx++;
    loadQuest();
}
</script>
</body>
</html>
