<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Grammar Quest - 2-Chance Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root { --rpg-bg: #0a0a0a; --rpg-border: #fff; --rpg-red: #ff4757; --rpg-blue: #3498db; --rpg-gold: #eccc68; }
        body { background: var(--rpg-bg); color: #fff; font-family: 'Courier New', monospace; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 10px; }
        
        /* ÈÅ∏ÊäûÁîªÈù¢ */
        #setup-screen { width: 100%; max-width: 700px; background: #1a1a1a; border: 4px solid var(--rpg-border); padding: 20px; border-radius: 10px; box-sizing: border-box; text-align: center; }
        .section-title { color: var(--rpg-gold); border-bottom: 1px solid #555; padding-bottom: 5px; margin: 20px 0 10px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 8px; }
        .opt { background: #333; padding: 10px 5px; border: 2px solid #555; cursor: pointer; text-align: center; font-size: 0.8rem; border-radius: 5px; }
        .opt.selected { background: var(--rpg-blue); border-color: #fff; }
        .count-options { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .count-btn { background: #444; color: #fff; border: 2px solid #777; padding: 10px 20px; cursor: pointer; border-radius: 5px; }
        .count-btn.active { background: var(--rpg-red); border-color: #fff; }

        /* „Ç≤„Éº„É†ÁîªÈù¢ */
        #game-screen { display: none; width: 100%; max-width: 500px; }
        #ui-layer { border: 3px solid #fff; padding: 10px; display: flex; justify-content: space-around; background: #000; margin-bottom: 5px; }
        #stage { height: 160px; border: 3px solid #fff; background: #1a1a2e; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        #monster-sprite { font-size: 60px; transition: transform 0.2s; }
        .hp-bar { width: 150px; height: 10px; background: #333; border: 1px solid #fff; margin-top: 10px; }
        #m-hp-fill { height: 100%; background: var(--rpg-red); width: 100%; transition: 0.3s; }
        
        #msg-box { min-height: 50px; border: 3px solid #fff; padding: 10px; background: #000; margin: 10px 0; text-align: center; font-size: 0.9rem; border-left: 8px solid var(--rpg-gold); }
        #ja-text { color: var(--rpg-gold); text-align: center; margin-bottom: 10px; font-weight: bold; }
        .sentence-box { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 20px; }
        .word-unit { padding: 8px 12px; border: 1px solid #777; background: #333; cursor: pointer; border-radius: 4px; }
        .word-unit.selected { background: var(--rpg-red); }

        #input-zone { display: none; text-align: center; padding: 15px; background: #222; border-radius: 8px; }
        #type-input { background: #000; color: #fff; border: 2px solid #fff; padding: 10px; width: 80%; text-align: center; font-size: 1.1rem; }
        .btn { margin-top: 10px; padding: 10px 30px; background: #fff; color: #000; border: none; font-weight: bold; cursor: pointer; }
        
        /* Ëß£Ë™¨„Ç¶„Ç£„É≥„Éâ„Ç¶ */
        #exp-layer { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 400px; background: #000; border: 4px solid var(--rpg-blue); padding: 25px; z-index: 100; box-shadow: 0 0 50px #000; }
        
        .shake { animation: shake 0.3s; }
        @keyframes shake { 0%,100%{transform:translateX(0)} 20%{-10px} 40%{10px} 60%{-10px} 80%{10px} }
        .flash { animation: flash 0.3s; }
        @keyframes flash { 0%,100%{background:var(--rpg-bg)} 50%{background:#500} }
    </style>
</head>
<body>

<div id="setup-screen">
    <h2 style="color:var(--rpg-gold);">GRAMMAR QUEST: 2-CHANCE</h2>
    <div class="section-title">1. ÊñáÊ≥ï„ÇíÈÅ∏ÊäûÔºàË§áÊï∞ÂèØÔºâ</div>
    <div class="grid" id="grammar-grid"></div>
    <div class="section-title">2. ÂïèÈ°åÊï∞„ÇíÈÅ∏Êäû</div>
    <div class="count-options">
        <button class="count-btn" onclick="setCount(5, this)">5Âïè</button>
        <button class="count-btn active" onclick="setCount(10, this)">10Âïè</button>
        <button class="count-btn" onclick="setCount(20, this)">20Âïè</button>
    </div>
    <button class="btn" style="width:100%; padding:15px; margin-top:20px;" onclick="initGame()">ÂÜíÈô∫„ÇíÈñãÂßã„Åô„Çã</button>
</div>

<div id="game-screen">
    <div id="ui-layer">
        <div>PROGRESS: <span id="q-progress">0/0</span></div>
        <div>PLAYER HP: <span id="p-hp" style="color:var(--rpg-red)">50</span>/50</div>
    </div>
    <div id="stage">
        <div id="monster-sprite">üë∫</div>
        <div class="hp-bar"><div id="m-hp-fill"></div></div>
    </div>
    <div id="msg-box">ÈñìÈÅï„ÅÑ„ÅÆÁÆáÊâÄ„Çí„Çø„ÉÉ„ÉÅ„Åõ„ÇàÔºÅ</div>
    <div id="ja-text"></div>
    <div id="sentence-area" class="sentence-box"></div>
    <div id="input-zone">
        <input type="text" id="type-input" autocomplete="off" placeholder="Ê≠£„Åó„ÅÑÁ∂¥„Çä„ÇíÂÖ•Âäõ...">
        <br>
        <button class="btn" onclick="submitAttack()">ATTACK!</button>
    </div>
</div>

<div id="exp-layer">
    <div id="exp-res" style="font-weight:bold; color:var(--rpg-blue); margin-bottom:10px;"></div>
    <p id="exp-text"></p>
    <button class="btn" style="width:100%;" onclick="closeExp()">NEXT ‚ñ∂</button>
</div>

<script>
const db = {
    passive: { name: "„ÄêÂèó„ÅëË∫´„Äë", q: [
        {ja:"„Åì„ÅÆÊâãÁ¥ô„ÅØÊõ∏„Åã„Çå„Åæ„Åó„Åü„ÄÇ", s:["this", "letter", "was", "wrote", "."], t:"wrote", a:"written", e:"Âèó„ÅëË∫´„ÅØ„ÄêbeÂãïË©ûÔºãÈÅéÂéªÂàÜË©û„Äë„ÄÇwrite-wrote-writtenÔºÅ"},
        {ja:"Ëã±Ë™û„ÅØË©±„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ", s:["english", "is", "speak", "."], t:"speak", a:"spoken", e:"speak„ÅÆÈÅéÂéªÂàÜË©û„ÅØspoken„Åß„Åô„ÄÇ"},
        {ja:"„Åù„ÅÆÁ™ì„ÅØÂ£ä„Åï„Çå„Åü„ÄÇ", s:["the", "window", "was", "break", "."], t:"break", a:"broken", e:"break-broken„ÄÇ"}
    ]},
    perfect: { name: "„ÄêÂÆå‰∫ÜÂΩ¢„Äë", q: [
        {ja:"3Âπ¥Èñì‰Ωè„Çì„Åß„ÅÑ„Åæ„Åô„ÄÇ", s:["i", "have", "live", "here", "."], t:"live", a:"lived", e:"haveÔºãÈÅéÂéªÂàÜË©û„ÄÇlived„ÅåÊ≠£Ëß£„ÄÇ"},
        {ja:"„Å°„Çá„ÅÜ„Å©ÁùÄ„ÅÑ„Åü„Å®„Åì„Çç„ÄÇ", s:["he", "has", "just", "arrive", "."], t:"arrive", a:"arrived", e:"ÂÆå‰∫ÜÂΩ¢„ÅØÈÅéÂéªÂàÜË©ûarrived„ÄÇ"},
        {ja:"ÁµÇ„Çè„Çä„Åæ„Åó„Åü„ÅãÔºü", s:["have", "you", "finish", "?"], t:"finish", a:"finished", e:"ÂÆå‰∫ÜÂΩ¢„ÅØÈÅéÂéªÂàÜË©û„Åß„Åô„ÄÇ"}
    ]},
    ing_only: { name: "„Äêing„ÅÆ„ÅøÂãïË©û„Äë", q: [
        {ja:"Ë™≠„ÅøÁµÇ„Åà„Åü„ÄÇ", s:["finished", "to", "read", "."], t:"to", a:"(ÂâäÈô§)", e:"finish„ÅØÂãïÂêçË©ûing„ÅÆ„Åø„ÇíÂæå„Çç„Å´Âèñ„Çä„Åæ„Åô„ÄÇ"},
        {ja:"„ÇÑ„ÇÅ„Å¶„ÄÇ", s:["stop", "to", "watch", "."], t:"to", a:"(ÂâäÈô§)", e:"stop ÔΩûing„Åß„ÄåÔΩû„Åô„Çã„ÅÆ„Çí„ÇÑ„ÇÅ„Çã„Äç„ÄÇ"},
        {ja:"Ê•Ω„Åó„Çì„Å†„ÄÇ", s:["enjoyed", "to", "listen", "."], t:"to", a:"(ÂâäÈô§)", e:"enjoy„ÅØÂãïÂêçË©ûing„ÅÆ„Åø„ÄÇ"}
    ]},
    svoc: { name: "„ÄêSVOÔºãto/ÂéüÂΩ¢„Äë", q: [
        {ja:"ÊéÉÈô§„Åï„Åõ„Åü„ÄÇ", s:["made", "me", "to", "clean", "."], t:"to", a:"(ÂâäÈô§)", e:"‰ΩøÂΩπÂãïË©ûmake„ÅØ„Äê‰∫∫ÔºãÂãïË©û„ÅÆÂéüÂΩ¢„Äë„ÄÇ"},
        {ja:"È†º„Çì„Å†„ÄÇ", s:["asked", "him", "help", "."], t:"help", a:"to help", e:"ask ‰∫∫ to do„ÄÇto„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ"},
        {ja:"Ë®±„Åó„Åü„ÄÇ", s:["allowed", "me", "go", "."], t:"go", a:"to go", e:"allow ‰∫∫ to do„ÄÇto„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ"}
    ]}
    // ... ‰ªñ„ÅÆÊñáÊ≥ï„Éá„Éº„Çø„ÇÇÂêåÊßò„Å´ËøΩÂä†ÂèØËÉΩ
};

let playlist = [], qIdx = 0, mHp = 100, pHp = 50, currentQ = null;
let targetCount = 10, attempts = 0; // Ëß£Á≠îÂõûÊï∞„Ç´„Ç¶„É≥„ÉàÁî®

// „Ç∞„É™„ÉÉ„ÉâÁîüÊàê
const grid = document.getElementById('grammar-grid');
Object.keys(db).forEach(k => {
    const d = document.createElement('div');
    d.className = 'opt'; d.innerText = db[k].name;
    d.onclick = () => d.classList.toggle('selected');
    d.dataset.key = k;
    grid.appendChild(d);
});

function setCount(num, el) {
    targetCount = num;
    document.querySelectorAll('.count-btn').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
}

function initGame() {
    const sel = document.querySelectorAll('.opt.selected');
    if(!sel.length) return alert("ÊñáÊ≥ï„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ");
    let allQ = [];
    sel.forEach(o => allQ.push(...db[o.dataset.key].q));
    allQ.sort(() => Math.random() - 0.5);
    playlist = allQ.slice(0, targetCount);
    document.getElementById('setup-screen').style.display = 'none';
    document.getElementById('game-screen').style.display = 'block';
    loadQuest();
}

function loadQuest() {
    if(qIdx >= playlist.length) { alert("„ÇØ„É™„Ç¢ÔºÅ"); location.reload(); return; }
    currentQ = playlist[qIdx];
    mHp = 100; attempts = 0; // „Ç´„Ç¶„É≥„Éà„É™„Çª„ÉÉ„Éà
    updateUI();
    document.getElementById('ja-text').innerText = "ÂíåË®≥Ôºö" + currentQ.ja;
    document.getElementById('input-zone').style.display = 'none';
    document.getElementById('type-input').value = "";
    document.getElementById('msg-box').innerText = "ÈñìÈÅï„ÅÑ„Çí„Çø„ÉÉ„ÉÅ„Åõ„ÇàÔºÅ";
    const area = document.getElementById('sentence-area');
    area.innerHTML = "";
    currentQ.s.forEach(w => {
        const d = document.createElement('div');
        d.className = 'word-unit'; d.innerText = w;
        d.onclick = () => {
            if(w === currentQ.t) {
                d.classList.add('selected');
                document.getElementById('input-zone').style.display = 'block';
                document.getElementById('type-input').focus();
                document.getElementById('msg-box').innerText = "Ê≠£„Åó„ÅÑÁ∂¥„Çä„ÇíÂÖ•Âäõ„Åõ„ÇàÔºÅ(„ÅÇ„Å®2Âõû)";
            } else {
                pHp -= 2; updateUI(); // „Çø„ÉÉ„ÉÅ„Éü„Çπ„ÅØËªΩÂæÆ„Å™„ÉÄ„É°„Éº„Ç∏
                document.body.classList.add('flash');
                setTimeout(()=>document.body.classList.remove('flash'), 200);
            }
        };
        area.appendChild(d);
    });
}

function submitAttack() {
    const val = document.getElementById('type-input').value.trim().toLowerCase();
    const isCorrect = (val === currentQ.a.toLowerCase() || (currentQ.a === "(ÂâäÈô§)" && val === ""));
    
    if(isCorrect) {
        mHp = 0; 
        document.getElementById('monster-sprite').classList.add('shake');
        confetti({particleCount:100});
        showExp("‚ú® GREAT HIT!", currentQ.e);
    } else {
        attempts++;
        if(attempts < 2) {
            document.getElementById('msg-box').innerText = "MISS! „Åæ„Å†„ÉÅ„É£„É≥„Çπ„ÅØ„ÅÇ„Çã„ÅûÔºÅ(„ÅÇ„Å®1Âõû)";
            document.getElementById('type-input').value = "";
            document.getElementById('type-input').focus();
        } else {
            pHp -= 15;
            showExp("üíÄ FAILED...", `2Âõû„Éü„Çπ„Åó„Åæ„Åó„Åü„ÄÇÊ≠£Ëß£„ÅØ„Äå${currentQ.a}„Äç„Åß„Åô„ÄÇ<br>${currentQ.e}`);
        }
    }
    updateUI();
}

function showExp(res, text) {
    document.getElementById('exp-res').innerText = res;
    document.getElementById('exp-text').innerHTML = text;
    document.getElementById('exp-layer').style.display = 'block';
}

function closeExp() {
    document.getElementById('exp-layer').style.display = 'none';
    document.getElementById('monster-sprite').classList.remove('shake');
    if(pHp <= 0) { alert("ÊïóÂåó..."); location.reload(); }
    else { qIdx++; loadQuest(); }
}

function updateUI() {
    document.getElementById('p-hp').innerText = Math.max(0, pHp);
    document.getElementById('m-hp-fill').style.width = mHp + "%";
    document.getElementById('q-progress').innerText = `${qIdx + 1}/${playlist.length}`;
}
</script>
</body>
</html>
