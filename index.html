<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Grammar Quest: Final Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root { --rpg-bg: #0a0a0a; --rpg-border: #fff; --rpg-red: #ff4757; --rpg-blue: #3498db; --rpg-gold: #eccc68; }
        body { background: var(--rpg-bg); color: #fff; font-family: 'Courier New', monospace; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 10px; }
        #setup-screen { width: 100%; max-width: 850px; background: #1a1a1a; border: 4px solid var(--rpg-border); padding: 20px; border-radius: 10px; text-align: center; box-sizing: border-box; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 10px; margin: 20px 0; }
        .opt { background: #333; padding: 12px 5px; border: 2px solid #555; cursor: pointer; border-radius: 5px; font-size: 0.85rem; }
        .opt.selected { background: var(--rpg-blue); border-color: #fff; }
        #game-screen { display: none; width: 100%; max-width: 600px; text-align: center; }
        #stage { height: 120px; border: 3px solid #fff; background: #1a1a2e; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; font-size: 50px; }
        #msg-box { min-height: 55px; border: 3px solid #fff; padding: 10px; background: #000; margin: 10px 0; border-left: 8px solid var(--rpg-gold); font-weight: bold; font-size: 0.9rem; }
        #ja-text { color: var(--rpg-gold); margin-bottom: 15px; font-size: 1.1rem; font-weight: bold; }
        .card-container { min-height: 60px; border: 2px dashed #444; padding: 15px; margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; background: rgba(255,255,255,0.05); border-radius: 10px; }
        .word-unit, .word-card { padding: 10px 18px; background: #fff; color: #000; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1.1rem; box-shadow: 0 4px #999; }
        .word-unit.selected { background: var(--rpg-red); color: #fff; box-shadow: none; transform: translateY(2px); }
        .word-card.used { opacity: 0.2; pointer-events: none; }
        .answer-word { background: var(--rpg-blue); color: #fff; box-shadow: 0 4px #0056b3; }
        #input-zone { display: none; padding: 20px; background: #222; border-radius: 10px; border: 2px solid var(--rpg-gold); }
        #type-input { background: #000; color: #fff; border: 2px solid var(--rpg-gold); padding: 12px; width: 80%; text-align: center; font-size: 1.3rem; margin-bottom: 10px; }
        .btn { padding: 12px 25px; background: var(--rpg-red); color: #fff; border: 2px solid #fff; font-weight: bold; cursor: pointer; font-size: 1rem; margin: 5px; border-radius: 5px; }
        #exp-layer { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; background: #000; border: 4px solid var(--rpg-blue); padding: 25px; z-index: 100; box-shadow: 0 0 50px #000; }
    </style>
</head>
<body>

<div id="setup-screen">
    <h1 style="color:var(--rpg-gold); margin-top:0;">ENGLISH QUEST</h1>
    <p>ÁøíÂæó„Åó„Åü„ÅÑÊñáÊ≥ï„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
    <div class="grid" id="grammar-grid"></div>
    <button class="btn" style="width:100%; background: var(--rpg-blue); padding: 20px;" onclick="initGame()">ÂÜíÈô∫„ÇíÈñãÂßã„Åô„Çã</button>
</div>

<div id="game-screen">
    <div id="stage">üëπ</div>
    <div id="msg-box"></div>
    <div id="ja-text"></div>
    <div id="sort-ui" style="display:none;"><div id="answer-area" class="card-container"></div><div id="card-pool" class="card-container"></div><button class="btn" style="background:#555" onclick="resetSort()">„ÇÑ„ÇäÁõ¥„Åó</button></div>
    <div id="fix-ui" style="display:none;"><div id="sentence-area" class="card-container"></div><div id="input-zone"><input type="text" id="type-input" autocomplete="off"></div></div>
    <button class="btn" onclick="submitAttack()">ATTACK!</button>
</div>

<div id="exp-layer"><h2 id="exp-res"></h2><p id="exp-text"></p><button class="btn" style="width:100%; background: var(--rpg-blue);" onclick="closeExp()">Ê¨°„Å∏ ‚ñ∂</button></div>

<script>
const db = {
    passive: { name: "Âèó„ÅëË∫´", mode: "fix", q: [{ja:"„Åì„ÅÆÊâãÁ¥ô„ÅØÂÅ•„Å´„Çà„Å£„Å¶Êõ∏„Åã„Çå„Åæ„Åó„Åü„ÄÇ", s:["This", "letter", "was", "wrote", "by", "Ken", "."], t:"wrote", a:"written", e:"Âèó„ÅëË∫´„ÅØ„ÄébeÂãïË©ûÔºãÈÅéÂéªÂàÜË©û„Äè„Åß„Åô„ÄÇ"}]},
    perfect: { name: "ÂÆå‰∫ÜÂΩ¢", mode: "fix", q: [{ja:"ÁßÅ„ÅØ3Âπ¥Èñì„Åö„Å£„Å®„Åì„Åì„Å´‰Ωè„Çì„Åß„ÅÑ„Åæ„Åô„ÄÇ", s:["I", "have", "live", "here", "for", "three", "years", "."], t:"live", a:"lived", e:"ÁèæÂú®ÂÆå‰∫Ü„ÅØ„ÄéhaveÔºãÈÅéÂéªÂàÜË©û„Äè„Åß„Åô„ÄÇ"}]},
    post: { name: "ÂæåÁΩÆ‰øÆÈ£æ(ÂàÜË©û)", mode: "fix", q: [{ja:"„ÅÇ„Åù„Åì„ÅßÊ≠å„Å£„Å¶„ÅÑ„ÇãÂ∞ëÂ•≥„ÅØËä±Â≠ê„Åß„Åô„ÄÇ", s:["The", "girl", "sing", "over", "there", "is", "Hanako", "."], t:"sing", a:"singing", e:"ÂêçË©û„Çí‰øÆÈ£æ„Åô„ÇãÂàÜË©û„ÄÇÈÄ≤Ë°å„ÅÆÊÑèÂë≥„Å™„Çâing„Åß„Åô„ÄÇ"}]},
    rel: { name: "Èñ¢‰øÇ‰ª£ÂêçË©û", mode: "sort", q: [{ja:"„Åì„Çå„ÅØÁßÅ„ÅåÊò®Êó•Ë≤∑„Å£„ÅüÊú¨„Åß„Åô„ÄÇ", a:["This", "is", "the", "book", "which", "I", "bought", "yesterday", "."], e:"ÂÖàË°åË©û„ÅåÁâ©(book)„Å™„ÅÆ„Åßwhich„Çí‰Ωø„ÅÑ„ÄÅÂæå„Çç„Åã„ÇâË™¨Êòé„Åó„Åæ„Åô„ÄÇ"}]},
    prog: { name: "ÈÄ≤Ë°åÂΩ¢", mode: "fix", q: [{ja:"ÂΩº„ÅØ‰ªä„ÄÅÂÖ¨Âúí„ÅßËµ∞„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ", s:["He", "running", "in", "the", "park", "now", "."], t:"running", a:"is running", e:"ÈÄ≤Ë°åÂΩ¢„ÅØbeÂãïË©û„ÇíÂøò„Çå„Å™„ÅÑ„Çà„ÅÜ„Å´„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ"}]},
    ing_only: { name: "ÂãïÂêçË©û(ing)„ÅÆ„Åø", mode: "fix", q: [{ja:"ÂΩº„ÅØ„ÉÜ„É¨„Éì„ÇíË¶ã„Çã„ÅÆ„Çí„ÇÑ„ÇÅ„Åæ„Åó„Åü„ÄÇ", s:["He", "stopped", "to", "watch", "TV", "."], t:"to", a:"(ÂâäÈô§)", e:"stop „Äúing„Åß„Äé„Äú„Åô„Çã„ÅÆ„Çí„ÇÑ„ÇÅ„Çã„Äè„Åß„Åô„ÄÇ"}]},
    to_only: { name: "‰∏çÂÆöË©û(to)„ÅÆ„Åø", mode: "fix", q: [{ja:"ÁßÅ„ÅØÂåªËÄÖ„Å´„Å™„Çä„Åü„ÅÑ„Åß„Åô„ÄÇ", s:["I", "want", "becoming", "a", "doctor", "."], t:"becoming", a:"to be", e:"want„ÅÆÂæå„ÅØto‰∏çÂÆöË©û„ÇíÂèñ„Çä„Åæ„Åô„ÄÇ"}]},
    indirect: { name: "ÈñìÊé•ÁñëÂïèÊñá", mode: "sort", q: [{ja:"ÂΩº„Åå„Å©„Åì„Å´‰Ωè„Çì„Åß„ÅÑ„Çã„ÅãÁü•„Å£„Å¶„ÅÑ„Åæ„Åô„ÅãÔºü", a:["Do", "you", "know", "where", "he", "lives", "?"], e:"ÈñìÊé•ÁñëÂïèÊñá„ÅÆË™ûÈ†Ü„ÅØ„ÄéÁñëÂïèË©ûÔºã‰∏ªË™ûÔºãÂãïË©û„Äè„Åß„Åô„ÄÇ"}]},
    comp: { name: "ÊØîËºÉ", mode: "fix", q: [{ja:"„Åì„ÅÆÊú¨„ÅØ„ÅÇ„ÅÆÊú¨„Çà„ÇäÈù¢ÁôΩ„ÅÑ„ÄÇ", s:["This", "book", "is", "more", "interesting", "as", "that", "one", "."], t:"as", a:"than", e:"ÊØîËºÉÁ¥ö„ÅÆÂæå„ÅØthan„Çí‰Ωø„ÅÑ„Åæ„Åô„ÄÇ"}]},
    modal: { name: "Âä©ÂãïË©û", mode: "fix", q: [{ja:"ÂΩº„ÅØ‰∏äÊâã„Å´Ëã±Ë™û„ÇíË©±„Åõ„Åæ„Åô„ÄÇ", s:["He", "can", "speaks", "English", "well", "."], t:"speaks", a:"speak", e:"Âä©ÂãïË©û(can)„ÅÆÂæå„ÅØÂøÖ„ÅöÂãïË©û„ÅÆÂéüÂΩ¢„Åß„Åô„ÄÇ"}]},
    sub: { name: "‰ªÆÂÆöÊ≥ï", mode: "fix", q: [{ja:"„ÇÇ„ÅóÁßÅ„ÅåÈ≥•„Å™„Çâ„ÄÅÈ£õ„Çì„Åß„ÅÑ„Åè„ÅÆ„Å´„ÄÇ", s:["If", "I", "am", "a", "bird", ",", "I", "could", "fly", "."], t:"am", a:"were", e:"‰ªÆÂÆöÊ≥ï„ÅÆIfÁØÄ„Åß„ÅØam/is„Åß„ÅØ„Å™„Åèwere„Çí‰Ωø„ÅÑ„Åæ„Åô„ÄÇ"}]},
    svoc: { name: "‰ΩøÂΩπ(makeÁ≠â)", mode: "fix", q: [{ja:"Áà∂„ÅØÁßÅ„Å´ÈÉ®Â±ã„ÇíÊéÉÈô§„Åï„Åõ„Åü„ÄÇ", s:["My", "father", "made", "me", "to", "clean", "the", "room", "."], t:"to", a:"(ÂâäÈô§)", e:"‰ΩøÂΩπÂãïË©ûmake„ÅØ„Äé‰∫∫ÔºãÂéüÂΩ¢„Äè„Åß„Åô„ÄÇ"}]},
    itfor: { name: "ÂΩ¢Âºè‰∏ªË™ûIt", mode: "sort", q: [{ja:"ÁßÅ„Å´„Å®„Å£„Å¶Ëã±Ë™û„ÇíË©±„Åô„ÅÆ„ÅØÈõ£„Åó„ÅÑ„ÄÇ", a:["It", "is", "difficult", "for", "me", "to", "speak", "English", "."], e:"„ÄéIt is „Äú for ‰∫∫ to ...„Äè„ÅÆÊßãÊñá„Åß„Åô„ÄÇ"}]},
    too_to: { name: "too..to", mode: "fix", q: [{ja:"ÂΩº„ÅØËã•„Åô„Åé„Å¶„Åù„ÅÆ‰ªï‰∫ã„ÅØ„Åß„Åç„Åæ„Åõ„Çì„ÄÇ", s:["He", "is", "too", "young", "working", "."], t:"working", a:"to work", e:"too „Äú to ÂéüÂΩ¢„Åß„Äé„ÅÇ„Åæ„Çä„Å´„Äú„Åß...„Åß„Åç„Å™„ÅÑ„Äè„Åß„Åô„ÄÇ"}]},
    tag: { name: "‰ªòÂä†ÁñëÂïè", mode: "fix", q: [{ja:"ÂΩº„ÅØË¶™Âàá„Åß„Åô„Çà„Å≠Ôºü", s:["He", "is", "kind", ",", "isn't", "is", "?"], t:"is", a:"he", e:"‰ªòÂä†ÁñëÂïè„ÅØ‰ª£ÂêçË©û„ÅßÁπ∞„ÇäËøî„Åó„Åæ„Åô„ÄÇ"}]},
    exclam: { name: "ÊÑüÂòÜÊñá", mode: "sort", q: [{ja:"„Å™„Çì„Å¶Áæé„Åó„ÅÑËä±„Å™„Çì„Å†„Çç„ÅÜÔºÅ", a:["What", "a", "beautiful", "flower", "this", "is", "!"], e:"ÊÑüÂòÜÊñá„ÅÆÊúÄÂæå„ÅØ„Äé‰∏ªË™ûÔºãÂãïË©û„Äè„ÅßÁ∑†„ÇÅ„Åæ„Åô„ÄÇ"}]},
    give: { name: "Êéà‰∏éÂãïË©û(giveÁ≠â)", mode: "sort", q: [{ja:"ÂΩº„ÅØÁßÅ„Å´„Åù„ÅÆÊú¨„Çí„Åè„Çå„Åæ„Åó„Åü„ÄÇ", a:["He", "gave", "the", "book", "to", "me", "."], e:"gave Áâ© to ‰∫∫ „ÅÆË™ûÈ†Ü„Åß„Åô„ÄÇ"}]},
    inf_d: { name: "‰∏çÂÆöË©û/ÂãïÂêçË©û", mode: "fix", q: [{ja:"„ÉÜ„Éã„Çπ„Çí„Åô„Çã„Åì„Å®„ÅØÊ•Ω„Åó„ÅÑ„ÄÇ", s:["Play", "tennis", "is", "fun", "."], t:"Play", a:"Playing", e:"ÊñáÈ†≠„Çí‰∏ªË™û„Å´„Åô„Çã„Å™„ÇâÂãïÂêçË©û„Åã‰∏çÂÆöË©û„Å´„Åó„Åæ„Åô„ÄÇ"}]}
};

let playlist = [], qIdx = 0, currentQ = null, userAns = [], attempts = 0, selectedWrongWord = null;
const grid = document.getElementById('grammar-grid');
Object.keys(db).forEach(k => {
    const d = document.createElement('div'); d.className = 'opt'; d.innerText = db[k].name;
    d.onclick = () => d.classList.toggle('selected'); d.dataset.key = k; grid.appendChild(d);
});
function initGame() {
    const sel = document.querySelectorAll('.opt.selected');
    if(!sel.length) return alert("È†ÖÁõÆ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
    sel.forEach(o => { const cat = db[o.dataset.key]; cat.q.forEach(q => { q.mode = cat.mode; playlist.push(q); }); });
    playlist.sort(() => Math.random() - 0.5);
    document.getElementById('setup-screen').style.display = 'none';
    document.getElementById('game-screen').style.display = 'block';
    loadQuest();
}
function loadQuest() {
    if(qIdx >= playlist.length) { alert("ÂÖ®„ÇØ„Ç®„Çπ„Éà„ÇØ„É™„Ç¢ÔºÅ"); location.reload(); return; }
    currentQ = playlist[qIdx]; attempts = 0; userAns = []; selectedWrongWord = null;
    document.getElementById('ja-text').innerText = currentQ.ja;
    document.getElementById('fix-ui').style.display = "none";
    document.getElementById('sort-ui').style.display = "none";
    document.getElementById('input-zone').style.display = "none";
    if(currentQ.mode === "sort") {
        document.getElementById('msg-box').innerText = "„Äê‰∏¶„Å≥Êõø„Åà„Äë„Ç´„Éº„Éâ„ÇíÊ≠£Ëß£„ÅÆÈ†Ü„Å´ÈÅ∏„Çì„ÅßÔºÅ";
        document.getElementById('sort-ui').style.display = "block";
        renderSort();
    } else {
        document.getElementById('msg-box').innerText = "„ÄêÈñìÈÅï„ÅÑÊé¢„Åó„Äë„Åä„Åã„Åó„Å™ÂçòË™û„ÇíÈÅ∏„Çì„ÅßÁõ¥„Åó„Å¶ÔºÅ";
        document.getElementById('fix-ui').style.display = "block";
        renderFix();
    }
}
function renderSort() {
    const pool = document.getElementById('card-pool'); pool.innerHTML = "";
    document.getElementById('answer-area').innerHTML = "";
    [...currentQ.a].sort(() => Math.random() - 0.5).forEach(w => {
        const card = document.createElement('div'); card.className = 'word-card'; card.innerText = w;
        card.onclick = () => {
            userAns.push(w); card.classList.add('used');
            const ac = document.createElement('div'); ac.className = 'word-card answer-word'; ac.innerText = w;
            document.getElementById('answer-area').appendChild(ac);
        }; pool.appendChild(card);
    });
}
function resetSort() {
    userAns = []; document.getElementById('answer-area').innerHTML = "";
    document.querySelectorAll('.word-card').forEach(c => c.classList.remove('used'));
}
function renderFix() {
    const area = document.getElementById('sentence-area'); area.innerHTML = "";
    currentQ.s.forEach(w => {
        const d = document.createElement('div'); d.className = 'word-unit'; d.innerText = w;
        d.onclick = () => {
            if(w === currentQ.t) {
                document.querySelectorAll('.word-unit').forEach(u => u.classList.remove('selected'));
                d.classList.add('selected'); selectedWrongWord = w;
                document.getElementById('input-zone').style.display = 'block';
                document.getElementById('type-input').value = ""; document.getElementById('type-input').focus();
            }
        }; area.appendChild(d);
    });
}
function submitAttack() {
    let ok = false;
    if(currentQ.mode === "sort") { ok = JSON.stringify(userAns) === JSON.stringify(currentQ.a); }
    else { ok = (selectedWrongWord === currentQ.t && (document.getElementById('type-input').value.trim().toLowerCase() === currentQ.a.toLowerCase() || (currentQ.a === "(ÂâäÈô§)" && document.getElementById('type-input').value === ""))); }
    if(ok) { confetti({particleCount: 150}); showExp("‚ú® SUCCESS!", currentQ.e); }
    else {
        attempts++;
        if(attempts < 2) { document.getElementById('msg-box').innerText = "MISS! „Åæ„Å†ÂÄí„Åõ„Å™„ÅÑÔºÅ„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÔºÅ"; if(currentQ.mode === "sort") resetSort(); }
        else { showExp("üíÄ FAILURE...", `Ê≠£Ëß£: ${currentQ.mode==="sort" ? currentQ.a.join(" ") : currentQ.a}<br>${currentQ.e}`); }
    }
}
function showExp(res, text) {
    document.getElementById('exp-res').innerText = res; document.getElementById('exp-text').innerHTML = text;
    document.getElementById('exp-layer').style.display = 'block';
}
function closeExp() {
    document.getElementById('exp-layer').style.display = 'none';
    qIdx++; loadQuest();
}
</script>
</body>
</html>
