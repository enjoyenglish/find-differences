<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Grammar Quest: Grand Master</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root { --rpg-bg: #0a0a0a; --rpg-border: #fff; --rpg-red: #ff4757; --rpg-blue: #3498db; --rpg-gold: #eccc68; }
        body { background: var(--rpg-bg); color: #fff; font-family: 'Courier New', monospace; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 10px; overflow-x: hidden; }
        
        #setup-screen { width: 100%; max-width: 800px; background: #1a1a1a; border: 4px solid var(--rpg-border); padding: 20px; border-radius: 10px; box-sizing: border-box; text-align: center; }
        .section-title { color: var(--rpg-gold); border-bottom: 1px solid #555; padding-bottom: 5px; margin: 20px 0 10px; font-weight: bold; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; }
        .opt { background: #333; padding: 12px 5px; border: 2px solid #555; cursor: pointer; text-align: center; font-size: 0.85rem; border-radius: 5px; transition: 0.2s; }
        .opt.selected { background: var(--rpg-blue); border-color: #fff; transform: scale(1.02); }
        .count-options { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .count-btn { background: #444; color: #fff; border: 2px solid #777; padding: 10px 20px; cursor: pointer; border-radius: 5px; }
        .count-btn.active { background: var(--rpg-red); border-color: #fff; }

        #game-screen { display: none; width: 100%; max-width: 500px; }
        #ui-layer { border: 3px solid #fff; padding: 10px; display: flex; justify-content: space-around; background: #000; margin-bottom: 5px; }
        #stage { height: 160px; border: 3px solid #fff; background: #1a1a2e; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        #monster-sprite { font-size: 60px; transition: 0.2s; }
        .hp-bar { width: 150px; height: 10px; background: #333; border: 1px solid #fff; margin-top: 10px; }
        #m-hp-fill { height: 100%; background: var(--rpg-red); width: 100%; transition: 0.3s; }
        
        #msg-box { min-height: 50px; border: 3px solid #fff; padding: 10px; background: #000; margin: 10px 0; text-align: center; font-size: 0.9rem; border-left: 8px solid var(--rpg-gold); }
        #ja-text { color: var(--rpg-gold); text-align: center; margin-bottom: 10px; font-weight: bold; }
        .sentence-box { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 20px; }
        .word-unit { padding: 8px 12px; border: 1px solid #777; background: #333; cursor: pointer; border-radius: 4px; font-size: 1.1rem; }
        .word-unit.selected { background: var(--rpg-red); }

        #input-zone { display: none; text-align: center; padding: 15px; background: #222; border-radius: 8px; }
        #type-input { background: #000; color: #fff; border: 2px solid #fff; padding: 10px; width: 85%; text-align: center; font-size: 1.2rem; }
        .btn { margin-top: 10px; padding: 10px 30px; background: #fff; color: #000; border: none; font-weight: bold; cursor: pointer; }
        
        #exp-layer { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 95%; max-width: 450px; background: #000; border: 4px solid var(--rpg-blue); padding: 25px; z-index: 100; box-shadow: 0 0 50px #000; }
        .shake { animation: shake 0.3s; }
        @keyframes shake { 0%,100%{transform:translateX(0)} 20%{-10px} 40%{10px} 60%{-10px} 80%{10px} }
        .flash { animation: flash 0.3s; }
        @keyframes flash { 0%,100%{background:var(--rpg-bg)} 50%{background:#500} }
    </style>
</head>
<body>

<div id="setup-screen">
    <h1 style="color:var(--rpg-gold); margin:0;">GRAMMAR QUEST</h1>
    
    <div class="section-title">1. ÊñáÊ≥ï„ÇíÈÅ∏ÊäûÔºàË§áÊï∞ÈÅ∏ÊäûÂèØÔºâ</div>
    <div class="grid" id="grammar-grid"></div>

    <div class="section-title">2. ÂïèÈ°åÊï∞„ÇíÈÅ∏Êäû</div>
    <div class="count-options">
        <button class="count-btn" onclick="setCount(5, this)">5Âïè</button>
        <button class="count-btn active" onclick="setCount(10, this)">10Âïè</button>
        <button class="count-btn" onclick="setCount(20, this)">20Âïè</button>
        <button class="count-btn" onclick="setCount(999, this)">ÂÖ®Âïè</button>
    </div>

    <button class="btn" style="width:100%; padding:18px; font-size:1.2rem; margin-top:15px;" onclick="initGame()">ÂÜíÈô∫„ÇíÈñãÂßã„Åô„Çã</button>
</div>

<div id="game-screen">
    <div id="ui-layer">
        <div>QUEST: <span id="q-progress">0/0</span></div>
        <div>PLAYER HP: <span id="p-hp" style="color:var(--rpg-red)">50</span>/50</div>
    </div>
    <div id="stage">
        <div id="monster-sprite">üêâ</div>
        <div class="hp-bar"><div id="m-hp-fill"></div></div>
    </div>
    <div id="msg-box">ÈñìÈÅï„ÅÑ„Çí„Çø„ÉÉ„ÉÅ„Åõ„ÇàÔºÅ</div>
    <div id="ja-text"></div>
    <div id="sentence-area" class="sentence-box"></div>
    <div id="input-zone">
        <input type="text" id="type-input" autocomplete="off" placeholder="...">
        <br>
        <button class="btn" onclick="submitAttack()">ATTACK!</button>
    </div>
</div>

<div id="exp-layer">
    <div id="exp-res" style="font-weight:bold; color:var(--rpg-blue); margin-bottom:10px;"></div>
    <p id="exp-text" style="line-height:1.6;"></p>
    <button class="btn" style="width:100%;" onclick="closeExp()">NEXT ‚ñ∂</button>
</div>

<script>
const db = {
    passive: { name: "Âèó„ÅëË∫´", q: [
        {ja:"„Åì„ÅÆÊâãÁ¥ô„ÅØÂÅ•„Å´„Çà„Å£„Å¶Êõ∏„Åã„Çå„Åæ„Åó„Åü„ÄÇ", s:["This", "letter", "was", "wrote", "by", "Ken", "."], t:"wrote", a:"written", e:"Âèó„ÅëË∫´„ÅØ„ÄêbeÂãïË©ûÔºãÈÅéÂéªÂàÜË©û„Äë„ÄÇwrite„ÅÆÈÅéÂéªÂàÜË©û„ÅØwritten„Åß„Åô„ÄÇ"},
        {ja:"Ëã±Ë™û„ÅØÂ§ö„Åè„ÅÆÂõΩ„ÅßË©±„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ", s:["English", "is", "speak", "in", "many", "countries", "."], t:"speak", a:"spoken", e:"speak„ÅÆÈÅéÂéªÂàÜË©û„ÅØspoken„Åß„Åô„ÄÇ"},
        {ja:"„Åù„ÅÆÂØ∫„ÅØ100Âπ¥Ââç„Å´Âª∫„Å¶„Çâ„Çå„Åæ„Åó„Åü„ÄÇ", s:["The", "temple", "was", "build", "100", "years", "ago", "."], t:"build", a:"built", e:"build„ÅÆÈÅéÂéªÂàÜË©û„ÅØbuilt„Åß„Åô„ÄÇ"}
    ]},
    perfect: { name: "ÂÆå‰∫ÜÂΩ¢", q: [
        {ja:"ÁßÅ„ÅØ3Âπ¥Èñì„Åö„Å£„Å®„ÉÜ„Éã„Çπ„Çí„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ", s:["I", "have", "play", "tennis", "for", "three", "years", "."], t:"play", a:"played", e:"ÁèæÂú®ÂÆå‰∫Ü„ÅØ„ÄêhaveÔºãÈÅéÂéªÂàÜË©û„Äë„ÄÇ"},
        {ja:"ÂΩº„ÅØ„Å°„Çá„ÅÜ„Å©ÈßÖ„Å´ÁùÄ„ÅÑ„Åü„Å®„Åì„Çç„Åß„Åô„ÄÇ", s:["He", "has", "just", "arrive", "at", "the", "station", "."], t:"arrive", a:"arrived", e:"ÂÆå‰∫Ü„ÅÆÊÑèÂë≥„Åß„ÇÇÈÅéÂéªÂàÜË©û„Çí‰Ωø„ÅÑ„Åæ„Åô„ÄÇ"},
        {ja:"„ÅÇ„Å™„Åü„ÅØ„ÇÇ„ÅÜÂÆøÈ°å„ÇíÁµÇ„Åà„Åæ„Åó„Åü„ÅãÔºü", s:["Have", "you", "finish", "your", "homework", "yet", "?"], t:"finish", a:"finished", e:"ÁñëÂïèÊñá„Åß„ÇÇhave...ÈÅéÂéªÂàÜË©û„ÅÆÂΩ¢„Åß„Åô„ÄÇ"}
    ]},
    post: { name: "ÂæåÁΩÆ‰øÆÈ£æ(ÂàÜË©û)", q: [
        {ja:"Âêë„Åì„ÅÜ„ÅßÊ≠å„Å£„Å¶„ÅÑ„ÇãÂ•≥„ÅÆÂ≠ê„ÅØËä±Â≠ê„Åß„Åô„ÄÇ", s:["The", "girl", "sing", "over", "there", "is", "Hanako", "."], t:"sing", a:"singing", e:"„ÄåÊ≠å„Å£„Å¶„ÅÑ„ÇãÂ•≥„ÅÆÂ≠ê„Äç„ÅØÁèæÂú®ÂàÜË©ûsinging„Åß‰øÆÈ£æ„Åó„Åæ„Åô„ÄÇ"},
        {ja:"„Åì„Çå„ÅØÊó•Êú¨„Åß‰Ωú„Çâ„Çå„ÅüËªä„Åß„Åô„ÄÇ", s:["This", "is", "a", "car", "make", "in", "Japan", "."], t:"make", a:"made", e:"„Äå‰Ωú„Çâ„Çå„ÅüËªä„Äç„ÅØÈÅéÂéªÂàÜË©ûmade„Åß‰øÆÈ£æ„Åó„Åæ„Åô„ÄÇ"}
    ]},
    rel: { name: "Èñ¢‰øÇ‰ª£ÂêçË©û", q: [
        {ja:"„Åì„Çå„ÅØÁßÅ„ÅåÊò®Êó•Ë≤∑„Å£„ÅüÊú¨„Åß„Åô„ÄÇ", s:["This", "is", "the", "book", "who", "I", "bought", "."], t:"who", a:"which", e:"ÂÖàË°åË©û„Åå„ÄåÁâ©(book)„Äç„Å™„ÅÆ„Åßwhich„Çí‰Ωø„ÅÑ„Åæ„Åô„ÄÇ"},
        {ja:"„ÅÇ„Åù„Åì„ÅßËµ∞„Å£„Å¶„ÅÑ„ÇãÂ∞ëÂπ¥„ÇíË¶ã„Å¶„ÄÇ", s:["Look", "at", "the", "boy", "which", "is", "running", "."], t:"which", a:"who", e:"ÂÖàË°åË©û„Åå„Äå‰∫∫(boy)„Äç„Å™„ÅÆ„Åßwho„Çí‰Ωø„ÅÑ„Åæ„Åô„ÄÇ"}
    ]},
    prog: { name: "ÈÄ≤Ë°åÂΩ¢", q: [
        {ja:"ÂΩº„ÅØ‰ªä„ÄÅËµ∞„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ", s:["He", "running", "now", "."], t:"running", a:"is running", e:"ÈÄ≤Ë°åÂΩ¢„ÅØbeÂãïË©û„ÇíÂøò„Çå„Åö„Å´ÔºÅ"},
        {ja:"ÂΩº„Çâ„ÅØÂÖ¨Âúí„ÅßÊ≥≥„ÅÑ„Åß„ÅÑ„Åæ„Åô„ÄÇ", s:["They", "are", "swim", "in", "the", "park", "."], t:"swim", a:"swimming", e:"swim„ÅØm„ÇíÈáç„Å≠„Å¶swimming„Å´„Å™„Çä„Åæ„Åô„ÄÇ"}
    ]},
    ing_only: { name: "ÂãïÂêçË©û„ÅÆ„Åø(ing)", q: [
        {ja:"ÁßÅ„ÅØ„Åù„ÅÆÊú¨„ÇíË™≠„ÅøÁµÇ„Åà„Åü„ÄÇ", s:["I", "finished", "to", "read", "the", "book", "."], t:"to", a:"(ÂâäÈô§)", e:"finish„ÅÆÂæå„ÅØÂãïÂêçË©û(reading)„ÅÆ„Åø„ÇíÂèñ„Çä„Åæ„Åô„ÄÇ"},
        {ja:"„ÉÜ„É¨„Éì„ÇíË¶ã„Çã„ÅÆ„Çí„ÇÑ„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", s:["Please", "stop", "to", "watch", "TV", "."], t:"to", a:"(ÂâäÈô§)", e:"stop ÔΩûing„Åß„ÄåÔΩû„Åô„Çã„ÅÆ„Çí„ÇÑ„ÇÅ„Çã„Äç„Åß„Åô„ÄÇ"},
        {ja:"ÁßÅ„ÅØÈü≥Ê•Ω„ÇíËÅ¥„Åè„ÅÆ„ÇíÊ•Ω„Åó„Åø„Åæ„Åó„Åü„ÄÇ", s:["I", "enjoyed", "to", "listen", "to", "music", "."], t:"to", a:"(ÂâäÈô§)", e:"enjoy„ÇÇÂãïÂêçË©û„ÅÆ„Åø„ÇíÂèñ„ÇãÂãïË©û„Åß„Åô„ÄÇ"}
    ]},
    to_only: { name: "‰∏çÂÆöË©û„ÅÆ„Åø(to)", q: [
        {ja:"ÁßÅ„ÅØÂåªËÄÖ„Å´„Å™„Çä„Åü„ÅÑ„ÄÇ", s:["I", "want", "becoming", "a", "doctor", "."], t:"becoming", a:"to be", e:"want„ÅØto‰∏çÂÆöË©û„ÇíÂæå„Çç„Å´Âèñ„Çä„Åæ„Åô„ÄÇ"},
        {ja:"ÂΩº„ÅØ„Åù„Åì„Å∏Ë°å„Åè„Åì„Å®„ÇíÊ±∫„ÇÅ„Åü„ÄÇ", s:["He", "decided", "going", "there", "."], t:"going", a:"to go", e:"decide„ÅØto‰∏çÂÆöË©û„ÅÆ„Åø„ÇíÂèñ„ÇãÂãïË©û„Åß„Åô„ÄÇ"}
    ]},
    indirect: { name: "ÈñìÊé•ÁñëÂïèÊñá", q: [
        {ja:"ÂΩº„Åå„Å©„Åì„Å´‰Ωè„Çì„Åß„ÅÑ„Çã„ÅãÁü•„Å£„Å¶„ÅÑ„Åæ„Åô„ÅãÔºü", s:["Do", "you", "know", "where", "does", "he", "live", "?"], t:"does", a:"(ÂâäÈô§)", e:"ÈñìÊé•ÁñëÂïèÊñá„ÅØ„ÄåÁñëÂïèË©ûÔºã‰∏ªË™ûÔºãÂãïË©û„Äç„ÅÆË™ûÈ†Ü„Åß„Åô„ÄÇ"},
        {ja:"ÂΩºÂ•≥„Åå‰Ωï„Å®Ë®Ä„Å£„Åü„ÅãÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", s:["Please", "tell", "me", "what", "did", "she", "say", "."], t:"did", a:"(ÂâäÈô§)", e:"what she said„ÅÆË™ûÈ†Ü„Å´„Åó„Åæ„Åô„ÄÇ"}
    ]},
    comp: { name: "ÊØîËºÉ", q: [
        {ja:"„Åì„ÅÆÊú¨„ÅØ„ÅÇ„ÅÆÊú¨„Çà„ÇäÈù¢ÁôΩ„ÅÑ„ÄÇ", s:["This", "book", "is", "more", "interesting", "as", "that", "one", "."], t:"as", a:"than", e:"ÊØîËºÉÁ¥ö„ÅÆÂæå„ÅØthan„Çí‰Ωø„ÅÑ„Åæ„Åô„ÄÇ"},
        {ja:"ÂΩº„ÅØ„ÇØ„É©„Çπ„Åß‰∏ÄÁï™ËÉå„ÅåÈ´ò„ÅÑ„ÄÇ", s:["He", "is", "the", "tallest", "of", "the", "class", "."], t:"of", a:"in", e:"ÁØÑÂõ≤(„ÇØ„É©„Çπ„Å™„Å©)„ÇíË°®„Åô„Å®„Åç„ÅØin„Çí‰Ωø„ÅÑ„Åæ„Åô„ÄÇ"}
    ]},
    modal: { name: "Âä©ÂãïË©û", q: [
        {ja:"ÂΩº„ÅØËã±Ë™û„ÇíË©±„Åô„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ", s:["He", "can", "speaks", "English", "."], t:"speaks", a:"speak", e:"Âä©ÂãïË©û(can)„ÅÆÂæå„ÅØÂøÖ„ÅöÂãïË©û„ÅÆÂéüÂΩ¢„Åß„Åô„ÄÇ"},
        {ja:"ÁßÅ„ÅØÊòéÊó•„ÄÅÂøô„Åó„ÅÑ„Åß„Åó„Çá„ÅÜ„ÄÇ", s:["I", "will", "am", "busy", "tomorrow", "."], t:"am", a:"be", e:"will„ÅÆÂæå„ÅØbeÂãïË©û„ÅÆÂéüÂΩ¢be„Å´„Åó„Åæ„Åô„ÄÇ"}
    ]},
    sub: { name: "‰ªÆÂÆöÊ≥ï", q: [
        {ja:"„ÇÇ„ÅóÁßÅ„ÅåÈ≥•„Å™„Çâ„ÄÅÈ£õ„Çì„Åß„ÅÑ„Åè„ÅÆ„Å´„ÄÇ", s:["If", "I", "am", "a", "bird", ",", "I", "would", "fly", "."], t:"am", a:"were", e:"‰ªÆÂÆöÊ≥ïÈÅéÂéª„Åß„ÅØwere„Çí‰Ωø„ÅÑ„Åæ„Åô„ÄÇ"},
        {ja:"„ÇÇ„Å£„Å®„ÅäÈáë„Åå„ÅÇ„Çå„Å∞„ÅÑ„ÅÑ„ÅÆ„Å´„Å™„ÅÇ„ÄÇ", s:["I", "wish", "I", "have", "more", "money", "."], t:"have", a:"had", e:"I wish ... „ÅÆÂæå„ÅØÈÅéÂéªÂΩ¢„ÅßÁèæÂú®„ÅÆÈ°òÊúõ„ÇíË°®„Åó„Åæ„Åô„ÄÇ"}
    ]},
    svoc: { name: "SVO+to/ÂéüÂΩ¢", q: [
        {ja:"ÊØç„ÅØÁßÅ„Å´ÈÉ®Â±ã„ÇíÊéÉÈô§„Åï„Åõ„Åü„ÄÇ", s:["My", "mother", "made", "me", "to", "clean", "the", "room", "."], t:"to", a:"(ÂâäÈô§)", e:"‰ΩøÂΩπÂãïË©ûmake„ÅØ„Äê‰∫∫ÔºãÂãïË©û„ÅÆÂéüÂΩ¢„Äë„Åß„Åô„ÄÇ"},
        {ja:"ÁßÅ„ÅØÂΩº„Å´Êâã‰ºù„Å£„Å¶„Åè„Çå„Çã„Çà„ÅÜÈ†º„Çì„Å†„ÄÇ", s:["I", "asked", "him", "help", "me", "."], t:"help", a:"to help", e:"ask ‰∫∫ to do„ÄÇto„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ"}
    ]},
    itfor: { name: "ÂΩ¢Âºè‰∏ªË™ûIt", q: [
        {ja:"ÁßÅ„Å´„Å®„Å£„Å¶Ëã±Ë™û„ÇíË©±„Åô„ÅÆ„ÅØÈõ£„Åó„ÅÑ„ÄÇ", s:["It", "is", "difficult", "of", "me", "to", "speak", "English", "."], t:"of", a:"for", e:"It is ... for ‰∫∫ to ÔΩû„ÅÆÂΩ¢„Åß„Åô„ÄÇ"},
        {ja:"ÂΩº„Å´„Å®„Å£„Å¶Ëµ∞„Çã„Åì„Å®„ÅØÁ∞°Âçò„Å†„ÄÇ", s:["It", "is", "easy", "for", "him", "running", "."], t:"running", a:"to run", e:"It is ÔΩû to ÂéüÂΩ¢„ÅÆÂΩ¢„Å´„Åó„Åæ„Åô„ÄÇ"}
    ]},
    too_to: { name: "too..to/enough", q: [
        {ja:"ÂΩº„ÅØËã•„Åô„Åé„Å¶ÂÉç„Åë„Å™„ÅÑ„ÄÇ", s:["He", "is", "too", "young", "working", "."], t:"working", a:"to work", e:"too ÔΩû to ÂéüÂΩ¢„Åß„Äå„ÅÇ„Åæ„Çä„Å´ÔΩû„ÅßÔΩû„Åß„Åç„Å™„ÅÑ„Äç„ÄÇ"}
    ]},
    tag: { name: "‰ªòÂä†ÁñëÂïèÊñá", q: [
        {ja:"ÂΩº„ÅØË¶™Âàá„Åß„Åô„Çà„Å≠Ôºü", s:["He", "is", "kind", ",", "isn't", "is", "?"], t:"is", a:"he", e:"‰ªòÂä†ÁñëÂïè„ÅØ‰ª£ÂêçË©û„ÇíÁπ∞„ÇäËøî„Åó„Åæ„Åô„ÄÇ"}
    ]},
    exclam: { name: "ÊÑüÂòÜÊñá", q: [
        {ja:"„Å™„Çì„Å¶Áæé„Åó„ÅÑËä±„Å™„Çì„Å†ÔºÅ", s:["What", "a", "beautiful", "flower", "is", "this", "!"], t:"is this", a:"this is", e:"ÊÑüÂòÜÊñá„ÅÆÊúÄÂæå„ÅØ„Äå‰∏ªË™ûÔºãÂãïË©û„Äç„Åß„Åô„ÄÇ"}
    ]},
    give: { name: "Êéà‰∏éÂãïË©û", q: [
        {ja:"ÂΩº„ÅØÁßÅ„Å´Êú¨„Çí„Åè„Çå„Åü„ÄÇ", s:["He", "gave", "a", "book", "me", "."], t:"me", a:"to me", e:"gave Áâ© to ‰∫∫„ÅÆË™ûÈ†Ü„Åß„Åô„ÄÇ"},
        {ja:"Áà∂„ÅØÁßÅ„Å´„Ç±„Éº„Ç≠„Çí‰Ωú„Å£„Å¶„Åè„Çå„Åü„ÄÇ", s:["Father", "made", "a", "cake", "to", "me", "."], t:"to", a:"for", e:"make„ÅØto„Åß„ÅØ„Å™„Åèfor„Çí‰Ωø„ÅÑ„Åæ„Åô„ÄÇ"}
    ]},
    inf_d: { name: "‰∏çÂÆöË©û/ÂãïÂêçË©û", q: [
        {ja:"ÁßÅ„ÅØ„ÉÜ„Éã„Çπ„Çí„Åô„Çã„Åì„Å®„ÅåÂ•Ω„Åç„Åß„Åô„ÄÇ", s:["I", "like", "play", "tennis", "."], t:"play", a:"playing", e:"like„ÅÆÂæå„ÅØdoing„Åæ„Åü„ÅØto do„ÄÇ"}
    ]}
};

let playlist = [], qIdx = 0, mHp = 100, pHp = 50, currentQ = null;
let targetCount = 10, attempts = 0;

// ÂàùÊúüÂåñÔºöÊñáÊ≥ï„Éú„Çø„É≥ÁîüÊàê
const grid = document.getElementById('grammar-grid');
Object.keys(db).forEach(k => {
    const d = document.createElement('div');
    d.className = 'opt'; d.innerText = db[k].name;
    d.onclick = () => d.classList.toggle('selected');
    d.dataset.key = k;
    grid.appendChild(d);
});

function setCount(num, el) {
    targetCount = num;
    document.querySelectorAll('.count-btn').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
}

function initGame() {
    const sel = document.querySelectorAll('.opt.selected');
    if(!sel.length) return alert("ÊñáÊ≥ï„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ");
    let allQ = [];
    sel.forEach(o => allQ.push(...db[o.dataset.key].q));
    allQ.sort(() => Math.random() - 0.5);
    playlist = allQ.slice(0, targetCount);
    
    document.getElementById('setup-screen').style.display = 'none';
    document.getElementById('game-screen').style.display = 'block';
    loadQuest();
}

function loadQuest() {
    if(qIdx >= playlist.length) { 
        confetti({particleCount:150, spread:70});
        alert("QUEST CLEAR! ÂÖ®„Å¶„ÅÆË™≤È°å„ÇíÈÅîÊàê„Åó„Åæ„Åó„Åü„ÄÇ"); 
        location.reload(); 
        return; 
    }
    currentQ = playlist[qIdx];
    mHp = 100; attempts = 0;
    updateUI();
    document.getElementById('ja-text').innerText = "ÂíåË®≥Ôºö" + currentQ.ja;
    document.getElementById('input-zone').style.display = 'none';
    document.getElementById('type-input').value = "";
    document.getElementById('msg-box').innerText = "ÈñìÈÅï„ÅÑ„ÅÆÁÆáÊâÄ„Çí„Çø„ÉÉ„ÉÅ„Åõ„ÇàÔºÅ";
    
    const area = document.getElementById('sentence-area');
    area.innerHTML = "";
    currentQ.s.forEach(w => {
        const d = document.createElement('div');
        d.className = 'word-unit'; d.innerText = w;
        d.onclick = () => {
            if(w === currentQ.t) {
                d.classList.add('selected');
                document.getElementById('input-zone').style.display = 'block';
                document.getElementById('type-input').focus();
                document.getElementById('msg-box').innerText = "Ê≠£„Åó„ÅÑÁ∂¥„Çä„ÇíÂÖ•Âäõ„Åõ„ÇàÔºÅ(„ÉÅ„É£„É≥„Çπ2Âõû)";
            } else {
                pHp -= 2; updateUI();
                document.body.classList.add('flash');
                setTimeout(()=>document.body.classList.remove('flash'), 200);
            }
        };
        area.appendChild(d);
    });
}

function submitAttack() {
    const val = document.getElementById('type-input').value.trim().toLowerCase();
    const isCorrect = (val === currentQ.a.toLowerCase() || (currentQ.a === "(ÂâäÈô§)" && val === ""));
    
    if(isCorrect) {
        mHp = 0;
        document.getElementById('monster-sprite').classList.add('shake');
        confetti({particleCount:50});
        showExp("‚ú® GREAT HIT!", currentQ.e);
    } else {
        attempts++;
        if(attempts < 2) {
            document.getElementById('msg-box').innerText = "MISS! „ÅÇ„Å®1Âõû„ÉÅ„É£„É≥„Çπ„Åå„ÅÇ„Çã„ÅûÔºÅ";
            document.getElementById('type-input').value = "";
            document.getElementById('type-input').focus();
        } else {
            pHp -= 15;
            showExp("üíÄ FAILED...", `2Âõû„Éü„Çπ„Åó„Åæ„Åó„Åü„ÄÇÊ≠£Ëß£„ÅØ„Äå${currentQ.a}„Äç„Åß„Åô„ÄÇ<br>${currentQ.e}`);
        }
    }
    updateUI();
}

function showExp(res, text) {
    document.getElementById('exp-res').innerText = res;
    document.getElementById('exp-text').innerHTML = text;
    document.getElementById('exp-layer').style.display = 'block';
}

function closeExp() {
    document.getElementById('exp-layer').style.display = 'none';
    document.getElementById('monster-sprite').classList.remove('shake');
    if(pHp <= 0) { 
        alert("ÂãáËÄÖ„ÅØÂäõÂ∞Ω„Åç„Åü..."); 
        location.reload(); 
    } else { 
        qIdx++; 
        loadQuest(); 
    }
}

function updateUI() {
    document.getElementById('p-hp').innerText = Math.max(0, pHp);
    document.getElementById('m-hp-fill').style.width = mHp + "%";
    document.getElementById('q-progress').innerText = `${qIdx + 1}/${playlist.length}`;
}
</script>
</body>
</html>
