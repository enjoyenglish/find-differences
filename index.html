<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grammar Mastery RPG</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root { --rpg-bg: #0a0a0a; --rpg-border: #fff; --rpg-red: #ff4757; --rpg-blue: #3498db; --rpg-gold: #eccc68; }
        body { background: var(--rpg-bg); color: #fff; font-family: 'Courier New', monospace; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 10px; }
        
        /* é¸æŠç”»é¢ */
        #setup-screen { width: 100%; max-width: 600px; background: #222; border: 4px solid var(--rpg-border); padding: 20px; border-radius: 10px; box-sizing: border-box; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin: 20px 0; }
        .opt { background: #333; padding: 10px; border: 2px solid #555; cursor: pointer; text-align: center; font-size: 0.9rem; }
        .opt.selected { background: var(--rpg-blue); border-color: #fff; }

        /* ãƒãƒˆãƒ«UI */
        #game-screen { display: none; width: 100%; max-width: 500px; }
        #ui-layer { border: 3px solid #fff; padding: 10px; display: flex; justify-content: space-around; background: #000; margin-bottom: 5px; }
        #stage { height: 180px; border: 3px solid #fff; background: #1a1a2e; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        #monster-sprite { font-size: 60px; }
        .hp-bar { width: 150px; height: 10px; background: #333; border: 1px solid #fff; }
        #m-hp-fill { height: 100%; background: var(--rpg-red); width: 100%; transition: 0.3s; }

        /* å•é¡Œã‚¨ãƒªã‚¢ */
        #msg-box { min-height: 50px; border: 3px solid #fff; padding: 10px; background: #000; margin: 10px 0; text-align: center; }
        .sentence-box { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin: 15px 0; }
        .word-unit { padding: 8px 12px; border: 1px solid #777; background: #333; cursor: pointer; }
        .word-unit.selected { background: var(--rpg-red); }

        #input-zone { display: none; text-align: center; }
        #type-input { background: #000; color: #fff; border: 2px solid #fff; padding: 10px; width: 80%; text-align: center; }
        .btn { margin-top: 10px; padding: 10px 30px; background: #fff; color: #000; border: none; font-weight: bold; cursor: pointer; }

        /* è§£èª¬ */
        #exp-layer { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 400px; background: #000; border: 4px solid var(--rpg-blue); padding: 20px; z-index: 100; }
        
        .damage { animation: shake 0.3s; }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-10px)} 75%{transform:translateX(10px)} }
    </style>
</head>
<body>

<div id="setup-screen">
    <h2 style="text-align:center; color:var(--rpg-gold);">æŒ‘æˆ¦ã™ã‚‹æ–‡æ³•ã‚’é¸ã¹ï¼</h2>
    <div class="grid" id="grammar-grid"></div>
    <button class="btn" style="width:100%;" onclick="initGame()">ã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹ï¼</button>
</div>

<div id="game-screen">
    <div id="ui-layer">
        <div>LV:<span id="p-lv">1</span></div>
        <div>HP: <span id="p-hp">50</span> / 50</div>
    </div>
    <div id="stage">
        <div id="monster-sprite">ğŸ‰</div>
        <div class="hp-bar"><div id="m-hp-fill"></div></div>
    </div>
    <div id="msg-box">é–“é•ã„ã®å˜èªã‚’æ”»æ’ƒã›ã‚ˆï¼</div>
    <div id="ja-text" style="color:var(--rpg-gold); text-align:center; margin-bottom:5px;"></div>
    <div id="sentence-area" class="sentence-box"></div>
    <div id="input-zone">
        <input type="text" id="type-input" autocomplete="off" placeholder="æ­£ã—ã„ã‚¹ãƒšãƒ«...">
        <br>
        <button class="btn" onclick="submitAttack()">ATTACK!</button>
    </div>
</div>

<div id="exp-layer">
    <div id="exp-res" style="font-weight:bold; margin-bottom:10px;"></div>
    <p id="exp-text"></p>
    <button class="btn" onclick="closeExp()">æ¬¡ã¸ â–¶</button>
</div>

<script>
const db = {
    be: { name: "beå‹•è©(ä¸­1)", q: [
        {ja:"ç§ã¯å­¦ç”Ÿã§ã™ã€‚", s:["i", "is", "a", "student", "."], t:"is", a:"am", e:"Iã®æ™‚ã®beå‹•è©ã¯amã§ã™ã€‚"},
        {ja:"å½¼ã‚‰ã¯ç§ã®å‹é”ã§ã™ã€‚", s:["they", "is", "my", "friends", "."], t:"is", a:"are", e:"è¤‡æ•°ã¯areã‚’ä½¿ã„ã¾ã™ã€‚"},
        {ja:"ã‚ãªãŸã¯è¦ªåˆ‡ã§ã™ã­ã€‚", s:["you", "am", "kind", "."], t:"am", a:"are", e:"youã®æ™‚ã¯å¸¸ã«areã§ã™ã€‚"}
    ]},
    present: { name: "ä¸€èˆ¬å‹•è©(ä¸­1)", q: [
        {ja:"å½¼ã¯é‡çƒã‚’ã—ã¾ã™ã€‚", s:["he", "play", "baseball", "."], t:"play", a:"plays", e:"ä¸»èªãŒ3å˜ç¾(he)ãªã‚‰sãŒå¿…è¦ã§ã™ã€‚"},
        {ja:"å½¼å¥³ã¯ãƒªãƒ³ã‚´ãŒå¥½ãã§ã™ã€‚", s:["she", "like", "apples", "."], t:"like", a:"likes", e:"sheã‚‚3å˜ç¾ãªã®ã§likesã«ãªã‚Šã¾ã™ã€‚"},
        {ja:"ç§ã®çˆ¶ã¯é€Ÿãèµ°ã‚Šã¾ã™ã€‚", s:["my", "father", "run", "fast", "."], t:"run", a:"runs", e:"my fatherã¯heã¨åŒã˜æ‰±ã„(3å˜ç¾)ã§ã™ã€‚"}
    ]},
    past: { name: "éå»å½¢(ä¸­1/2)", q: [
        {ja:"ç§ã¯æ˜¨æ—¥ãƒ†ãƒ‹ã‚¹ã‚’ã—ã¾ã—ãŸã€‚", s:["i", "play", "tennis", "yesterday", "."], t:"play", a:"played", e:"yesterdayãŒã‚ã‚‹ã®ã§éå»å½¢playedã€‚"},
        {ja:"å½¼ã¯å…¬åœ’ã¸è¡Œãã¾ã—ãŸã€‚", s:["he", "go", "to", "the", "park", "."], t:"go", a:"went", e:"goã®éå»å½¢ã¯ä¸è¦å‰‡å¤‰åŒ–ã®wentã§ã™ã€‚"},
        {ja:"ç§ãŸã¡ã¯ä¸€ç·’ã«æ­Œã„ã¾ã—ãŸã€‚", s:["we", "sing", "together", "."], t:"sing", a:"sang", e:"singã®éå»å½¢ã¯sangã§ã™ã€‚"}
    ]},
    prog: { name: "é€²è¡Œå½¢(ä¸­1/2)", q: [
        {ja:"å½¼ã¯ä»Šèµ°ã£ã¦ã„ã¾ã™ã€‚", s:["he", "running", "now", "."], t:"running", a:"is running", e:"é€²è¡Œå½¢ã¯ã€beå‹•è© + ingã€‘ãŒå¿…è¦ã§ã™ã€‚"},
        {ja:"ç§ã¯æœ¬ã‚’èª­ã‚“ã§ã„ã¾ã™ã€‚", s:["i", "reading", "a", "book", "."], t:"reading", a:"am reading", e:"beå‹•è©(am)ãŒæŠœã‘ã¦ã„ã¾ã™ã€‚"},
        {ja:"å½¼ã‚‰ã¯æ³³ã„ã§ã„ã¾ã™ã€‚", s:["they", "are", "swim", "now", "."], t:"swim", a:"swimming", e:"é€²è¡Œå½¢ã¯ingå½¢ã€‚swimã¯mã‚’é‡ã­ã¦swimmingã€‚"}
    ]},
    can: { name: "åŠ©å‹•è©can", q: [
        {ja:"å½¼ã¯é€Ÿãæ³³ã’ã¾ã™ã€‚", s:["he", "can", "swims", "fast", "."], t:"swims", a:"swim", e:"åŠ©å‹•è©ã®å¾Œã¯å¿…ãšå‹•è©ã®åŸå½¢ã§ã™ã€‚"},
        {ja:"ç§ã¯ã‚®ã‚¿ãƒ¼ã‚’å¼¾ã‘ã¾ã™ã€‚", s:["i", "can", "playing", "the", "guitar", "."], t:"playing", a:"play", e:"canã®å¾Œã¯åŸå½¢playã«ã—ã¾ã™ã€‚"},
        {ja:"å½¼å¥³ã¯è‹±èªã‚’è©±ã›ã¾ã™ã€‚", s:["she", "cans", "speak", "english", "."], t:"cans", a:"can", e:"åŠ©å‹•è©canã«sã¯ã¤ãã¾ã›ã‚“ã€‚"}
    ]},
    passive: { name: "å—ã‘èº«(ä¸­3)", q: [
        {ja:"ã“ã®æœ¬ã¯å¤ç›®æ¼±çŸ³ã«ã‚ˆã£ã¦æ›¸ã‹ã‚ŒãŸã€‚", s:["this", "book", "was", "wrote", "by", "soseki", "."], t:"wrote", a:"written", e:"å—ã‘èº«ã¯ã€beå‹•è©+éå»åˆ†è©ã€‘ã€‚write-wrote-writtenã€‚"},
        {ja:"è‹±èªã¯ä¸–ç•Œä¸­ã§è©±ã•ã‚Œã¦ã„ã‚‹ã€‚", s:["english", "is", "speak", "all", "over", "the", "world", "."], t:"speak", a:"spoken", e:"speakã®éå»åˆ†è©ã¯spokenã§ã™ã€‚"},
        {ja:"ãã®çª“ã¯å£Šã•ã‚ŒãŸã€‚", s:["the", "window", "was", "break", "."], t:"break", a:"broken", e:"breakã®éå»åˆ†è©ã¯brokenã§ã™ã€‚"}
    ]},
    perfect: { name: "ç¾åœ¨å®Œäº†(ä¸­3)", q: [
        {ja:"ç§ã¯3å¹´é–“ãšã£ã¨ã“ã“ã«ä½ã‚“ã§ã„ã¾ã™ã€‚", s:["i", "have", "live", "here", "for", "three", "years", "."], t:"live", a:"lived", e:"å®Œäº†å½¢ã¯ã€have+éå»åˆ†è©ã€‘ã§ã™ã€‚"},
        {ja:"å½¼ã¯ã‚‚ã†å®¿é¡Œã‚’çµ‚ãˆãŸã€‚", s:["he", "have", "already", "finished", "his", "homework", "."], t:"have", a:"has", e:"ä¸»èªãŒheãªã®ã§hasã‚’ä½¿ã„ã¾ã™ã€‚"},
        {ja:"ç§ã¯ä¸€åº¦ã‚‚äº¬éƒ½ã«è¡Œã£ãŸã“ã¨ãŒãªã„ã€‚", s:["i", "have", "never", "go", "to", "kyoto", "."], t:"go", a:"been", e:"ã€Œè¡Œã£ãŸã“ã¨ãŒã‚ã‚‹(çµŒé¨“)ã€ã¯been toã‚’ä½¿ã„ã¾ã™ã€‚"}
    ]},
    inf: { name: "ä¸å®šè©(ä¸­2)", q: [
        {ja:"ç§ã¯ãƒ†ãƒ‹ã‚¹ã‚’ã—ãŸã„ã€‚", s:["i", "want", "play", "tennis", "."], t:"play", a:"to play", e:"ã€Œï½ã—ãŸã„ã€ã¯want to åŸå½¢ã€‚"},
        {ja:"å½¼ã¯æ³³ãã«è¡Œãã¾ã—ãŸã€‚", s:["he", "went", "for", "swim", "."], t:"for", a:"to", e:"ç›®çš„ã‚’è¡¨ã™ä¸å®šè©ã¯toã‚’ä½¿ã„ã¾ã™ã€‚"},
        {ja:"ç§ã¯å‹‰å¼·ã™ã‚‹ãŸã‚ã«å›³æ›¸é¤¨ã¸è¡Œã£ãŸã€‚", s:["i", "went", "to", "the", "library", "study", "."], t:"study", a:"to study", e:"studyã®å‰ã«toãŒå¿…è¦ã§ã™ã€‚"}
    ]},
    look: { name: "ç¬¬2æ–‡å‹(lookãªã©)", q: [
        {ja:"å½¼ã¯å¹¸ã›ãã†ã«è¦‹ãˆã‚‹ã€‚", s:["he", "looks", "happily", "."], t:"happily", a:"happy", e:"lookã®å¾Œã¯å‰¯è©ã§ã¯ãªãå½¢å®¹è©(happy)ã‚’ç½®ãã¾ã™ã€‚"},
        {ja:"ã“ã®ãƒªãƒ³ã‚´ã¯ç¾å‘³ã—ãã†ãªå‘³ãŒã™ã‚‹ã€‚", s:["this", "apple", "tastes", "well", "."], t:"well", a:"good", e:"tasteã®å¾Œã¯å½¢å®¹è©goodã‚’ä½¿ã„ã¾ã™ã€‚"},
        {ja:"ãã®è©±ã¯é¢ç™½ãã†ã«èã“ãˆã‚‹ã€‚", s:["the", "story", "sounds", "interestingly", "."], t:"interestingly", a:"interesting", e:"sound + å½¢å®¹è©ã®å½¢ã§ã™ã€‚"}
    ]},
    relative: { name: "é–¢ä¿‚ä»£åè©(ä¸­3)", q: [
        {ja:"ã“ã‚Œã¯ç§ãŒæ˜¨æ—¥è²·ã£ãŸæœ¬ã§ã™ã€‚", s:["this", "is", "the", "book", "who", "i", "bought", "yesterday", "."], t:"who", a:"which", e:"ç‰©ãŒå…ˆè¡Œè©ã®ã¨ãã¯whichã¾ãŸã¯thatã€‚"},
        {ja:"ã‚ãã“ã§èµ°ã£ã¦ã„ã‚‹å°‘å¹´ã‚’è¦‹ã¦ã€‚", s:["look", "at", "the", "boy", "which", "is", "running", "."], t:"which", a:"who", e:"äººãŒå…ˆè¡Œè©ã®ã¨ãã¯whoã€‚"},
        {ja:"ç§ã¯è¦ªåˆ‡ãªå¿ƒã‚’æŒã¤å‹é”ãŒã„ã¾ã™ã€‚", s:["i", "have", "a", "friend", "which", "has", "a", "kind", "heart", "."], t:"which", a:"who", e:"friendã¯äººãªã®ã§whoã§ã™ã€‚"}
    ]},
    give: { name: "æˆä¸å‹•è©(ä¸­2)", q: [
        {ja:"å½¼ã¯ç§ã«æœ¬ã‚’ãã‚Œã¾ã—ãŸã€‚", s:["he", "gave", "a", "book", "me", "."], t:"me", a:"to me", e:"gave ç‰© äºº ã®é †ãªã‚‰ã€Œtoã€ãŒå¿…è¦ã§ã™(or gave me a book)ã€‚"},
        {ja:"ç§ã¯å½¼å¥³ã«æ‰‹ç´™ã‚’æ›¸ãã¾ã—ãŸã€‚", s:["i", "wrote", "a", "letter", "she", "."], t:"she", a:"to her", e:"wrote ç‰© äººãªã‚‰toãŒå¿…è¦ã§ã€ç›®çš„æ ¼herã«ã—ã¾ã™ã€‚"},
        {ja:"æ¯ã¯ç§ã«ã‚±ãƒ¼ã‚­ã‚’ä½œã£ã¦ãã‚ŒãŸã€‚", s:["my", "mother", "made", "a", "cake", "to", "me", "."], t:"to", a:"for", e:"makeã¯toã§ã¯ãªãforã‚’ä½¿ã„ã¾ã™ã€‚"}
    ]}
};

let playlist = [], qIdx = 0, mHp = 100, pHp = 50, currentQ = null;

// ã‚°ãƒªãƒƒãƒ‰ç”Ÿæˆ
const grid = document.getElementById('grammar-grid');
Object.keys(db).forEach(k => {
    const d = document.createElement('div');
    d.className = 'opt'; d.innerText = db[k].name;
    d.onclick = () => d.classList.toggle('selected');
    d.dataset.key = k;
    grid.appendChild(d);
});

function initGame() {
    const sel = document.querySelectorAll('.opt.selected');
    if(!sel.length) return alert("æ–‡æ³•ã‚’é¸ã‚“ã§ï¼");
    
    playlist = [];
    sel.forEach(o => {
        const items = [...db[o.dataset.key].q].sort(()=>Math.random()-0.5);
        playlist.push(...items);
    });
    playlist.sort(()=>Math.random()-0.5);
    
    document.getElementById('setup-screen').style.display = 'none';
    document.getElementById('game-screen').style.display = 'block';
    loadQuest();
}

function loadQuest() {
    if(qIdx >= playlist.length) { alert("å…¨ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼è¨ä¼å®Œäº†ï¼"); location.reload(); return; }
    currentQ = playlist[qIdx];
    document.getElementById('ja-text').innerText = "å’Œè¨³ï¼š" + currentQ.ja;
    document.getElementById('input-zone').style.display = 'none';
    document.getElementById('type-input').value = "";
    document.getElementById('msg-box').innerText = "é–“é•ã„ã‚’ã‚¿ãƒƒãƒã—ã¦æ”»æ’ƒï¼";
    
    const area = document.getElementById('sentence-area');
    area.innerHTML = "";
    currentQ.s.forEach(w => {
        const d = document.createElement('div');
        d.className = 'word-unit'; d.innerText = w;
        d.onclick = () => {
            if(w === currentQ.t) {
                d.classList.add('selected');
                document.getElementById('input-zone').style.display = 'block';
                document.getElementById('type-input').focus();
            } else {
                pHp -= 5; updateUI();
                document.getElementById('msg-box').innerText = "ãã“ã§ã¯ãªã„ï¼åæ’ƒï¼";
            }
        };
        area.appendChild(d);
    });
}

function submitAttack() {
    const val = document.getElementById('type-input').value.trim().toLowerCase();
    if(val === currentQ.a.toLowerCase()) {
        mHp -= 34; document.getElementById('monster-sprite').classList.add('damage');
        confetti({particleCount:50});
        showExp("âœ¨ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ï¼", currentQ.e);
    } else {
        pHp -= 15; showExp("ğŸ’€ æ”»æ’ƒå¤±æ•—...", `æ­£è§£ã¯ã€Œ${currentQ.a}ã€ã§ã—ãŸã€‚<br>${currentQ.e}`);
    }
    updateUI();
}

function showExp(res, text) {
    document.getElementById('exp-res').innerText = res;
    document.getElementById('exp-text').innerHTML = text;
    document.getElementById('exp-layer').style.display = 'block';
}

function closeExp() {
    document.getElementById('exp-layer').style.display = 'none';
    document.getElementById('monster-sprite').classList.remove('damage');
    if(pHp <= 0) { alert("ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼"); location.reload(); }
    else if(mHp <= 0) { mHp = 100; qIdx++; loadQuest(); }
    else { qIdx++; loadQuest(); }
    updateUI();
}

function updateUI() {
    document.getElementById('p-hp').innerText = Math.max(0, pHp);
    document.getElementById('m-hp-fill').style.width = Math.max(0, mHp) + "%";
}
</script>
</body>
</html>
