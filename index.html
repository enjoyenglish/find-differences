<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRAMMAR QUEST: RPG EDITION</title>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --gold: #eccc68; --rpg-red: #ff4757; --rpg-blue: #2f3542;
            --hp-green: #2ecc71; --hp-red: #e74c3c; --wood: #5d4037;
            --window-bg: #000080; /* æ˜”ã®RPGé¢¨ã®é’ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ */
        }
        body {
            background: #111;
            color: #fff;
            /* æ—¥æœ¬èªã¯ãƒ‰ãƒƒãƒˆãƒ•ã‚©ãƒ³ãƒˆã€è‹±æ•°å­—ã¯ãƒ¬ãƒˆãƒ­ã‚²ãƒ¼ãƒ é¢¨ */
            font-family: 'DotGothic16', sans-serif;
            display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0;
        }
        #setup-screen, #game-screen {
            width: 95%; max-width: 850px; 
            background: var(--window-bg); 
            border: 6px double var(--gold);
            padding: 30px; border-radius: 4px; box-shadow: 0 0 0 4px #000, 0 0 20px #000;
            text-align: center; box-sizing: border-box;
        }
        h1 { font-family: 'Press Start 2P', cursive; color: var(--gold); font-size: 1.5rem; text-shadow: 4px 4px #000; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin: 20px 0; }
        .opt { background: #000; color: #fff; padding: 12px 5px; border: 3px solid #fff; cursor: pointer; font-weight: bold; transition: 0.1s; }
        .opt.selected { background: var(--gold); color: #000; border-color: #fff; }
        
        .quest-settings { border: 2px solid #fff; padding: 15px; margin-bottom: 20px; background: rgba(0,0,0,0.5); }
        #num-select { background: #000; color: #fff; border: 2px solid #fff; padding: 5px; font-family: 'DotGothic16'; }

        #battle-view { background: #000; border: 4px solid var(--gold); padding: 20px; margin-bottom: 20px; position: relative; }
        #monster-sprite { font-size: 100px; display: inline-block; filter: drop-shadow(0 0 10px red); }
        .shake { animation: shake 0.4s; }
        @keyframes shake { 0%, 100% {transform:translateX(0)} 20%, 60% {transform:translateX(15px)} 40%, 80% {transform:translateX(-15px)} }

        .hp-container { width: 80%; background: #333; border: 3px solid #fff; height: 20px; margin: 15px auto; overflow: hidden; }
        #hp-fill { height: 100%; width: 100%; background: var(--hp-green); transition: width 0.5s ease; }

        .card-container { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; padding: 15px; background: rgba(255,255,255,0.1); border: 2px solid #fff; min-height: 80px; margin-bottom: 15px; }
        .word-card, .word-unit { padding: 10px 15px; background: #fff; color: #000; border: 2px solid #000; cursor: pointer; font-weight: bold; font-family: 'Georgia', serif; font-size: 1.2rem; }
        .word-card.used { opacity: 0; pointer-events: none; }
        .answer-word { background: var(--gold) !important; }
        .word-unit.selected { background: var(--rpg-red); color: #fff; }

        #type-input { background: #000; color: var(--gold); border: 3px solid #fff; padding: 10px; width: 80%; text-align: center; font-size: 1.5rem; margin-bottom: 10px; font-family: 'Georgia', serif; }
        
        .btn-main { width: 100%; padding: 15px; background: #000; color: #fff; border: 4px solid #fff; font-size: 1.5rem; font-family: 'DotGothic16'; cursor: pointer; }
        .btn-main:hover { background: #fff; color: #000; }
        .btn-main:active { transform: scale(0.98); }

        #exp-layer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        #exp-window { width: 80%; max-width: 600px; background: var(--window-bg); border: 4px double #fff; padding: 30px; }
    </style>
</head>
<body>

<div id="setup-screen">
    <h1>GRAMMAR QUEST</h1>
    <p>ã‚³ãƒãƒ³ãƒ‰ï¼šä¿®å¾—ã—ãŸã„é­”æ³•ï¼ˆæ–‡æ³•ï¼‰ã‚’é¸æŠã›ã‚ˆ</p>
    <div class="grid" id="grammar-grid"></div>
    <div class="quest-settings">
        å†’é™ºã®é•·ã•ï¼š
        <select id="num-select">
            <option value="5">5å• (ã‚·ãƒ§ãƒ¼ãƒˆ)</option>
            <option value="10">10å• (ãƒãƒ¼ãƒãƒ«)</option>
            <option value="20">20å• (ãƒ­ãƒ³ã‚°)</option>
            <option value="999">å…¨å• (ä¼èª¬)</option>
        </select>
    </div>
    <button class="btn-main" onclick="initGame()">å†’é™ºã‚’é–‹å§‹ã™ã‚‹</button>
</div>

<div id="game-screen" style="display:none;">
    <div id="battle-view">
        <div id="monster-sprite">ğŸ‰</div>
        <div class="hp-container"><div id="hp-fill"></div></div>
        <div style="color:var(--gold);">BATTLE: <span id="current-count">1</span> / <span id="total-count">?</span></div>
    </div>
    <div id="ja-text" style="font-size:1.4rem; margin-bottom:15px; text-shadow: 2px 2px #000;"></div>
    
    <div id="sort-ui" style="display:none;">
        <div id="answer-area" class="card-container"></div>
        <div id="card-pool" class="card-container"></div>
    </div>

    <div id="fix-ui" style="display:none;">
        <div id="sentence-area" class="card-container"></div>
        <input type="text" id="type-input" autocomplete="off" placeholder="...">
    </div>

    <button class="btn-main" style="border-color: var(--rpg-red); color: var(--rpg-red);" onclick="submitAttack()">â–¶ ATTACK!</button>
    <div style="margin-top:15px; font-size:0.9rem; color:#aaa; cursor:pointer;" onclick="resetCurrent()">[ ã‚¿ãƒ¼ãƒ³ã‚’ã‚„ã‚Šç›´ã™ ]</div>
</div>

<div id="exp-layer">
    <div id="exp-window">
        <h1 id="exp-res"></h1>
        <p id="exp-text" style="font-size:1.2rem; line-height:1.6;"></p>
        <div id="correct-reveal" style="color:var(--hp-red); font-weight:bold; margin:10px 0; font-family:serif;"></div>
        <button class="btn-main" onclick="closeExp()">ã¤ãã¸ â–¶</button>
    </div>
</div>

<script>
// æ–‡æ³•ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ (å¤‰æ›´ãªã—ã€å…¨18é …ç›®)
const db = {
    passive: { name: "å—ã‘èº«", mode: "fix", q: [
        {ja:"ã“ã®æ‰‹ç´™ã¯å½¼ã«æ›¸ã‹ã‚ŒãŸã€‚", s:["This", "letter", "was", "wrote", "by", "him", "."], t:"wrote", a:"written", e:"beå‹•è©ï¼‹éå»åˆ†è©ã€‚write-wrote-writtenï¼"},
        {ja:"ãã®çª“ã¯å¥ã«ã‚ˆã£ã¦å£Šã•ã‚ŒãŸã€‚", s:["The", "window", "is", "break", "by", "Ken", "."], t:"break", a:"broken", e:"å—å‹•æ…‹ã®éå»åˆ†è©å½¢ã«æ³¨æ„ã€‚"},
        {ja:"ã“ã®æœ¬ã¯å¤šãã®äººã«èª­ã¾ã‚Œã¦ã„ã‚‹ã€‚", s:["This", "book", "is", "readed", "by", "many", "people", "."], t:"readed", a:"read", e:"readã®éå»åˆ†è©ã¯ä¸è¦å‰‡å¤‰åŒ–ã§ã™ã€‚"}
    ]},
    rel: { name: "é–¢ä¿‚ä»£åè©", mode: "sort", q: [
        {ja:"ã“ã‚Œã¯ç§ãŒæ˜¨æ—¥è²·ã£ãŸæœ¬ã§ã™ã€‚", a:["This", "is", "the", "book", "which", "I", "bought", "yesterday", "."], e:"ç‰©ã®èª¬æ˜ã¯whichã‚’ä½¿ã„ã¾ã™ã€‚"},
        {ja:"å‘ã“ã†ã«ã„ã‚‹ç”·æ€§ã¯ç§ã®çˆ¶ã§ã™ã€‚", a:["The", "man", "who", "is", "over", "there", "is", "my", "father", "."], e:"äººã®èª¬æ˜ã¯whoã‚’ä½¿ã„ã¾ã™ã€‚"},
        {ja:"ç§ã¯è‹±èªã‚’è©±ã™å‹é”ãŒã»ã—ã„ã€‚", a:["I", "want", "a", "friend", "who", "speaks", "English", "."], e:"ä¸»æ ¼ã®whoã¯ç›´å¾Œã«å‹•è©ãŒãã¾ã™ã€‚"}
    ]},
    indirect: { name: "é–“æ¥ç–‘å•æ–‡", mode: "sort", q: [
        {ja:"å½¼ãŒã©ã“ã«ä½ã‚“ã§ã„ã‚‹ã‹çŸ¥ã£ã¦ã‚‹ï¼Ÿ", a:["Do", "you", "know", "where", "he", "lives", "?"], e:"ç–‘å•è©ï¼‹ä¸»èªï¼‹å‹•è©ã®é †ã§ã™ã€‚"},
        {ja:"ä½•æ™‚ã‹æ•™ãˆã¦ãã‚Œã¾ã™ã‹ï¼Ÿ", a:["Can", "you", "tell", "me", "what", "time", "it", "is", "?"], e:"ç–‘å•æ–‡ã®èªé †ã«ã¯ãªã‚Šã¾ã›ã‚“ã€‚"},
        {ja:"å½¼å¥³ãŒèª°ã ã‹åˆ†ã‹ã‚‰ãªã„ã€‚", a:["I", "don't", "know", "who", "she", "is", "."], e:"èªé †ã‚’è‚¯å®šæ–‡ã¨åŒã˜ã«ã—ã¾ã™ã€‚"}
    ]},
    perfect: { name: "å®Œäº†å½¢", mode: "fix", q: [
        {ja:"3å¹´é–“ã“ã“ã«ä½ã‚“ã§ã„ã¾ã™ã€‚", s:["I", "have", "live", "here", "for", "3", "years", "."], t:"live", a:"lived", e:"have + éå»åˆ†è©ã§ç¶™ç¶šã‚’è¡¨ã—ã¾ã™ã€‚"},
        {ja:"ã‚‚ã†å®¿é¡Œã‚’çµ‚ãˆã¾ã—ãŸã€‚", s:["I", "have", "already", "finish", "my", "homework", "."], t:"finish", a:"finished", e:"å®Œäº†ã—ãŸã“ã¨ã‚’è¡¨ã—ã¾ã™ã€‚"},
        {ja:"ä¸€åº¦ã‚‚è¡Œã£ãŸã“ã¨ãŒãªã„ã€‚", s:["I", "have", "never", "be", "to", "Kyoto", "."], t:"be", a:"been", e:"çµŒé¨“ã® have been to ã§ã™ã€‚"}
    ]},
    post: { name: "å¾Œç½®ä¿®é£¾", mode: "fix", q: [
        {ja:"ã‚ãã“ã§æ­Œã†å°‘å¥³ã¯èŠ±å­ã ã€‚", s:["The", "girl", "sing", "over", "there", "is", "Hanako", "."], t:"sing", a:"singing", e:"ï½ã—ã¦ã„ã‚‹å°‘å¥³ã€ã¯ingã§ä¿®é£¾ã€‚"},
        {ja:"ã‚«ãƒŠãƒ€ã§ä½¿ã‚ã‚Œã‚‹è¨€èªã¯è‹±èªã ã€‚", s:["The", "language", "use", "in", "Canada", "is", "English", "."], t:"use", a:"used", e:"ä½¿ã‚ã‚Œã‚‹ï¼ˆå—èº«ï¼‰ãªã‚‰éå»åˆ†è©ã€‚"},
        {ja:"èµ°ã£ã¦ã„ã‚‹çŠ¬ã‚’è¦‹ã¦ã€‚", s:["Look", "at", "the", "dog", "run", "."], t:"run", a:"running", e:"åè©ã®å¾Œã«ingã‚’ç½®ãã¾ã™ã€‚"}
    ]},
    itfor: { name: "å½¢å¼ä¸»èªIt", mode: "sort", q: [
        {ja:"è‹±èªã‚’è©±ã™ã®ã¯é›£ã—ã„ã€‚", a:["It", "is", "difficult", "to", "speak", "English", "."], e:"It is ã€œ to ... ã®æ§‹æ–‡ã€‚"},
        {ja:"ç§ã«ã¯æ—©èµ·ããŒç°¡å˜ã ã€‚", a:["It", "is", "easy", "for", "me", "to", "get", "up", "early", "."], e:"for äººã‚’å…¥ã‚Œã‚‹å ´æ‰€ã«æ³¨æ„ã€‚"},
        {ja:"å½¼å¥³ã«ã¯æ³³ãã®ãŒæ¥½ã—ã„ã€‚", a:["It", "is", "fun", "for", "her", "to", "swim", "."], e:"It is ... for äºº to ã€œ ã®é †ã€‚"}
    ]},
    prog: { name: "é€²è¡Œå½¢", mode: "fix", q: [
        {ja:"å½¼ã¯ä»Šèµ°ã£ã¦ã„ã‚‹ã€‚", s:["He", "running", "now", "."], t:"running", a:"is running", e:"beå‹•è©ãŒæŠœã‘ã¦ã„ã¾ã™ã€‚"},
        {ja:"ãƒ†ãƒ‹ã‚¹ã‚’ã—ã¦ã„ãŸã€‚", s:["We", "playing", "tennis", "then", "."], t:"playing", a:"were playing", e:"éå»é€²è¡Œå½¢ã‚‚beå‹•è©ãŒå¿…è¦ã€‚"},
        {ja:"å½¼å¥³ã¯æ–™ç†ä¸­ã ã€‚", s:["She", "cooking", "now", "."], t:"cooking", a:"is cooking", e:"beå‹•è©+ingã§ã™ã€‚"}
    ]},
    ing_only: { name: "å‹•åè©(ing)", mode: "fix", q: [
        {ja:"ãƒ†ãƒ¬ãƒ“ã‚’è¦‹ã‚‹ã®ã‚’ã‚„ã‚ãŸã€‚", s:["He", "stopped", "to", "watch", "TV", "."], t:"to", a:"(å‰Šé™¤)", e:"stopã®å¾Œã¯ingã€‚"},
        {ja:"ãƒ†ãƒ‹ã‚¹ã‚’æ¥½ã—ã¿ã¾ã—ãŸã€‚", s:["I", "enjoyed", "to", "play", "tennis", "."], t:"to", a:"(å‰Šé™¤)", e:"enjoyã®å¾Œã¯ingã®ã¿ã€‚"},
        {ja:"èª­æ›¸ã‚’çµ‚ãˆãŸã€‚", s:["She", "finished", "to", "read", "."], t:"to", a:"(å‰Šé™¤)", e:"finishã‚‚ingã®ã¿ã€‚"}
    ]},
    to_only: { name: "ä¸å®šè©(to)", mode: "fix", q: [
        {ja:"åŒ»è€…ã«ãªã‚ŠãŸã„ã€‚", s:["I", "want", "becoming", "a", "doctor", "."], t:"becoming", a:"to be", e:"wantã¯toä¸å®šè©ã€‚"},
        {ja:"å½¼ã¯æ³³ãã“ã¨ãŒå¥½ãã ã€‚", s:["He", "likes", "swim", "."], t:"swim", a:"to swim", e:"å‹•è©ã‚’ä¸¦ã¹ã‚‹ã«ã¯toã€‚"},
        {ja:"è¡Œãã“ã¨ã‚’æ±ºã‚ãŸã€‚", s:["I", "decided", "going", "."], t:"going", a:"to go", e:"decideã¯toä¸å®šè©ã€‚"}
    ]},
    comp: { name: "æ¯”è¼ƒ", mode: "fix", q: [
        {ja:"å½¼ã‚ˆã‚ŠèƒŒãŒé«˜ã„ã€‚", s:["He", "is", "taller", "as", "me", "."], t:"as", a:"than", e:"æ¯”è¼ƒç´šã®å¾Œã¯thanã€‚"},
        {ja:"ã‚ã‚Œã‚ˆã‚Šé¢ç™½ã„ã€‚", s:["This", "is", "interesting", "than", "that", "."], t:"interesting", a:"more interesting", e:"é•·ã„å˜èªã¯moreã€‚"},
        {ja:"ä¸€ç•ªèƒŒãŒé«˜ã„ã€‚", s:["He", "is", "tallest", "in", "class", "."], t:"tallest", a:"the tallest", e:"æœ€ä¸Šç´šã¯theã€‚"}
    ]},
    modal: { name: "åŠ©å‹•è©", mode: "fix", q: [
        {ja:"è‹±èªã‚’è©±ã›ã‚‹ã€‚", s:["He", "can", "speaks", "English", "."], t:"speaks", a:"speak", e:"åŠ©å‹•è©ã®å¾Œã¯åŸå½¢ã€‚"},
        {ja:"æ¥ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚", s:["You", "must", "to", "come", "."], t:"to", a:"(å‰Šé™¤)", e:"mustã«toã¯ä¸è¦ã€‚"},
        {ja:"æ³³ã’ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚", s:["He", "may", "swims", "well", "."], t:"swims", a:"swim", e:"mayã®å¾Œã‚‚åŸå½¢ã€‚"}
    ]},
    sub: { name: "ä»®å®šæ³•", mode: "fix", q: [
        {ja:"ã‚‚ã—é³¥ãªã‚‰é£›ã¹ã‚‹ã®ã«ã€‚", s:["If", "I", "am", "a", "bird", ",", "I", "could", "fly", "."], t:"am", a:"were", e:"Ifç¯€ã¯wereã€‚"},
        {ja:"æ™‚é–“ãŒã‚ã‚Œã°è¡Œãã®ã«ã€‚", s:["If", "I", "have", "time", ",", "I", "would", "go", "."], t:"have", a:"had", e:"ä»®å®šæ³•ã¯éå»å½¢ã€‚"},
        {ja:"è²·ãˆã‚‹ã®ã«ã€‚", s:["If", "I", "had", "it", ",", "I", "can", "buy", "."], t:"can", a:"could", e:"åŠ©å‹•è©ã‚‚éå»å½¢ã€‚"}
    ]},
    svoc: { name: "ä½¿å½¹make", mode: "fix", q: [
        {ja:"æƒé™¤ã•ã›ãŸã€‚", s:["Made", "me", "to", "clean", "the", "room", "."], t:"to", a:"(å‰Šé™¤)", e:"make A åŸå½¢ã€‚"},
        {ja:"å½¼ã‚’å¹¸ã›ã«ã—ãŸã€‚", s:["I", "made", "him", "happily", "."], t:"happily", a:"happy", e:"make A B(å½¢å®¹è©)ã€‚"},
        {ja:"è¡Œã‹ã›ãŸã€‚", s:["Father", "made", "me", "to", "go", "."], t:"to", a:"(å‰Šé™¤)", e:"toã¯ä¸è¦ã€‚"}
    ]},
    too_to: { name: "too..to", mode: "fix", q: [
        {ja:"è‹¥ã™ãã¦åƒã‘ãªã„ã€‚", s:["Too", "young", "working", "."], t:"working", a:"to work", e:"too ã€œ to åŸå½¢ã€‚"},
        {ja:"æš‘ã™ãã¦çœ ã‚Œãªã„ã€‚", s:["Too", "hot", "sleeping", "."], t:"sleeping", a:"to sleep", e:"to+åŸå½¢ã€‚"},
        {ja:"é›£ã—ã™ãã¦è§£ã‘ãªã„ã€‚", s:["Too", "difficult", "solving", "."], t:"solving", a:"to solve", e:"ã‚ã¾ã‚Šã«ã€œã§...ãªã„ã€‚"}
    ]},
    tag: { name: "ä»˜åŠ ç–‘å•", mode: "fix", q: [
        {ja:"è¦ªåˆ‡ã§ã™ã‚ˆã­ï¼Ÿ", s:["He", "is", "kind", ",", "isn't", "is", "?"], t:"is", a:"he", e:"æœ€å¾Œã¯ä»£åè©ã€‚"},
        {ja:"ã—ã¾ã™ã‚ˆã­ï¼Ÿ", s:["You", "play", ",", "don't", "you", "are", "?"], t:"are", a:"(å‰Šé™¤)", e:"ä¸€èˆ¬å‹•è©ã¯don'tã€‚"},
        {ja:"å¿™ã—ããªã„ã§ã™ã‚ˆã­ï¼Ÿ", s:["You", "aren't", "busy", ",", "are", "you", "not", "?"], t:"not", a:"(å‰Šé™¤)", e:"å¦å®šå¾Œã¯è‚¯å®šã§ã€‚"}
    ]},
    exclam: { name: "æ„Ÿå˜†æ–‡", mode: "sort", q: [
        {ja:"ãªã‚“ã¦ç¾ã—ã„èŠ±ã ï¼", a:["What", "a", "beautiful", "flower", "this", "is", "!"], e:"What a ã€œ S V !"},
        {ja:"ãªã‚“ã¦é€Ÿã„ã‚“ã ï¼", a:["How", "fast", "he", "runs", "!"], e:"How å½¢å®¹è© S V !"},
        {ja:"ãªã‚“ã¦è¦ªåˆ‡ãªã‚“ã ï¼", a:["What", "a", "kind", "boy", "he", "is", "!"], e:"Whatåè©ã®å½¢ã€‚"}
    ]},
    give: { name: "æˆä¸å‹•è©", mode: "sort", q: [
        {ja:"æœ¬ã‚’ãã‚ŒãŸã€‚", a:["He", "gave", "the", "book", "to", "me", "."], e:"gave ç‰© to äººã€‚"},
        {ja:"æ‰‹ç´™ã‚’æ›¸ã„ãŸã€‚", a:["I", "wrote", "a", "letter", "to", "him", "."], e:"wrote ç‰© to äººã€‚"},
        {ja:"è¦‹ã›ã¦ã€‚", a:["Show", "the", "picture", "to", "me", "."], e:"show ç‰© to äººã€‚"}
    ]},
    inf_d: { name: "ä¸å®šè©/å‹•åè©", mode: "fix", q: [
        {ja:"æ³³ãã®ã¯æ¥½ã—ã„ã€‚", s:["Swim", "is", "fun", "."], t:"Swim", a:"Swimming", e:"ä¸»èªã¯ingã‹toã€‚"},
        {ja:"å­¦ã¶ã“ã¨ã¯å¤§åˆ‡ã ã€‚", s:["Learn", "English", "is", "important", "."], t:"Learn", a:"Learning", e:"å‹•è©ã‚’ä¸»èªã«ã€‚"},
        {ja:"ãƒ†ãƒ‹ã‚¹ã¯é¢ç™½ã„ã€‚", s:["Play", "tennis", "is", "fun", "."], t:"Play", a:"To play", e:"Toä¸å®šè©ã‚‚ä¸»èªã€‚"}
    ]}
};

let playlist = [], qIdx = 0, currentQ = null, userAns = [], monsterHp = 100, missCount = 0;
const monsters = ["ğŸ‘¹", "ğŸ‘º", "ğŸ‰", "ğŸ’€", "ğŸ‘¾", "ğŸº", "ğŸ§›"];

const grid = document.getElementById('grammar-grid');
Object.keys(db).forEach(k => {
    const d = document.createElement('div'); d.className = 'opt'; d.innerText = db[k].name;
    d.onclick = () => d.classList.toggle('selected'); d.dataset.key = k; grid.appendChild(d);
});

function initGame() {
    const sel = document.querySelectorAll('.opt.selected');
    if(!sel.length) return alert("é­”æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼");
    let all = [];
    sel.forEach(o => { 
        const cat = db[o.dataset.key]; 
        cat.q.forEach(q => { q.mode = cat.mode; all.push(JSON.parse(JSON.stringify(q))); });
    });
    all.sort(() => Math.random() - 0.5);
    playlist = all.slice(0, parseInt(document.getElementById('num-select').value));
    document.getElementById('total-count').innerText = playlist.length;
    document.getElementById('setup-screen').style.display = 'none';
    document.getElementById('game-screen').style.display = 'block';
    loadQuest();
}

function loadQuest() {
    if(qIdx >= playlist.length) { alert("ALL CLEAR! ã‚ãªãŸã¯ä¼èª¬ã®é­”å°å¸«ã«ãªã‚Šã¾ã—ãŸï¼"); location.reload(); return; }
    currentQ = playlist[qIdx]; userAns = []; monsterHp = 100; missCount = 0; updateHp();
    document.getElementById('current-count').innerText = qIdx + 1;
    document.getElementById('monster-sprite').innerText = monsters[qIdx % monsters.length];
    document.getElementById('ja-text').innerText = currentQ.ja;
    document.getElementById('fix-ui').style.display = currentQ.mode === "fix" ? "block" : "none";
    document.getElementById('sort-ui').style.display = currentQ.mode === "sort" ? "block" : "none";
    document.getElementById('correct-reveal').innerText = "";
    if(currentQ.mode === "sort") renderSort(); else renderFix();
}

function renderSort() {
    const pool = document.getElementById('card-pool'); pool.innerHTML = "";
    document.getElementById('answer-area').innerHTML = "";
    [...currentQ.a].sort(() => Math.random() - 0.5).forEach(w => {
        const card = document.createElement('div'); card.className = 'word-card'; card.innerText = w;
        card.onclick = () => {
            userAns.push(w); card.classList.add('used');
            const ac = document.createElement('div'); ac.className = 'word-card answer-word'; ac.innerText = w;
            document.getElementById('answer-area').appendChild(ac);
        }; pool.appendChild(card);
    });
}

function renderFix() {
    const area = document.getElementById('sentence-area'); area.innerHTML = "";
    currentQ.s.forEach(w => {
        const d = document.createElement('div'); d.className = 'word-unit'; d.innerText = w;
        d.onclick = () => {
            document.querySelectorAll('.word-unit').forEach(u => u.classList.remove('selected'));
            d.classList.add('selected'); document.getElementById('type-input').focus();
        }; area.appendChild(d);
    });
    document.getElementById('type-input').value = "";
}

function submitAttack() {
    let ok = false;
    const clean = (arr) => arr.map(w => w.replace(/[.?!,]/g, "").toLowerCase()).filter(w => w !== "");

    if(currentQ.mode === "sort") {
        const userClean = clean(userAns).join(" ");
        const collectClean = clean(currentQ.a).join(" ");
        ok = (userClean === collectClean);
    } else {
        const sel = document.querySelector('.word-unit.selected');
        const val = document.getElementById('type-input').value.trim().toLowerCase();
        if(sel && sel.innerText.replace(/[.?!,]/g, "").toLowerCase() === currentQ.t.toLowerCase()) {
            ok = (val === currentQ.a.toLowerCase() || (currentQ.a === "(å‰Šé™¤)" && val === ""));
        }
    }

    if(ok) {
        monsterHp = 0; updateHp();
        document.getElementById('monster-sprite').classList.add('shake');
        confetti({particleCount: 150, origin: {y:0.6}});
        setTimeout(() => {
            document.getElementById('monster-sprite').classList.remove('shake');
            showExp("âœ¨ SUCCESS!", currentQ.e);
        }, 600);
    } else {
        missCount++;
        if(missCount >= 2) {
            // 2å›ãƒŸã‚¹ã§å¼·åˆ¶æ­£è§£
            const correctText = currentQ.mode === "sort" ? currentQ.a.join(" ") : `æ­£è§£: ${currentQ.a}`;
            document.getElementById('correct-reveal').innerText = "ã€æ­£è§£ç™ºè¡¨ã€‘ " + correctText;
            showExp("ğŸ’€ GAME OVER", currentQ.e);
        } else {
            alert("MISS! é­”æ³•ãŒä¸ç™ºã«çµ‚ã‚ã£ãŸï¼\n(ã‚ã¨1å›ãƒŸã‚¹ã™ã‚‹ã¨æ­£è§£ãŒè¡¨ç¤ºã•ã‚Œã¾ã™)");
            resetCurrent();
        }
    }
}

function updateHp() { document.getElementById('hp-fill').style.width = monsterHp + "%"; }
function showExp(res, text) {
    document.getElementById('exp-res').innerText = res;
    document.getElementById('exp-res').style.color = (res.includes("SUCCESS") ? "var(--gold)" : "var(--hp-red)");
    document.getElementById('exp-text').innerHTML = text;
    document.getElementById('exp-layer').style.display = 'flex';
}
function closeExp() {
    document.getElementById('exp-layer').style.display = 'none';
    qIdx++; loadQuest();
}
function resetCurrent() {
    userAns = [];
    if(currentQ.mode === "sort") renderSort(); else renderFix();
}
</script>
</body>
</html>
