<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Grammar Quest: Hybrid</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root { --rpg-bg: #0a0a0a; --rpg-border: #fff; --rpg-red: #ff4757; --rpg-blue: #3498db; --rpg-gold: #eccc68; }
        body { background: var(--rpg-bg); color: #fff; font-family: 'Courier New', monospace; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 10px; }
        
        #setup-screen { width: 100%; max-width: 800px; background: #1a1a1a; border: 4px solid var(--rpg-border); padding: 20px; border-radius: 10px; text-align: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; margin: 20px 0; }
        .opt { background: #333; padding: 12px 5px; border: 2px solid #555; cursor: pointer; border-radius: 5px; font-size: 0.85rem; }
        .opt.selected { background: var(--rpg-blue); border-color: #fff; }

        #game-screen { display: none; width: 100%; max-width: 600px; text-align: center; }
        #stage { height: 120px; border: 3px solid #fff; background: #1a1a2e; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; font-size: 50px; }
        
        #msg-box { min-height: 50px; border: 3px solid #fff; padding: 10px; background: #000; margin: 10px 0; border-left: 8px solid var(--rpg-gold); font-weight: bold; }
        #ja-text { color: var(--rpg-gold); margin-bottom: 15px; font-size: 1.1rem; font-weight: bold; }
        
        /* å…±é€šã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
        .card-container { min-height: 60px; border: 2px dashed #444; padding: 15px; margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; background: rgba(255,255,255,0.05); border-radius: 10px; }
        .word-unit, .word-card { padding: 10px 18px; background: #fff; color: #000; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1.2rem; box-shadow: 0 4px #999; }
        .word-unit.selected { background: var(--rpg-red); color: #fff; box-shadow: none; transform: translateY(2px); }
        .word-card.used { opacity: 0.3; pointer-events: none; }
        .answer-word { background: var(--rpg-blue); color: #fff; box-shadow: 0 4px #0056b3; }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
        #input-zone { display: none; padding: 20px; background: #222; border-radius: 10px; border: 2px solid var(--rpg-gold); }
        #type-input { background: #000; color: #fff; border: 2px solid var(--rpg-gold); padding: 12px; width: 80%; text-align: center; font-size: 1.3rem; margin-bottom: 10px; }

        .btn { padding: 12px 30px; background: var(--rpg-red); color: #fff; border: 2px solid #fff; font-weight: bold; cursor: pointer; font-size: 1.1rem; margin: 5px; border-radius: 5px; }
        #exp-layer { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; background: #000; border: 4px solid var(--rpg-blue); padding: 25px; z-index: 100; box-shadow: 0 0 50px #000; }
    </style>
</head>
<body>

<div id="setup-screen">
    <h1 style="color:var(--rpg-gold);">GRAMMAR QUEST: HYBRID</h1>
    <p>å…¨18é …ç›®å¯¾å¿œã€‚å•é¡Œå½¢å¼ã¯è‡ªå‹•ã§åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ã€‚</p>
    <div class="grid" id="grammar-grid"></div>
    <button class="btn" style="width:100%; background: var(--rpg-blue);" onclick="initGame()">å†’é™ºã‚’é–‹å§‹ã™ã‚‹</button>
</div>

<div id="game-screen">
    <div id="stage">ğŸ‘¾</div>
    <div id="msg-box"></div>
    <div id="ja-text"></div>
    
    <div id="sort-ui" style="display:none;">
        <div id="answer-area" class="card-container"></div>
        <div id="card-pool" class="card-container"></div>
        <button class="btn" style="background:#555" onclick="resetSort()">ã‚„ã‚Šç›´ã—</button>
    </div>

    <div id="fix-ui" style="display:none;">
        <div id="sentence-area" class="card-container"></div>
        <div id="input-zone">
            <input type="text" id="type-input" autocomplete="off">
        </div>
    </div>

    <button class="btn" onclick="submitAttack()">æ”»æ’ƒ(ATTACK!)</button>
</div>

<div id="exp-layer">
    <h2 id="exp-res"></h2>
    <p id="exp-text"></p>
    <button class="btn" style="width:100%; background: var(--rpg-blue);" onclick="closeExp()">æ¬¡ã¸ â–¶</button>
</div>

<script>
const db = {
    indirect: { name: "ã€é–“æ¥ç–‘å•ã€‘", mode: "sort", q: [
        {ja:"å½¼ãŒèª°ãªã®ã‹çŸ¥ã‚Šã¾ã›ã‚“ã€‚", a:["I", "don't", "know", "who", "he", "is", "."], e:"èªé †ã¯ã€ç–‘å•è©ï¼‹Sï¼‹Vã€ã§ã™ã€‚"},
        {ja:"ã©ã“ã«å½¼å¥³ãŒä½ã‚“ã§ã„ã‚‹ã‹æ•™ãˆã¦ã€‚", a:["Please", "tell", "me", "where", "she", "lives", "."], e:"doesã‚’ä½¿ã‚ãšã€livesã«ã—ã¾ã™ã€‚"}
    ]},
    passive: { name: "ã€å—ã‘èº«ã€‘", mode: "fix", q: [
        {ja:"ã“ã®æ‰‹ç´™ã¯å¥ã«ã‚ˆã£ã¦æ›¸ã‹ã‚Œã¾ã—ãŸã€‚", s:["This", "letter", "was", "wrote", "by", "Ken", "."], t:"wrote", a:"written", e:"å—ã‘èº«ã¯ beå‹•è©ï¼‹éå»åˆ†è© ã§ã™ã€‚"}
    ]},
    perfect: { name: "ã€å®Œäº†å½¢ã€‘", mode: "fix", q: [
        {ja:"ç§ã¯3å¹´é–“ãšã£ã¨ãƒ†ãƒ‹ã‚¹ã‚’ã—ã¦ã„ã¾ã™ã€‚", s:["I", "have", "play", "tennis", "for", "three", "years", "."], t:"play", a:"played", e:"ç¾åœ¨å®Œäº†ã¯ haveï¼‹éå»åˆ†è© ã§ã™ã€‚"}
    ]}
    // ä»–ã®15é …ç›®ã‚‚ mode: "fix" ã‹ "sort" ã‚’æŒ‡å®šã—ã¦è¿½åŠ 
};

let playlist = [], qIdx = 0, currentQ = null, userAns = [], attempts = 0, selectedWrongWord = null;

const grid = document.getElementById('grammar-grid');
Object.keys(db).forEach(k => {
    const d = document.createElement('div');
    d.className = 'opt'; d.innerText = db[k].name;
    d.onclick = () => d.classList.toggle('selected');
    d.dataset.key = k;
    grid.appendChild(d);
});

function initGame() {
    const sel = document.querySelectorAll('.opt.selected');
    if(!sel.length) return alert("æ–‡æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼");
    sel.forEach(o => {
        const category = db[o.dataset.key];
        category.q.forEach(q => { q.mode = category.mode; playlist.push(q); });
    });
    playlist.sort(() => Math.random() - 0.5);
    document.getElementById('setup-screen').style.display = 'none';
    document.getElementById('game-screen').style.display = 'block';
    loadQuest();
}

function loadQuest() {
    if(qIdx >= playlist.length) { alert("å…¨å•ã‚¯ãƒªã‚¢ï¼"); location.reload(); return; }
    currentQ = playlist[qIdx];
    attempts = 0;
    userAns = [];
    selectedWrongWord = null;
    document.getElementById('ja-text').innerText = "å’Œè¨³ï¼š" + currentQ.ja;
    document.getElementById('fix-ui').style.display = "none";
    document.getElementById('sort-ui').style.display = "none";
    document.getElementById('input-zone').style.display = "none";

    if(currentQ.mode === "sort") {
        document.getElementById('msg-box').innerText = "ã€ä¸¦ã³æ›¿ãˆã€‘ã‚«ãƒ¼ãƒ‰ã‚’æ­£ã—ã„é †ã«ã‚¿ãƒƒãƒ—ã—ã¦ï¼";
        document.getElementById('sort-ui').style.display = "block";
        renderSort();
    } else {
        document.getElementById('msg-box').innerText = "ã€ã‚¹ãƒšãƒ«ä¿®æ­£ã€‘é–“é•ã„ã®å˜èªã‚’ã‚¿ãƒƒãƒ—ã—ã¦ç›´ã—ã¦ï¼";
        document.getElementById('fix-ui').style.display = "block";
        renderFix();
    }
}

function renderSort() {
    const pool = document.getElementById('card-pool');
    const ans = document.getElementById('answer-area');
    pool.innerHTML = ""; ans.innerHTML = "";
    [...currentQ.a].sort(() => Math.random() - 0.5).forEach(w => {
        const card = document.createElement('div');
        card.className = 'word-card'; card.innerText = w;
        card.onclick = () => {
            userAns.push(w);
            card.classList.add('used');
            const ac = document.createElement('div');
            ac.className = 'word-card answer-word'; ac.innerText = w;
            ans.appendChild(ac);
        };
        pool.appendChild(card);
    });
}

function resetSort() {
    userAns = [];
    document.getElementById('answer-area').innerHTML = "";
    document.querySelectorAll('.word-card').forEach(c => c.classList.remove('used'));
}

function renderFix() {
    const area = document.getElementById('sentence-area');
    area.innerHTML = "";
    currentQ.s.forEach(w => {
        const d = document.createElement('div');
        d.className = 'word-unit'; d.innerText = w;
        d.onclick = () => {
            if(w === currentQ.t) {
                document.querySelectorAll('.word-unit').forEach(u => u.classList.remove('selected'));
                d.classList.add('selected');
                selectedWrongWord = w;
                document.getElementById('input-zone').style.display = 'block';
                document.getElementById('type-input').focus();
                document.getElementById('msg-box').innerText = `ã€Œ${w}ã€ã‚’ã©ã†ç›´ã™ï¼Ÿ`;
            }
        };
        area.appendChild(d);
    });
}

function submitAttack() {
    let isCorrect = false;
    if(currentQ.mode === "sort") {
        isCorrect = JSON.stringify(userAns) === JSON.stringify(currentQ.a);
    } else {
        const val = document.getElementById('type-input').value.trim().toLowerCase();
        isCorrect = (selectedWrongWord === currentQ.t && (val === currentQ.a.toLowerCase() || (currentQ.a === "(å‰Šé™¤)" && val === "")));
    }

    if(isCorrect) {
        confetti({particleCount: 150});
        showExp("âœ¨ GREAT HIT!", currentQ.e);
    } else {
        attempts++;
        if(attempts < 2) {
            document.getElementById('msg-box').innerText = "MISS! ã©ã“ã‹ãŒé•ã†ãã€ã‚‚ã†ä¸€åº¦ï¼";
            if(currentQ.mode === "sort") resetSort();
        } else {
            const collectStr = currentQ.mode === "sort" ? currentQ.a.join(" ") : currentQ.a;
            showExp("ğŸ’€ FAILED...", `æ­£è§£ã¯: ${collectStr}<br>${currentQ.e}`);
        }
    }
}

function showExp(res, text) {
    document.getElementById('exp-res').innerText = res;
    document.getElementById('exp-text').innerHTML = text;
    document.getElementById('exp-layer').style.display = 'block';
}

function closeExp() {
    document.getElementById('exp-layer').style.display = 'none';
    qIdx++; loadQuest();
}
</script>
</body>
</html>
