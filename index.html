<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRAMMAR QUEST: ULTIMATE</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --gold: #eccc68; --rpg-red: #ff4757; --rpg-blue: #2f3542;
            --hp-green: #2ecc71; --hp-red: #e74c3c;
        }
        body {
            background: #000 url('https://www.transparenttextures.com/patterns/dark-matter.png');
            color: #fff; font-family: 'Georgia', serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0;
        }
        /* RPGãƒœãƒ¼ãƒ‰ UI */
        #setup-screen, #game-screen {
            width: 95%; max-width: 850px; background: #f4e4bc; border: 12px solid #8b4513;
            padding: 30px; border-radius: 10px; box-shadow: 0 0 50px #000; text-align: center; color: #3d2b1f; box-sizing: border-box;
        }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin: 20px 0; }
        .opt { background: #5d4037; color: var(--gold); padding: 12px; border: 3px solid #3d2b1f; cursor: pointer; border-radius: 5px; font-weight: bold; font-size: 0.85rem; }
        .opt.selected { background: var(--rpg-blue); color: #fff; border-color: var(--gold); }
        
        /* ãƒãƒˆãƒ«ã‚¨ãƒªã‚¢ */
        #battle-view { background: #1a1a2e; border: 4px solid var(--gold); border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        #monster-sprite { font-size: 80px; transition: 0.2s; display: inline-block; }
        .shake { animation: shake 0.3s; }
        @keyframes shake { 0% {transform:translateX(0)} 25% {transform:translateX(10px)} 50% {transform:translateX(-10px)} 75% {transform:translateX(10px)} 100% {transform:translateX(0)} }
        
        /* HPãƒãƒ¼ */
        .hp-container { width: 80%; background: #444; border: 2px solid var(--gold); height: 20px; margin: 10px auto; border-radius: 10px; overflow: hidden; }
        #hp-fill { height: 100%; width: 100%; background: var(--hp-green); transition: width 0.5s ease; }
        
        /* ã‚«ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ */
        .card-container { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; padding: 15px; background: rgba(0,0,0,0.1); border-radius: 10px; min-height: 60px; }
        .word-card, .word-unit { padding: 10px 15px; background: #fff; color: #000; border-radius: 5px; cursor: pointer; font-weight: bold; box-shadow: 0 4px #999; }
        .word-unit.selected { background: var(--rpg-red); color: #fff; }
        .word-card.used { opacity: 0.2; pointer-events: none; }
        .answer-card { background: #3498db; color: #fff; }

        .btn-action { width: 100%; padding: 15px; background: linear-gradient(#e74c3c, #c0392b); color: #fff; border: 4px solid #fff; border-radius: 8px; font-size: 1.5rem; font-weight: bold; cursor: pointer; margin-top: 15px; }
        #type-input { background: #000; color: var(--gold); border: 2px solid var(--gold); padding: 10px; width: 80%; text-align: center; font-size: 1.2rem; margin: 10px 0; }
        #exp-layer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="setup-screen">
    <h1 style="margin:0;">GRAMMAR QUEST</h1>
    <p>ç¿’å¾—ã—ãŸã„æ–‡æ³•ã‚’é¸æŠã›ã‚ˆï¼ˆè¤‡æ•°å¯ï¼‰</p>
    <div class="grid" id="grammar-grid"></div>
    <button class="btn-action" style="background: #2980b9;" onclick="initGame()">QUEST START!</button>
</div>

<div id="game-screen" style="display:none;">
    <div id="battle-view">
        <div id="monster-sprite">ğŸ‰</div>
        <div class="hp-container"><div id="hp-fill"></div></div>
        <div id="status-info" style="color:var(--gold); font-size: 0.9rem;">Rank: <span id="player-rank">æ–°ç±³å†’é™ºè€…</span></div>
    </div>
    
    <div id="ja-text" style="font-size:1.2rem; font-weight:bold; margin-bottom:10px;"></div>
    
    <div id="sort-ui" style="display:none;">
        <div id="answer-area" class="card-container" style="border: 2px solid var(--rpg-blue); margin-bottom: 10px;"></div>
        <div id="card-pool" class="card-container"></div>
    </div>

    <div id="fix-ui" style="display:none;">
        <div id="sentence-area" class="card-container"></div>
        <input type="text" id="type-input" autocomplete="off" placeholder="æ­£ã—ãç›´ã—ã¦å…¥åŠ›...">
    </div>

    <button class="btn-action" onclick="submitAttack()">ATTACK!</button>
    <button onclick="resetCurrent()" style="margin-top:10px; background:none; border:none; color:#8b4513; cursor:pointer; text-decoration:underline;">ã‚„ã‚Šç›´ã—</button>
</div>

<div id="exp-layer">
    <h1 id="exp-res" style="font-size:3rem;"></h1>
    <p id="exp-text" style="padding: 20px; text-align: center; font-size: 1.2rem;"></p>
    <div id="rank-up-msg" style="color:var(--gold); font-weight:bold; margin-bottom:20px;"></div>
    <button class="btn-action" style="width:200px;" onclick="closeExp()">NEXT â–¶</button>
</div>

<script>
const db = {
    passive: { name: "å—ã‘èº«", mode: "fix", q: [{ja:"ã“ã®æ‰‹ç´™ã¯å¥ã«ã‚ˆã£ã¦æ›¸ã‹ã‚Œã¾ã—ãŸã€‚", s:["This", "letter", "was", "wrote", "by", "Ken", "."], t:"wrote", a:"written", e:"beå‹•è©ï¼‹éå»åˆ†è©ã§ã™ã€‚"}]},
    perfect: { name: "å®Œäº†å½¢", mode: "fix", q: [{ja:"3å¹´é–“ãšã£ã¨ã“ã“ã«ä½ã‚“ã§ã„ã¾ã™ã€‚", s:["I", "have", "live", "here", "for", "3", "years", "."], t:"live", a:"lived", e:"haveï¼‹éå»åˆ†è©ã§ã™ã€‚"}]},
    post: { name: "å¾Œç½®ä¿®é£¾", mode: "fix", q: [{ja:"å‘ã“ã†ã§æ­Œã£ã¦ã„ã‚‹å°‘å¥³ã¯èŠ±å­ã§ã™ã€‚", s:["The", "girl", "sing", "over", "there", "is", "Hanako", "."], t:"sing", a:"singing", e:"singingãŒgirlã‚’ä¿®é£¾ã—ã¦ã„ã¾ã™ã€‚"}]},
    rel: { name: "é–¢ä¿‚ä»£åè©", mode: "sort", q: [{ja:"ã“ã‚Œã¯ç§ãŒæ˜¨æ—¥è²·ã£ãŸæœ¬ã§ã™ã€‚", a:["This", "is", "the", "book", "which", "I", "bought", "yesterday", "."], e:"å…ˆè¡Œè©ãŒç‰©ãªã®ã§whichã‚’ä½¿ã„ã¾ã™ã€‚"}]},
    indirect: { name: "é–“æ¥ç–‘å•æ–‡", mode: "sort", q: [{ja:"å½¼ãŒã©ã“ã«ä½ã‚“ã§ã„ã‚‹ã‹çŸ¥ã£ã¦ã‚‹ï¼Ÿ", a:["Do", "you", "know", "where", "he", "lives", "?"], e:"èªé †ã¯ã€ç–‘å•è©ï¼‹Sï¼‹Vã€ã§ã™ã€‚"}]},
    itfor: { name: "å½¢å¼ä¸»èªIt", mode: "sort", q: [{ja:"è‹±èªã‚’è©±ã™ã®ã¯é›£ã—ã„ã€‚", a:["It", "is", "difficult", "for", "me", "to", "speak", "English", "."], e:"It is ... for äºº to ... ã®å½¢ã§ã™ã€‚"}]},
    prog: { name: "é€²è¡Œå½¢", mode: "fix", q: [{ja:"å½¼ã¯ä»Šèµ°ã£ã¦ã„ã¾ã™ã€‚", s:["He", "running", "now", "."], t:"running", a:"is running", e:"beå‹•è©ã‚’å¿˜ã‚Œãªã„ã§ï¼"}]},
    ing_only: { name: "å‹•åè©(ing)", mode: "fix", q: [{ja:"ãƒ†ãƒ¬ãƒ“ã‚’è¦‹ã‚‹ã®ã‚’ã‚„ã‚ãŸã€‚", s:["He", "stopped", "to", "watch", "TV", "."], t:"to", a:"(å‰Šé™¤)", e:"stopã®å¾Œã¯ingã®ã¿ã€‚"}]},
    to_only: { name: "ä¸å®šè©(to)", mode: "fix", q: [{ja:"åŒ»è€…ã«ãªã‚ŠãŸã„ã€‚", s:["I", "want", "becoming", "a", "doctor", "."], t:"becoming", a:"to be", e:"wantã®å¾Œã¯toä¸å®šè©ã€‚"}]},
    comp: { name: "æ¯”è¼ƒ", mode: "fix", q: [{ja:"å½¼ã‚ˆã‚ŠèƒŒãŒé«˜ã„ã€‚", s:["He", "is", "taller", "as", "me", "."], t:"as", a:"than", e:"æ¯”è¼ƒç´šã®å¾Œã¯thanã§ã™ã€‚"}]},
    modal: { name: "åŠ©å‹•è©", mode: "fix", q: [{ja:"è‹±èªã‚’è©±ã›ã¾ã™ã€‚", s:["He", "can", "speaks", "English", "."], t:"speaks", a:"speak", e:"åŠ©å‹•è©ã®å¾Œã¯åŸå½¢ã§ã™ã€‚"}]},
    sub: { name: "ä»®å®šæ³•", mode: "fix", q: [{ja:"ã‚‚ã—é³¥ãªã‚‰é£›ã¹ã‚‹ã®ã«ã€‚", s:["If", "I", "am", "a", "bird", ",", "I", "could", "fly", "."], t:"am", a:"were", e:"ä»®å®šæ³•ã§ã¯wereã‚’ä½¿ã„ã¾ã™ã€‚"}]},
    svoc: { name: "ä½¿å½¹make", mode: "fix", q: [{ja:"æƒé™¤ã•ã›ãŸã€‚", s:["Made", "me", "to", "clean", "the", "room", "."], t:"to", a:"(å‰Šé™¤)", e:"makeã¯åŸå½¢ä¸å®šè©ã‚’å–ã‚Šã¾ã™ã€‚"}]},
    too_to: { name: "too..to", mode: "fix", q: [{ja:"è‹¥ã™ãã¦åƒã‘ãªã„ã€‚", s:["Too", "young", "working", "."], t:"working", a:"to work", e:"too ã€œ to åŸå½¢ã§ã™ã€‚"}]},
    tag: { name: "ä»˜åŠ ç–‘å•", mode: "fix", q: [{ja:"è¦ªåˆ‡ã§ã™ã‚ˆã­ï¼Ÿ", s:["He", "is", "kind", ",", "isn't", "is", "?"], t:"is", a:"he", e:"æœ€å¾Œã¯ä»£åè©ã‚’ä½¿ã„ã¾ã™ã€‚"}]},
    exclam: { name: "æ„Ÿå˜†æ–‡", mode: "sort", q: [{ja:"ãªã‚“ã¦ç¾ã—ã„èŠ±ã ï¼", a:["What", "a", "beautiful", "flower", "this", "is", "!"], e:"æœ€å¾Œã¯S+Vã®é †ã§ã™ã€‚"}]},
    give: { name: "æˆä¸å‹•è©", mode: "sort", q: [{ja:"æœ¬ã‚’ãã‚ŒãŸã€‚", a:["He", "gave", "the", "book", "to", "me", "."], e:"gave ç‰© to äºº ã®é †ã§ã™ã€‚"}]},
    inf_d: { name: "ä¸å®šè©/å‹•åè©", mode: "fix", q: [{ja:"æ³³ãã®ã¯æ¥½ã—ã„ã€‚", s:["Swim", "is", "fun", "."], t:"Swim", a:"Swimming", e:"ä¸»èªã«ã¯ing/toã‚’ä½¿ã„ã¾ã™ã€‚"}]}
};

const monsters = ["ğŸ‘¹", "ğŸ‘º", "ğŸ‰", "ğŸ’€", "ğŸ‘¾"];
let playlist = [], qIdx = 0, currentQ = null, userAns = [], score = 0, monsterHp = 100;
let rank = "æ–°ç±³å†’é™ºè€…";

const grid = document.getElementById('grammar-grid');
Object.keys(db).forEach(k => {
    const d = document.createElement('div'); d.className = 'opt'; d.innerText = db[k].name;
    d.onclick = () => d.classList.toggle('selected'); d.dataset.key = k; grid.appendChild(d);
});

function initGame() {
    const sel = document.querySelectorAll('.opt.selected');
    if(!sel.length) return alert("æ–‡æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼");
    sel.forEach(o => { const cat = db[o.dataset.key]; cat.q.forEach(q => { q.mode = cat.mode; playlist.push(q); }); });
    playlist.sort(() => Math.random() - 0.5);
    document.getElementById('setup-screen').style.display = 'none';
    document.getElementById('game-screen').style.display = 'block';
    loadQuest();
}

function loadQuest() {
    if(qIdx >= playlist.length) { alert("å®Œå…¨åˆ¶è¦‡ï¼ä¼èª¬ã®å†’é™ºè€…ã¨ãªã‚Šã¾ã—ãŸï¼"); location.reload(); return; }
    currentQ = playlist[qIdx]; userAns = []; monsterHp = 100;
    updateHp();
    document.getElementById('monster-sprite').innerText = monsters[qIdx % monsters.length];
    document.getElementById('ja-text').innerText = currentQ.ja;
    document.getElementById('fix-ui').style.display = currentQ.mode === "fix" ? "block" : "none";
    document.getElementById('sort-ui').style.display = currentQ.mode === "sort" ? "block" : "none";
    
    if(currentQ.mode === "sort") renderSort();
    else renderFix();
}

function renderSort() {
    const pool = document.getElementById('card-pool'); pool.innerHTML = "";
    document.getElementById('answer-area').innerHTML = "";
    [...currentQ.a].sort(() => Math.random() - 0.5).forEach(w => {
        const card = document.createElement('div'); card.className = 'word-card'; card.innerText = w;
        card.onclick = () => {
            userAns.push(w); card.classList.add('used');
            const ac = document.createElement('div'); ac.className = 'word-card answer-card'; ac.innerText = w;
            document.getElementById('answer-area').appendChild(ac);
        }; pool.appendChild(card);
    });
}

function renderFix() {
    const area = document.getElementById('sentence-area'); area.innerHTML = "";
    document.getElementById('type-input').value = "";
    currentQ.s.forEach(w => {
        const d = document.createElement('div'); d.className = 'word-unit'; d.innerText = w;
        d.onclick = () => {
            document.querySelectorAll('.word-unit').forEach(u => u.classList.remove('selected'));
            d.classList.add('selected'); document.getElementById('type-input').focus();
        }; area.appendChild(d);
    });
}

function updateHp() {
    document.getElementById('hp-fill').style.width = monsterHp + "%";
}

function submitAttack() {
    let ok = false;
    if(currentQ.mode === "sort") {
        ok = JSON.stringify(userAns) === JSON.stringify(currentQ.a);
    } else {
        const sel = document.querySelector('.word-unit.selected');
        const val = document.getElementById('type-input').value.trim().toLowerCase();
        if(sel && sel.innerText === currentQ.t) {
            ok = (val === currentQ.a.toLowerCase() || (currentQ.a === "(å‰Šé™¤)" && val === ""));
        }
    }

    if(ok) {
        monsterHp -= 100; updateHp();
        document.getElementById('monster-sprite').classList.add('shake');
        confetti({particleCount: 100, origin: {y:0.6}});
        setTimeout(() => {
            document.getElementById('monster-sprite').classList.remove('shake');
            score++; checkRank();
            showExp("âœ¨ GREAT HIT!", currentQ.e);
        }, 500);
    } else {
        alert("ãƒŸã‚¹ï¼æ•µã®åæ’ƒã ï¼(ã‚„ã‚Šç›´ã—ã¦ã¿ã¦ã­)");
        resetCurrent();
    }
}

function checkRank() {
    const ranks = ["æ–°ç±³å†’é™ºè€…", "è¦‹ç¿’ã„é¨å£«", "æ–‡æ³•ãƒã‚¹ã‚¿ãƒ¼", "å‹‡è€…", "ä¼èª¬ã®è³¢è€…"];
    let nextRank = ranks[Math.min(Math.floor(score/3), 4)];
    if(nextRank !== rank) {
        rank = nextRank;
        document.getElementById('rank-up-msg').innerText = "RANK UP!! â†’ " + rank;
        document.getElementById('player-rank').innerText = rank;
    } else {
        document.getElementById('rank-up-msg').innerText = "";
    }
}

function showExp(res, text) {
    document.getElementById('exp-res').innerText = res;
    document.getElementById('exp-text').innerHTML = text;
    document.getElementById('exp-layer').style.display = 'flex';
}

function closeExp() {
    document.getElementById('exp-layer').style.display = 'none';
    qIdx++; loadQuest();
}

function resetCurrent() {
    if(currentQ.mode === "sort") renderSort();
    else {
        document.getElementById('type-input').value = "";
        document.querySelectorAll('.word-unit').forEach(u => u.classList.remove('selected'));
    }
}
</script>
</body>
</html>
